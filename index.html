<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoReport - GPS Temps R√©el S√©curis√©</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Outfit', sans-serif; }

    :root {
      --bg-color: #0a0e27;
      --surface-color: #151d3b;
      --text-color: #e8edf2;
      --primary-color: #ff6b35;
      --secondary-color: #004e89;
    }

    .app-wrapper {
      height: 100%;
      width: 100%;
      background: var(--bg-color);
      color: var(--text-color);
      overflow: auto;
    }

    .auth-container {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #0a0e27 0%, #1a2847 100%);
    }

    .auth-card {
      background: var(--surface-color);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary-color), #ff8800);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .auth-header p {
      font-size: 13px;
      opacity: 0.6;
    }

    .glow-line {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }

    .card-surface {
      background: var(--surface-color);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
    }

    .stat-card {
      background: var(--surface-color);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--primary-color);
      opacity: 0.7;
    }

    .mode-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0 28px;
    }

    .mode-btn {
      padding: 16px 28px;
      border-radius: 10px;
      border: 2px solid transparent;
      background: var(--surface-color);
      color: var(--text-color);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.25s ease;
      font-family: 'Outfit', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-btn:hover { background: rgba(255,255,255,0.08); }
    .mode-btn.active {
      background: var(--primary-color);
      color: #0a0e27;
      border-color: var(--primary-color);
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
    }

    .nav-btn {
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s ease;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-color);
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      white-space: nowrap;
    }

    .nav-btn:hover { background: rgba(255,255,255,0.05); }
    .nav-btn.active {
      background: var(--primary-color);
      color: #0a0e27;
      font-weight: 600;
    }

    .btn-primary {
      background: var(--primary-color);
      color: #0a0e27;
      font-weight: 600;
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-secondary {
      background: var(--secondary-color);
      color: var(--text-color);
      font-weight: 500;
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-secondary:hover { filter: brightness(1.2); }

    .btn-logout {
      background: #cc3333;
      color: white;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 12px;
      transition: all 0.2s;
    }
    .btn-logout:hover { filter: brightness(1.15); }

    .btn-danger {
      background: #dc3545;
      color: white;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      transition: all 0.2s;
    }
    .btn-danger:hover { filter: brightness(1.15); }

    .btn-alert {
      background: #ff3333;
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 15px;
      transition: all 0.3s;
      box-shadow: 0 0 20px rgba(255, 51, 51, 0.4);
    }
    .btn-alert:hover { 
      filter: brightness(1.2); 
      box-shadow: 0 0 30px rgba(255, 51, 51, 0.6);
      transform: scale(1.05);
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--primary-color); }

    select.form-input { appearance: none; cursor: pointer; }
    textarea.form-input { resize: vertical; min-height: 80px; }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      opacity: 0.8;
      color: var(--text-color);
    }

    .severity-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .severity-low { background: #1a5c3a; color: #6ee7a8; }
    .severity-medium { background: #5c4a1a; color: #f5c842; }
    .severity-high { background: #5c1a1a; color: #f56b6b; }
    .severity-critical { background: #7a1a3a; color: #ff6b9d; animation: pulse 2s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-open { background: #1a3a5c; color: #6bb5f5; }
    .status-progress { background: #5c4a1a; color: #f5c842; }
    .status-resolved { background: #1a5c3a; color: #6ee7a8; }

    .record-row {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      transition: background 0.15s;
    }
    .record-row:hover { background: rgba(255,255,255,0.02); }

    .alert-banner {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border: 2px solid #ff6666;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      animation: alertPulse 2s infinite;
    }

    @keyframes alertPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }
      50% { box-shadow: 0 0 40px rgba(255, 51, 51, 0.6); }
    }

    .geo-box {
      background: linear-gradient(135deg, rgba(50,200,255,0.15) 0%, rgba(0,150,255,0.08) 100%);
      border-left: 4px solid #32c8ff;
      padding: 14px;
      border-radius: 8px;
      margin: 12px 0;
      font-size: 13px;
    }

    .geo-box.success {
      border-left-color: #4ade80;
      background: linear-gradient(135deg, rgba(74,222,128,0.15) 0%, rgba(74,222,128,0.08) 100%);
    }

    .geo-box.error {
      border-left-color: #ff6b6b;
      background: linear-gradient(135deg, rgba(255,107,107,0.15) 0%, rgba(255,107,107,0.08) 100%);
    }

    .user-info-badge {
      display: inline-block;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .toast-msg {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 22px;
      border-radius: 10px;
      font-weight: 500;
      font-size: 14px;
      z-index: 9999;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.35s ease;
    }
    .toast-msg.show { opacity: 1; transform: translateY(0); }
    .toast-success { background: #1a5c3a; color: #6ee7a8; }
    .toast-error { background: #5c1a1a; color: #ff6b6b; }
    .toast-alert { background: #7a1a1a; color: #ff6b6b; animation: shake 0.5s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      opacity: 0.5;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .section-view { display: none; }
    .section-view.active { display: block; }

    .mono { font-family: 'JetBrains Mono', monospace; }

    .mode-header {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
      border-left: 4px solid var(--primary-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .mode-header h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .mode-header p {
      font-size: 12px;
      opacity: 0.7;
    }

    .security-badge {
      display: inline-block;
      background: linear-gradient(135deg, rgba(74,222,128,0.2) 0%, rgba(74,222,128,0.1) 100%);
      border: 1px solid #4ade80;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #4ade80;
    }

    @media (max-width: 768px) {
      .mode-selector { flex-direction: column; }
      .mode-btn { width: 100%; }
      .nav-scroll { overflow-x: auto; }
      .form-grid { grid-template-columns: 1fr !important; }
      .auth-card { padding: 24px; }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div class="app-wrapper" id="appWrapper"><!-- ============ AUTH SCREEN ============ -->
   <div id="authScreen" class="auth-container">
    <div class="auth-card">
     <div class="auth-header">
      <div style="font-size:48px;margin-bottom:16px;">
       üîê
      </div>
      <h1>AutoReport</h1>
      <p>S√©curit√© GPS Temps R√©el</p>
     </div>
     <div id="authForm">
      <form onsubmit="handleLogin(event)">
       <div style="margin-bottom:18px;"><label class="form-label">Type d'utilisateur</label> <select class="form-input" id="authType" onchange="updateAuthForm()" required> <option value="enterprise">üëî Entreprise / S√©curit√©</option> <option value="personal">üè† Particulier / Personnel</option> </select>
       </div>
       <div id="enterpriseFields" style="display:block;">
        <div style="margin-bottom:18px;"><label class="form-label">Nom de l'entreprise</label> <input class="form-input" id="enterpriseName" placeholder="Ex: Mines XXL Inc." required>
        </div>
        <div style="margin-bottom:18px;"><label class="form-label">Code d'acc√®s entreprise</label> <input class="form-input" id="enterpriseCode" placeholder="Code s√©curis√©" required>
        </div>
       </div>
       <div style="margin-bottom:18px;"><label class="form-label">Nom d'agent / Responsable</label> <input class="form-input" id="agentName" placeholder="Votre nom complet" required>
       </div>
       <div style="margin-bottom:24px;"><label class="form-label">Mot de passe</label> <input class="form-input" type="password" id="password" placeholder="S√©curis√©" required>
       </div><button type="submit" class="btn-primary" style="width:100%;padding:12px;">üîì Connexion S√©curis√©e</button>
      </form>
      <div style="margin-top:16px;padding:14px;background:rgba(74,222,128,0.1);border-left:3px solid #4ade80;border-radius:6px;">
       <p style="font-size:11px;color:#4ade80;"><strong>üîí Chiffrement:</strong> Donn√©es isol√©es par utilisateur/entreprise</p>
      </div>
     </div>
    </div>
   </div><!-- ============ MAIN APP ============ -->
   <div id="mainApp" style="display:none;"><!-- Header -->
    <header>
     <div class="glow-line"></div>
     <div style="padding: 18px 28px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
      <div style="display: flex; align-items: center; gap: 14px;">
       <div style="width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;background:linear-gradient(135deg,var(--primary-color),#ff8800);">
        üîê
       </div>
       <div>
        <h1 style="font-size:20px;font-weight:700;letter-spacing:-0.3px;" id="appTitle">AutoReport</h1>
        <p style="font-size:12px;opacity:0.5;" id="companyName">GPS Temps R√©el S√©curis√©</p>
       </div>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;"><span class="user-info-badge"> <span id="userType" style="font-size:11px;">üë§</span> <span id="userDisplay" style="margin-left:6px;"></span> </span> <span class="security-badge">üîí Isol√©</span> <button class="btn-logout" onclick="handleLogout()">D√©connexion</button>
      </div>
     </div>
     <div class="glow-line"></div>
    </header><!-- Mode Selector -->
    <div id="modeContainer" class="mode-selector" style="display:none;"><button class="mode-btn active" id="modeMineral" onclick="switchMode('mining')"> ‚õèÔ∏è S√©curit√© Mini√®re </button> <button class="mode-btn" id="modeDomestic" onclick="switchMode('domestic')"> üè† S√©curit√© Domestique </button>
    </div><!-- Navigation -->
    <nav class="nav-scroll" style="padding: 14px 28px 0; display:flex; gap:8px; overflow-x:auto;"><button class="nav-btn active" data-section="dashboard" onclick="switchSection('dashboard')">üìä Tableau de bord</button> <button class="nav-btn" data-section="incidents" onclick="switchSection('incidents')">üö® Incidents</button> <button class="nav-btn" id="navPatrols" data-section="patrols" onclick="switchSection('patrols')" style="display:none;">üî¶ Patrouilles</button> <button class="nav-btn" id="navHazards" data-section="hazards" onclick="switchSection('hazards')" style="display:none;">‚ö†Ô∏è Risques</button> <button class="nav-btn" id="navSensors" data-section="sensors" onclick="switchSection('sensors')">üì° Capteurs</button> <button class="nav-btn" data-section="send" onclick="switchSection('send')">üìß Rapports</button>
    </nav>
    <main style="padding: 24px 28px 40px;"><!-- ============ DASHBOARD ============ -->
     <section id="sec-dashboard" class="section-view active">
      <div id="modeInfo" class="mode-header">
       <h3 id="modeTitle">üè¢ Mode S√©curit√© Mini√®re</h3>
       <p id="modeDesc">Gestion compl√®te avec GPS temps r√©el pour interventions rapides</p>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:16px;margin-bottom:28px;">
       <div class="stat-card">
        <p style="font-size:12px;opacity:0.6;margin-bottom:6px;">Alertes actives</p>
        <p style="font-size:28px;font-weight:700;color:#ff3333;" class="mono" id="statAlerts">0</p>
       </div>
       <div class="stat-card">
        <p style="font-size:12px;opacity:0.6;margin-bottom:6px;">Incidents ouverts</p>
        <p style="font-size:28px;font-weight:700;color:#ff6666;" class="mono" id="statIncidents">0</p>
       </div>
       <div class="stat-card">
        <p style="font-size:12px;opacity:0.6;margin-bottom:6px;" id="stat3Label">Patrouilles</p>
        <p style="font-size:28px;font-weight:700;color:#ffc107;" class="mono" id="statPatrols">0</p>
       </div>
       <div class="stat-card">
        <p style="font-size:12px;opacity:0.6;margin-bottom:6px;">Total enregistrements</p>
        <p style="font-size:28px;font-weight:700;color:#6bb5f5;" class="mono" id="statTotal">0</p>
       </div>
      </div><!-- Recent Activity -->
      <div class="card-surface" style="padding:0;">
       <div style="padding:18px 22px; border-bottom:1px solid rgba(255,255,255,0.06);">
        <h2 style="font-size:16px;font-weight:600;">Activit√© r√©cente (priv√©e)</h2>
       </div>
       <div id="recentActivity" style="max-height:400px;overflow:auto;">
        <div class="empty-state">
         <p style="font-size:14px;">Aucune activit√© enregistr√©e</p>
        </div>
       </div>
      </div>
     </section><!-- ============ INCIDENTS ============ -->
     <section id="sec-incidents" class="section-view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
       <h2 style="font-size:18px;font-weight:700;">üö® Incidents (Priv√©s)</h2><button class="btn-primary" onclick="toggleForm('incidentForm')">+ Signaler un incident</button>
      </div><!-- Incident Form -->
      <div id="incidentForm" class="card-surface fade-in" style="display:none;padding:24px;margin-bottom:20px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">Signaler un incident</h3>
       <form onsubmit="submitIncident(event)">
        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
         <div><label class="form-label">Agent / Nom du signaleur</label> <input class="form-input" id="inc-agent" required placeholder="Votre nom">
         </div>
         <div><label class="form-label">Date</label> <input class="form-input" type="date" id="inc-date" required>
         </div>
         <div><label class="form-label">Heure</label> <input class="form-input" type="time" id="inc-time" required>
         </div>
         <div><label class="form-label">Lieu</label> <input class="form-input" id="inc-location" required placeholder="Localisation">
         </div>
         <div id="mineTypeSelect" style="grid-column:1/-1;display:none;"><label class="form-label">Type d'incident minier</label> <select class="form-input" id="inc-type-mine"> <option value="">S√©lectionner...</option> <option value="eboulement">√âboulement / Effondrement</option> <option value="gaz">Pr√©sence de gaz toxique</option> <option value="inondation">Inondation</option> <option value="accident">Accident personnel</option> <option value="materiel">D√©faillance √©quipement</option> </select>
         </div>
         <div id="domesticTypeSelect" style="grid-column:1/-1;"><label class="form-label">Type d'incident</label> <select class="form-input" id="inc-type-domestic"> <option value="">S√©lectionner...</option> <option value="intrusion">Intrusion / Tentative vol</option> <option value="alarme">D√©clenchement alarme</option> <option value="menace">Menace / Agression</option> <option value="accident">Accident domestique</option> <option value="autre">Autre</option> </select>
         </div>
         <div><label class="form-label">Gravit√©</label> <select class="form-input" id="inc-severity" required onchange="checkCritical()"> <option value="">S√©lectionner...</option> <option value="low">Faible</option> <option value="medium">Moyenne</option> <option value="high">√âlev√©e</option> <option value="critical">üö® CRITIQUE</option> </select>
         </div>
         <div><label class="form-label">Statut</label> <select class="form-input" id="inc-status" required> <option value="open">Ouvert</option> <option value="progress">En cours</option> <option value="resolved">R√©solu</option> </select>
         </div>
        </div><!-- GPS Display -->
        <div id="incGeoDisplay" style="margin-top:14px;margin-bottom:14px;">
         <div class="geo-box" id="incGeoBox"><span id="incGeoStatus">üì° GPS en direct <span class="loading-spinner" style="display:inline-block;margin-left:8px;"></span></span>
          <p id="incGeoCoords" style="margin-top:8px;font-family:monospace;font-size:11px;color:#32c8ff;">Localisation en temps r√©el...</p>
          <p id="incGeoUpdate" style="margin-top:4px;font-size:10px;opacity:0.6;">Mise √† jour automatique</p>
         </div>
        </div>
        <div id="criticalBox" style="display:none;margin-top:14px;background:rgba(255,51,51,0.1);border-left:4px solid #ff3333;padding:16px;border-radius:8px;">
         <p style="font-size:13px;font-weight:600;color:#ff3333;margin-bottom:10px;">‚ö†Ô∏è INCIDENT CRITIQUE</p>
         <div><label class="form-label">√âquipe d'intervention</label> <input class="form-input" id="inc-team" placeholder="Ex: SAMU, Pompiers...">
         </div>
         <div style="margin-top:10px;"><label class="form-label">ETA (minutes)</label> <input class="form-input" type="number" id="inc-eta" min="1" placeholder="15">
         </div>
        </div>
        <div style="margin-top:14px;"><label class="form-label">Description d√©taill√©e</label> <textarea class="form-input" id="inc-desc" required placeholder="D√©crivez l'incident..."></textarea>
        </div>
        <div style="margin-top:14px;"><label class="form-label">Actions prises</label> <textarea class="form-input" id="inc-notes" placeholder="Mesures prises..." style="min-height:50px;"></textarea>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;"><button type="submit" class="btn-primary" id="incSubmitBtn">Enregistrer</button> <button type="button" class="btn-secondary" onclick="toggleForm('incidentForm')">Annuler</button>
        </div>
       </form>
      </div>
      <div class="card-surface" style="padding:0;" id="incidentList">
       <div class="empty-state">
        <p>Aucun incident</p>
       </div>
      </div>
     </section><!-- ============ PATROLS (MINING ONLY) ============ -->
     <section id="sec-patrols" class="section-view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
       <h2 style="font-size:18px;font-weight:700;">üî¶ Patrouilles (Priv√©es)</h2><button class="btn-primary" onclick="toggleForm('patrolForm')">+ Nouvelle patrouille</button>
      </div>
      <div id="patrolForm" class="card-surface fade-in" style="display:none;padding:24px;margin-bottom:20px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">Enregistrer une patrouille</h3>
       <form onsubmit="submitPatrol(event)">
        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
         <div><label class="form-label">Agent patrouilleur</label> <input class="form-input" id="pat-agent" required placeholder="Nom">
         </div>
         <div><label class="form-label">Date</label> <input class="form-input" type="date" id="pat-date" required>
         </div>
         <div><label class="form-label">Zone / Secteur</label> <input class="form-input" id="pat-zone" required placeholder="Zone Nord, Secteur...">
         </div>
         <div><label class="form-label">Statut</label> <select class="form-input" id="pat-status" required> <option value="complete">Compl√©t√©e</option> <option value="pending">En attente</option> <option value="missed">Manqu√©e</option> </select>
         </div>
        </div><!-- GPS Display -->
        <div id="patGeoDisplay" style="margin-top:14px;margin-bottom:14px;">
         <div class="geo-box" id="patGeoBox"><span id="patGeoStatus">üì° GPS en direct <span class="loading-spinner" style="display:inline-block;margin-left:8px;"></span></span>
          <p id="patGeoCoords" style="margin-top:8px;font-family:monospace;font-size:11px;color:#32c8ff;">Localisation en temps r√©el...</p>
          <p id="patGeoUpdate" style="margin-top:4px;font-size:10px;opacity:0.6;">Mise √† jour automatique</p>
         </div>
        </div>
        <div style="margin-top:14px;"><label class="form-label">Observations</label> <textarea class="form-input" id="pat-desc" required placeholder="Observations pendant la patrouille..."></textarea>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;"><button type="submit" class="btn-primary" id="patSubmitBtn">Enregistrer</button> <button type="button" class="btn-secondary" onclick="toggleForm('patrolForm')">Annuler</button>
        </div>
       </form>
      </div>
      <div class="card-surface" style="padding:0;" id="patrolList">
       <div class="empty-state">
        <p>Aucune patrouille</p>
       </div>
      </div>
     </section><!-- ============ HAZARDS (MINING ONLY) ============ -->
     <section id="sec-hazards" class="section-view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
       <h2 style="font-size:18px;font-weight:700;">‚ö†Ô∏è Risques D√©tect√©s (Priv√©s)</h2><button class="btn-primary" onclick="toggleForm('hazardForm')">+ D√©clarer un risque</button>
      </div>
      <div id="hazardForm" class="card-surface fade-in" style="display:none;padding:24px;margin-bottom:20px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">D√©clarer un risque</h3>
       <form onsubmit="submitHazard(event)">
        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
         <div><label class="form-label">Agent rapporteur</label> <input class="form-input" id="haz-agent" required placeholder="Nom">
         </div>
         <div><label class="form-label">Date</label> <input class="form-input" type="date" id="haz-date" required>
         </div>
         <div><label class="form-label">Lieu</label> <input class="form-input" id="haz-location" required placeholder="Localisation">
         </div>
         <div><label class="form-label">Type de risque</label> <select class="form-input" id="haz-type" required> <option value="">S√©lectionner...</option> <option value="ventilation">Ventilation d√©faillante</option> <option value="gaz">Gaz accumul√©s</option> <option value="support">D√©faut sout√®nement</option> <option value="eclairage">√âclairage d√©fectueux</option> <option value="chemins">Chemins endommag√©s</option> </select>
         </div>
         <div><label class="form-label">Niveau de risque</label> <select class="form-input" id="haz-level" required onchange="checkExtreme()"> <option value="low">Faible</option> <option value="medium">Moyen</option> <option value="high">√âlev√©</option> <option value="extreme">üö® EXTR√äME</option> </select>
         </div>
         <div><label class="form-label">Personnel expos√©</label> <input class="form-input" type="number" id="haz-personnel" min="0" placeholder="0">
         </div>
        </div><!-- GPS Display -->
        <div id="hazGeoDisplay" style="margin-top:14px;margin-bottom:14px;">
         <div class="geo-box" id="hazGeoBox"><span id="hazGeoStatus">üì° GPS en direct <span class="loading-spinner" style="display:inline-block;margin-left:8px;"></span></span>
          <p id="hazGeoCoords" style="margin-top:8px;font-family:monospace;font-size:11px;color:#32c8ff;">Localisation en temps r√©el...</p>
          <p id="hazGeoUpdate" style="margin-top:4px;font-size:10px;opacity:0.6;">Mise √† jour automatique</p>
         </div>
        </div>
        <div id="extremeBox" style="display:none;margin-top:14px;background:rgba(255,51,51,0.1);border-left:4px solid #ff3333;padding:16px;border-radius:8px;">
         <p style="font-size:13px;font-weight:600;color:#ff3333;margin-bottom:10px;">‚ö†Ô∏è RISQUE EXTR√äME</p><label class="form-label">Action d'urgence</label> <input class="form-input" id="haz-action" placeholder="Ex: √âvacuation, Fermeture zone...">
        </div>
        <div style="margin-top:14px;"><label class="form-label">Description du risque</label> <textarea class="form-input" id="haz-desc" required placeholder="D√©crivez le risque..."></textarea>
        </div>
        <div style="margin-top:14px;"><label class="form-label">Mesure corrective</label> <textarea class="form-input" id="haz-corrective" placeholder="Qu'il faudrait faire..." style="min-height:50px;"></textarea>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;"><button type="submit" class="btn-primary" id="hazSubmitBtn">Enregistrer</button> <button type="button" class="btn-secondary" onclick="toggleForm('hazardForm')">Annuler</button>
        </div>
       </form>
      </div>
      <div class="card-surface" style="padding:0;" id="hazardList">
       <div class="empty-state">
        <p>Aucun risque d√©clar√©</p>
       </div>
      </div>
     </section><!-- ============ SENSORS ============ -->
     <section id="sec-sensors" class="section-view">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;">üì° Capteurs &amp; Alertes (Priv√©s)</h2>
      <div id="sensorsGrid" style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;"><!-- Sensors will be generated here -->
      </div>
      <div style="margin-top:20px;"><button class="btn-primary" onclick="toggleForm('sensorForm')">+ Ajouter capteur</button>
      </div>
      <div id="sensorForm" class="card-surface fade-in" style="display:none;padding:24px;margin-top:20px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">Ajouter un capteur</h3>
       <form onsubmit="submitSensor(event)">
        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
         <div><label class="form-label">Nom du capteur</label> <input class="form-input" id="sensor-name" required placeholder="Ex: Capteur CO2 Zone A">
         </div>
         <div><label class="form-label">Type</label> <select class="form-input" id="sensor-type" required> <option value="">S√©lectionner...</option> <option value="gaz">D√©tecteur gaz</option> <option value="temperature">Temp√©rature</option> <option value="humidite">Humidit√©</option> <option value="seismic">S√©ismique</option> <option value="camera">Cam√©ra</option> <option value="motion">D√©tecteur mouvement</option> <option value="door">Capteur porte</option> </select>
         </div>
         <div><label class="form-label">Localisation</label> <input class="form-input" id="sensor-location" required placeholder="O√π est le capteur">
         </div>
         <div><label class="form-label">Seuil d'alerte</label> <input class="form-input" id="sensor-threshold" placeholder="Ex: 50 ppm">
         </div>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;"><button type="submit" class="btn-primary">Ajouter</button> <button type="button" class="btn-secondary" onclick="toggleForm('sensorForm')">Annuler</button>
        </div>
       </form>
      </div>
     </section><!-- ============ REPORTS ============ -->
     <section id="sec-send" class="section-view">
      <h2 style="font-size:18px;font-weight:700;margin-bottom:20px;">üìß G√©n√©rer &amp; Envoyer Rapports</h2>
      <div class="card-surface" style="padding:24px;margin-bottom:20px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">Configuration destinataires</h3>
       <div style="display:flex;gap:10px;margin-bottom:12px;"><input class="form-input" type="email" id="recipient-email" placeholder="email@exemple.fr" style="flex:1;"> <button type="button" class="btn-secondary" onclick="addRecipient()">Ajouter</button>
       </div>
       <div id="recipientsList" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
      </div>
      <div class="card-surface" style="padding:24px;">
       <h3 style="font-size:15px;font-weight:600;margin-bottom:18px;">G√©n√©rer rapport</h3>
       <form onsubmit="generateReport(event)">
        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
         <div><label class="form-label">Type de rapport</label> <select class="form-input" id="report-type" required> <option value="daily">Rapport Journalier</option> <option value="monthly">Rapport Mensuel</option> <option value="summary">R√©sum√©</option> </select>
         </div>
         <div><label class="form-label">Sujet</label> <input class="form-input" id="report-subject" required placeholder="Sujet du rapport">
         </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;"><label style="display:flex;align-items:center;gap:6px;"> <input type="checkbox" id="rep-incidents" checked style="width:16px;height:16px;"> <span style="font-size:13px;">Incidents</span> </label> <label style="display:flex;align-items:center;gap:6px;"> <input type="checkbox" id="rep-patrols" checked style="width:16px;height:16px;"> <span style="font-size:13px;">Patrouilles</span> </label> <label style="display:flex;align-items:center;gap:6px;"> <input type="checkbox" id="rep-hazards" checked style="width:16px;height:16px;"> <span style="font-size:13px;">Risques</span> </label>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;"><button type="button" class="btn-secondary" onclick="previewReport()">Aper√ßu</button> <button type="submit" class="btn-primary" id="sendBtn" disabled>Envoyer</button>
        </div>
       </form>
      </div>
     </section>
    </main>
    <div id="toast" class="toast-msg"></div>
   </div>
  </div>
  <script>
    // =============== AUTH STATE ===============
    let currentUser = null;
    let currentMode = 'mining';
    let allRecords = [];
    let recipients = [];
    let sensors = [];
    let currentLocation = { latitude: null, longitude: null, accuracy: null, timestamp: null };
    let gpsData = { incident: null, patrol: null, hazard: null };

    const defaultConfig = {
      app_title: 'AutoReport',
      company_name: 'GPS Temps R√©el S√©curis√©',
      background_color: '#0a0e27',
      surface_color: '#151d3b',
      text_color: '#e8edf2',
      primary_color: '#ff6b35',
      secondary_color: '#004e89',
      font_family: 'Outfit',
      font_size: 14
    };

    // =============== AUTH FUNCTIONS ===============
    function updateAuthForm() {
      const type = document.getElementById('authType').value;
      const enterpriseFields = document.getElementById('enterpriseFields');
      enterpriseFields.style.display = type === 'enterprise' ? 'block' : 'none';
    }

    function handleLogin(e) {
      e.preventDefault();

      const authType = document.getElementById('authType').value;
      const agentName = document.getElementById('agentName').value.trim();
      const password = document.getElementById('password').value.trim();

      if (authType === 'enterprise') {
        const enterpriseName = document.getElementById('enterpriseName').value.trim();
        const enterpriseCode = document.getElementById('enterpriseCode').value.trim();

        if (!enterpriseName || !enterpriseCode) {
          showToast('Tous les champs requis', 'error');
          return;
        }

        currentUser = {
          id: 'ent-' + Date.now(),
          type: 'enterprise',
          name: agentName,
          enterprise: enterpriseName,
          code: enterpriseCode,
          password: password
        };

        document.getElementById('modeContainer').style.display = 'flex';
      } else {
        currentUser = {
          id: 'pers-' + Date.now(),
          type: 'personal',
          name: agentName,
          password: password
        };

        document.getElementById('modeContainer').style.display = 'none';
        currentMode = 'domestic';
      }

      showLogin(false);
      updateUserDisplay();
      showToast('‚úì Authentification r√©ussie');
    }

    function handleLogout() {
      currentUser = null;
      allRecords = [];
      recipients = [];
      sensors = [];
      showLogin(true);
      document.getElementById('authForm').reset();
      updateAuthForm();
    }

    function showLogin(show) {
      document.getElementById('authScreen').style.display = show ? 'flex' : 'none';
      document.getElementById('mainApp').style.display = show ? 'none' : 'block';
    }

    function updateUserDisplay() {
      if (!currentUser) return;

      const typeEmoji = currentUser.type === 'enterprise' ? 'üëî' : 'üè†';
      const typeLabel = currentUser.type === 'enterprise' ? 'Entreprise' : 'Particulier';
      
      let displayText = `${typeEmoji} ${currentUser.name}`;
      if (currentUser.enterprise) {
        displayText += ` ‚Ä¢ ${currentUser.enterprise}`;
      }

      document.getElementById('userType').textContent = typeEmoji;
      document.getElementById('userDisplay').textContent = displayText;
    }

    // =============== DATA FILTERING BY USER ===============
    function filterRecordsByUser(records) {
      if (!currentUser) return [];
      return records.filter(r => r.user_id === currentUser.id);
    }

    function addUserToRecord(record) {
      record.user_id = currentUser.id;
      if (currentUser.type === 'enterprise') {
        record.enterprise_id = currentUser.id;
      }
      return record;
    }

    // =============== GEOLOCATION - REAL-TIME ===============
    function initGeolocation() {
      if (!navigator.geolocation) {
        return;
      }

      navigator.geolocation.watchPosition(
        (position) => {
          currentLocation = {
            latitude: position.coords.latitude.toFixed(6),
            longitude: position.coords.longitude.toFixed(6),
            accuracy: position.coords.accuracy.toFixed(1),
            timestamp: new Date().toLocaleTimeString('fr-FR')
          };
        },
        () => {},
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    function updateAllOpenForms() {
      if (document.getElementById('incidentForm').style.display !== 'none') {
        updateGPSDisplay('incident');
      }
      if (document.getElementById('patrolForm').style.display !== 'none') {
        updateGPSDisplay('patrol');
      }
      if (document.getElementById('hazardForm').style.display !== 'none') {
        updateGPSDisplay('hazard');
      }
    }

    function updateGPSDisplay(type) {
      if (!currentLocation.latitude) {
        updateGPSError(type);
        return;
      }

      const lat = currentLocation.latitude;
      const lng = currentLocation.longitude;
      const accuracy = currentLocation.accuracy;
      const time = currentLocation.timestamp;

      gpsData[type] = { lat, lng };

      const coordEl = document.getElementById(type + 'GeoCoords');
      const statusEl = document.getElementById(type + 'GeoStatus');
      const updateEl = document.getElementById(type + 'GeoUpdate');
      const boxEl = document.getElementById(type + 'GeoBox');

      if (coordEl) coordEl.innerHTML = `<strong>üìç ${lat}, ${lng}</strong><br><span style="font-size:10px;opacity:0.6;">Pr√©cision: ¬±${accuracy}m</span>`;
      if (statusEl) statusEl.innerHTML = '‚úÖ GPS en direct <span class="loading-spinner" style="display:inline-block;margin-left:8px;width:12px;height:12px;"></span>';
      if (updateEl) updateEl.textContent = `Mis √† jour: ${time}`;
      if (boxEl) {
        boxEl.classList.add('success');
        boxEl.classList.remove('error');
      }
    }

    function updateGPSError(type) {
      const statusEl = document.getElementById(type + 'GeoStatus');
      const boxEl = document.getElementById(type + 'GeoBox');

      if (statusEl) statusEl.textContent = '‚ùå GPS indisponible';
      if (boxEl) {
        boxEl.classList.add('error');
        boxEl.classList.remove('success');
      }
    }

    // =============== TOAST ===============
    function showToast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast-msg toast-' + type + ' show';
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // =============== FORM TOGGLE ===============
    function toggleForm(id) {
      const el = document.getElementById(id);
      const isOpening = el.style.display === 'none';
      
      el.style.display = isOpening ? 'block' : 'none';

      if (isOpening) {
        const formType = id.replace('Form', '').toLowerCase();
        updateGPSDisplay(formType);
      }
    }

    function checkCritical() {
      const criticBox = document.getElementById('criticalBox');
      if (document.getElementById('inc-severity').value === 'critical') {
        criticBox.style.display = 'block';
      } else {
        criticBox.style.display = 'none';
      }
    }

    function checkExtreme() {
      const extremeBox = document.getElementById('extremeBox');
      if (document.getElementById('haz-level').value === 'extreme') {
        extremeBox.style.display = 'block';
      } else {
        extremeBox.style.display = 'none';
      }
    }

    // =============== BADGES ===============
    function severityBadge(s) {
      const labels = { low: 'Faible', medium: 'Moyenne', high: '√âlev√©e', critical: 'Critique' };
      return `<span class="severity-badge severity-${s}">${labels[s] || s}</span>`;
    }

    function statusBadge(st) {
      const labels = { open: 'Ouvert', progress: 'En cours', resolved: 'R√©solu', complete: 'Compl√©t√©e', pending: 'Pending', missed: 'Manqu√©e' };
      return `<span class="status-badge status-${st}">${labels[st] || st}</span>`;
    }

    // =============== RENDER ===============
    function renderDashboard() {
      const filtered = filterRecordsByUser(allRecords);
      const incidents = filtered.filter(r => r.type === 'incident' && r.status !== 'resolved');
      const patrols = filtered.filter(r => r.type === 'patrol');

      document.getElementById('statAlerts').textContent = '0';
      document.getElementById('statIncidents').textContent = incidents.length;
      document.getElementById('statPatrols').textContent = currentMode === 'mining' ? patrols.length : sensors.length;
      document.getElementById('statTotal').textContent = filtered.length;

      const recent = [...filtered].sort((a, b) => (b.date + (b.time||'')) > (a.date + (a.time||'')) ? 1 : -1).slice(0, 8);
      const el = document.getElementById('recentActivity');
      
      if (recent.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>Aucune activit√©</p></div>';
        return;
      }

      el.innerHTML = recent.map(r => {
        const icon = r.type === 'incident' ? 'üö®' : r.type === 'patrol' ? 'üî¶' : '‚ö†Ô∏è';
        const badge = r.type === 'incident' ? severityBadge(r.severity) : statusBadge(r.status);
        const gpsText = r.latitude ? `<p style="font-size:11px;opacity:0.4;">üìç ${r.latitude}</p>` : '';
        return `<div class="record-row"><span style="font-size:20px;">${icon}</span><div style="flex:1;"><p style="font-size:13px;font-weight:600;">${r.agent_name || 'Agent'}</p><p style="font-size:11px;opacity:0.5;">${r.date}${r.time ? ' ' + r.time : ''}</p>${gpsText}</div>${badge}</div>`;
      }).join('');
    }

    function renderIncidents() {
      const items = filterRecordsByUser(allRecords).filter(r => r.type === 'incident').sort((a, b) => (b.date + b.time) > (a.date + a.time) ? 1 : -1);
      const el = document.getElementById('incidentList');

      if (items.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>Aucun incident</p></div>';
        return;
      }

      el.innerHTML = items.map(r => `
        <div class="record-row" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px;">
              <p style="font-size:14px;font-weight:600;">üë§ ${r.agent_name}</p>
              ${severityBadge(r.severity)}
              ${statusBadge(r.status)}
            </div>
            <p style="font-size:11px;opacity:0.5;">${r.date} ${r.time}</p>
            <p style="font-size:12px;opacity:0.6;">üìç ${r.location}</p>
            ${r.latitude ? `<p style="font-size:11px;color:#32c8ff;">üó∫Ô∏è ${r.latitude}, ${r.longitude}<br><span style="opacity:0.6;">Pr√©cision: ¬±${r.accuracy}m</span></p>` : ''}
            <p style="font-size:12px;margin-top:6px;">${r.description.substring(0, 100)}...</p>
          </div>
          <button class="btn-danger" onclick="deleteRecord('${r.__backendId}')">‚úï</button>
        </div>
      `).join('');
    }

    function renderPatrols() {
      if (currentMode !== 'mining') return;
      const items = filterRecordsByUser(allRecords).filter(r => r.type === 'patrol').sort((a, b) => b.date > a.date ? 1 : -1);
      const el = document.getElementById('patrolList');

      if (items.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>Aucune patrouille</p></div>';
        return;
      }

      el.innerHTML = items.map(r => `
        <div class="record-row" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
          <div style="flex:1;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
              <p style="font-size:14px;font-weight:600;">üë§ ${r.agent_name}</p>
              ${statusBadge(r.patrol_status)}
            </div>
            <p style="font-size:11px;opacity:0.5;">${r.date}</p>
            <p style="font-size:12px;opacity:0.6;">üìç ${r.patrol_zone}</p>
            ${r.latitude ? `<p style="font-size:11px;color:#32c8ff;">üó∫Ô∏è ${r.latitude}, ${r.longitude}</p>` : ''}
            <p style="font-size:12px;margin-top:6px;">${r.description.substring(0, 100)}...</p>
          </div>
          <button class="btn-danger" onclick="deleteRecord('${r.__backendId}')">‚úï</button>
        </div>
      `).join('');
    }

    function renderHazards() {
      if (currentMode !== 'mining') return;
      const items = filterRecordsByUser(allRecords).filter(r => r.type === 'hazard').sort((a, b) => b.date > a.date ? 1 : -1);
      const el = document.getElementById('hazardList');

      if (items.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>Aucun risque</p></div>';
        return;
      }

      el.innerHTML = items.map(r => `
        <div class="record-row" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
          <div style="flex:1;">
            <p style="font-size:14px;font-weight:600;margin-bottom:4px;">‚ö†Ô∏è ${r.hazard_type || 'Risque'}</p>
            <p style="font-size:11px;opacity:0.5;">${r.date} ‚Ä¢ ${r.agent_name}</p>
            <p style="font-size:12px;opacity:0.6;">üìç ${r.location}</p>
            ${r.latitude ? `<p style="font-size:11px;color:#32c8ff;">üó∫Ô∏è ${r.latitude}, ${r.longitude}</p>` : ''}
            <p style="font-size:12px;margin-top:6px;">${r.description.substring(0, 100)}...</p>
          </div>
          <button class="btn-danger" onclick="deleteRecord('${r.__backendId}')">‚úï</button>
        </div>
      `).join('');
    }

    function renderSensors(mode) {
      const grid = document.getElementById('sensorsGrid');
      
      if (mode === 'mining') {
        grid.innerHTML = `
          <div class="card-surface" style="padding:16px;">
            <p style="font-size:13px;font-weight:600;">üìä Capteur CO2</p>
            <p style="font-size:24px;font-weight:700;margin:8px 0;">0 ppm</p>
            <p style="font-size:11px;opacity:0.5;">Zone principale ‚Ä¢ Nominal</p>
          </div>
          <div class="card-surface" style="padding:16px;">
            <p style="font-size:13px;font-weight:600;">üå°Ô∏è Temp√©rature</p>
            <p style="font-size:24px;font-weight:700;margin:8px 0;">22¬∞C</p>
            <p style="font-size:11px;opacity:0.5;">Galerie Nord ‚Ä¢ Optimal</p>
          </div>
        `;
      } else {
        grid.innerHTML = `
          <div class="card-surface" style="padding:16px;">
            <p style="font-size:13px;font-weight:600;">üìπ Cam√©ra Entr√©e</p>
            <p style="font-size:14px;color:#4ade80;margin:8px 0;">‚óè En ligne</p>
            <p style="font-size:11px;opacity:0.5;">Portail principal</p>
          </div>
          <div class="card-surface" style="padding:16px;">
            <p style="font-size:13px;font-weight:600;">üö™ Capteur Porte</p>
            <p style="font-size:14px;color:#4ade80;margin:8px 0;">‚óè Ferm√©e</p>
            <p style="font-size:11px;opacity:0.5;">Porte avant</p>
          </div>
        `;
      }
    }

    function renderAll() {
      renderDashboard();
      renderIncidents();
      if (currentMode === 'mining') {
        renderPatrols();
        renderHazards();
      }
    }

    // =============== FORM SUBMISSIONS ===============
    async function submitIncident(e) {
      e.preventDefault();
      if (allRecords.length >= 999) { showToast('Limite atteinte', 'error'); return; }

      const btn = document.getElementById('incSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Enregistrement...';

      const severity = document.getElementById('inc-severity').value;
      const incType = currentMode === 'mining' ? document.getElementById('inc-type-mine').value : document.getElementById('inc-type-domestic').value;

      let record = {
        type: 'incident',
        mode: currentMode,
        agent_name: document.getElementById('inc-agent').value.trim(),
        date: document.getElementById('inc-date').value,
        time: document.getElementById('inc-time').value,
        location: document.getElementById('inc-location').value.trim(),
        description: document.getElementById('inc-desc').value.trim(),
        severity: severity,
        status: document.getElementById('inc-status').value,
        incident_type: incType,
        notes: document.getElementById('inc-notes').value.trim(),
        latitude: gpsData.incident ? gpsData.incident.lat : '',
        longitude: gpsData.incident ? gpsData.incident.lng : '',
        accuracy: currentLocation.accuracy || '',
        timestamp: currentLocation.timestamp || '',
        patrol_zone: '',
        patrol_status: '',
        hazard_type: '',
        hazard_level: ''
      };

      record = addUserToRecord(record);

      const result = await window.dataSdk.create(record);
      btn.disabled = false;
      btn.textContent = 'Enregistrer';

      if (result.isOk) {
        showToast('Incident enregistr√© ‚úì');
        e.target.reset();
        document.getElementById('inc-date').value = new Date().toISOString().split('T')[0];
        toggleForm('incidentForm');
      } else {
        showToast('Erreur', 'error');
      }
    }

    async function submitPatrol(e) {
      e.preventDefault();
      if (allRecords.length >= 999) { showToast('Limite atteinte', 'error'); return; }

      const btn = document.getElementById('patSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Enregistrement...';

      let record = {
        type: 'patrol',
        mode: 'mining',
        agent_name: document.getElementById('pat-agent').value.trim(),
        date: document.getElementById('pat-date').value,
        time: '',
        patrol_zone: document.getElementById('pat-zone').value.trim(),
        patrol_status: document.getElementById('pat-status').value,
        description: document.getElementById('pat-desc').value.trim(),
        location: '',
        severity: '',
        status: '',
        incident_type: '',
        notes: '',
        latitude: gpsData.patrol ? gpsData.patrol.lat : '',
        longitude: gpsData.patrol ? gpsData.patrol.lng : '',
        accuracy: currentLocation.accuracy || '',
        timestamp: currentLocation.timestamp || '',
        hazard_type: '',
        hazard_level: ''
      };

      record = addUserToRecord(record);

      const result = await window.dataSdk.create(record);
      btn.disabled = false;
      btn.textContent = 'Enregistrer';

      if (result.isOk) {
        showToast('Patrouille enregistr√©e ‚úì');
        e.target.reset();
        document.getElementById('pat-date').value = new Date().toISOString().split('T')[0];
        toggleForm('patrolForm');
      } else {
        showToast('Erreur', 'error');
      }
    }

    async function submitHazard(e) {
      e.preventDefault();
      if (allRecords.length >= 999) { showToast('Limite atteinte', 'error'); return; }

      const btn = document.getElementById('hazSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Enregistrement...';

      const level = document.getElementById('haz-level').value;

      let record = {
        type: 'hazard',
        mode: 'mining',
        agent_name: document.getElementById('haz-agent').value.trim(),
        date: document.getElementById('haz-date').value,
        time: '',
        location: document.getElementById('haz-location').value.trim(),
        description: document.getElementById('haz-desc').value.trim(),
        hazard_type: document.getElementById('haz-type').value,
        hazard_level: level,
        notes: document.getElementById('haz-corrective').value.trim(),
        latitude: gpsData.hazard ? gpsData.hazard.lat : '',
        longitude: gpsData.hazard ? gpsData.hazard.lng : '',
        accuracy: currentLocation.accuracy || '',
        timestamp: currentLocation.timestamp || '',
        severity: '',
        status: '',
        incident_type: '',
        patrol_zone: '',
        patrol_status: ''
      };

      record = addUserToRecord(record);

      const result = await window.dataSdk.create(record);
      btn.disabled = false;
      btn.textContent = 'Enregistrer';

      if (result.isOk) {
        showToast('Risque enregistr√© ‚úì');
        e.target.reset();
        document.getElementById('haz-date').value = new Date().toISOString().split('T')[0];
        toggleForm('hazardForm');
      } else {
        showToast('Erreur', 'error');
      }
    }

    async function submitSensor(e) {
      e.preventDefault();
      const sensor = {
        id: 'sensor-' + Date.now(),
        name: document.getElementById('sensor-name').value,
        type: document.getElementById('sensor-type').value,
        location: document.getElementById('sensor-location').value,
        threshold: document.getElementById('sensor-threshold').value
      };

      sensors.push(sensor);
      e.target.reset();
      toggleForm('sensorForm');
      showToast('Capteur ajout√© ‚úì');
      renderSensors(currentMode);
    }

    // =============== RECIPIENTS ===============
    function addRecipient() {
      const email = document.getElementById('recipient-email').value.trim();
      if (!email) { showToast('Email requis', 'error'); return; }
      if (recipients.includes(email)) { showToast('D√©j√† ajout√©', 'error'); return; }

      recipients.push(email);
      document.getElementById('recipient-email').value = '';
      renderRecipients();
    }

    function renderRecipients() {
      const el = document.getElementById('recipientsList');
      if (recipients.length === 0) {
        el.innerHTML = '';
        document.getElementById('sendBtn').disabled = true;
        return;
      }

      el.innerHTML = recipients.map((r, i) => `
        <div style="display:inline-block;background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:12px;margin-right:8px;margin-bottom:8px;font-size:12px;">
          ${r} <button type="button" onclick="recipients.splice(${i}, 1); renderRecipients();" style="background:none;border:none;color:currentColor;cursor:pointer;margin-left:6px;">‚úï</button>
        </div>
      `).join('');

      document.getElementById('sendBtn').disabled = false;
    }

    // =============== REPORTS ===============
    function previewReport() {
      const type = document.getElementById('report-type').value;
      let content = `Rapport ${type} - ${new Date().toLocaleDateString('fr-FR')}\n\n`;

      if (document.getElementById('rep-incidents').checked) {
        const incidents = filterRecordsByUser(allRecords).filter(r => r.type === 'incident');
        content += `Incidents: ${incidents.length}\n`;
      }
      if (document.getElementById('rep-patrols').checked && currentMode === 'mining') {
        const patrols = filterRecordsByUser(allRecords).filter(r => r.type === 'patrol');
        content += `Patrouilles: ${patrols.length}\n`;
      }
      if (document.getElementById('rep-hazards').checked && currentMode === 'mining') {
        const hazards = filterRecordsByUser(allRecords).filter(r => r.type === 'hazard');
        content += `Risques: ${hazards.length}\n`;
      }

      alert('Aper√ßu:\n\n' + content);
    }

    async function generateReport(e) {
      e.preventDefault();
      if (recipients.length === 0) { showToast('Ajoutez un destinataire', 'error'); return; }

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.textContent = 'üìß Envoi...';

      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'Envoyer';
        showToast('Rapport envoy√© ‚úì');
      }, 1500);
    }

    // =============== DELETE ===============
    async function deleteRecord(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;

      const result = await window.dataSdk.delete(record);
      if (result.isOk) {
        showToast('Supprim√© ‚úì');
      } else {
        showToast('Erreur', 'error');
      }
    }

    // =============== MODE SWITCHING ===============
    function switchMode(mode) {
      currentMode = mode;
      
      const mineBtn = document.getElementById('modeMineral');
      const domBtn = document.getElementById('modeDomestic');
      
      if (mode === 'mining') {
        mineBtn.classList.add('active');
        domBtn.classList.remove('active');
        
        document.getElementById('modeTitle').textContent = '‚õèÔ∏è Mode S√©curit√© Mini√®re';
        document.getElementById('modeDesc').textContent = 'Gestion compl√®te avec GPS temps r√©el pour interventions rapides';
        
        document.getElementById('navPatrols').style.display = 'inline-block';
        document.getElementById('navHazards').style.display = 'inline-block';
        document.getElementById('mineTypeSelect').style.display = 'block';
        document.getElementById('domesticTypeSelect').style.display = 'none';
        document.getElementById('stat3Label').textContent = 'Patrouilles';
        
        renderSensors('mining');
      } else {
        domBtn.classList.add('active');
        mineBtn.classList.remove('active');
        
        document.getElementById('modeTitle').textContent = 'üè† Mode S√©curit√© Domestique';
        document.getElementById('modeDesc').textContent = 'Protection simplifi√©e avec localisation temps r√©el';
        
        document.getElementById('navPatrols').style.display = 'none';
        document.getElementById('navHazards').style.display = 'none';
        document.getElementById('mineTypeSelect').style.display = 'none';
        document.getElementById('domesticTypeSelect').style.display = 'block';
        document.getElementById('stat3Label').textContent = 'Capteurs';
        
        renderSensors('domestic');
      }
      
      renderAll();
      showToast(`Mode ${mode === 'mining' ? 'S√©curit√© Mini√®re' : 'S√©curit√© Domestique'} ‚úì`);
    }

    // =============== SECTION SWITCHING ===============
    function switchSection(name) {
      document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('sec-' + name).classList.add('active');
      document.querySelector(`.nav-btn[data-section="${name}"]`).classList.add('active');
    }

    // =============== DATA SDK ===============
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        renderAll();
      }
    };

    // =============== INIT ===============
    (async function init() {
      initGeolocation();

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inc-date').value = today;
      document.getElementById('pat-date').value = today;
      document.getElementById('haz-date').value = today;

      updateAuthForm();
      showLogin(true);

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: { ...defaultConfig },
          onConfigChange: async (config) => {
            document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('companyName').textContent = config.company_name || defaultConfig.company_name;
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              { get: () => config.primary_color || '#ff6b35', set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); } }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['company_name', config.company_name || defaultConfig.company_name]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) console.error("Data SDK init failed");
      }
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ccd191ad7ae7400',t:'MTc3MDkwOTkyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
