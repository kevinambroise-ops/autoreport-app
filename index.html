<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Fournisseurs &amp; Commandes MAG HOUSE</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&amp;family=Playfair+Display:wght@600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-12px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    .fade-up { animation: fadeUp 0.5s ease forwards; }
    .slide-in { animation: slideIn 0.35s ease forwards; }

    .card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
    }

    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-action);
    }

    .btn-primary {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }
    .btn-primary:active {
      transform: translateY(0);
    }

    .loading-dot {
      animation: pulse-dot 1.2s ease infinite;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    .tab-btn {
      transition: all 0.2s ease;
    }
    .tab-btn.active {
      border-bottom-color: var(--primary-action);
      color: var(--primary-action);
    }

    :root {
      --bg-color: #0f1729;
      --surface-color: #1a2540;
      --text-color: #e8ecf4;
      --primary-action: #f0943a;
      --secondary-action: #3b5998;
    }

    .status-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .status-pending { background: #92400e; color: #fef3c7; }
    .status-confirmed { background: #0f2e50; color: #93c5fd; }
    .status-shipped { background: #1e3a1f; color: #86efac; }
    .status-delivered { background: #1e2d2d; color: #a3e4d7; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full" style="margin:0; font-family:'DM Sans',sans-serif; background:var(--bg-color); color:var(--text-color);">
  <div id="app-wrapper" class="h-full w-full overflow-auto" style="background:var(--bg-color);">
   <div class="w-full max-w-5xl mx-auto px-4 py-8"><!-- Header -->
    <header class="mb-8 fade-up">
     <div class="flex items-center gap-3 mb-2">
      <svg width="36" height="36" viewbox="0 0 36 36" fill="none" style="flex-shrink:0;"><rect width="36" height="36" rx="10" fill="var(--primary-action)" opacity="0.15" /> <path d="M12 14h12M12 18h8M12 22h10" stroke="var(--primary-action)" stroke-width="2" stroke-linecap="round" /> <circle cx="26" cy="24" r="4" fill="var(--primary-action)" opacity="0.6" /> <path d="M25 24h2M26 23v2" stroke="var(--bg-color)" stroke-width="1.2" stroke-linecap="round" />
      </svg>
      <h1 id="page-title" style="font-family:'Playfair Display',serif; font-size:32px; font-weight:700; color:var(--text-color); margin:0;">Gestion Fournisseurs &amp; Commandes</h1>
     </div>
     <p id="subtitle-text" style="color:var(--text-color); opacity:0.6; margin:0; font-size:15px;">G√©rez vos contacts et suivez vos commandes en un seul endroit</p>
    </header><!-- Tabs -->
    <div class="flex gap-1 mb-6 border-b" style="border-color:rgba(255,255,255,0.08);"><button id="tab-suppliers" class="tab-btn px-4 py-3 font-semibold text-sm active" onclick="switchTab('suppliers')" style="border-bottom:2px solid var(--primary-action); color:var(--primary-action);"> üìã Fournisseurs </button> <button id="tab-orders" class="tab-btn px-4 py-3 font-semibold text-sm" onclick="switchTab('orders')" style="border-bottom:2px solid transparent; color:var(--text-color); opacity:0.6;"> üì¶ Commandes </button>
    </div><!-- ====== SUPPLIERS TAB ====== -->
    <div id="suppliers-section" class="fade-up">
     <div class="mb-6 fade-up" style="animation-delay:0.1s;"><button id="toggle-supplier-form-btn" class="btn-primary flex items-center gap-2 px-5 py-3 rounded-xl font-semibold text-sm" style="background:var(--primary-action); color:var(--bg-color);" onclick="toggleSupplierForm()">
       <svg width="18" height="18" viewbox="0 0 18 18" fill="none">
        <path d="M9 4v10M4 9h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg><span id="add-supplier-label">Ajouter un fournisseur</span> </button>
     </div><!-- Supplier Form -->
     <div id="supplier-form-panel" class="mb-6 rounded-2xl p-6" style="display:none; background:var(--surface-color); border:1px solid rgba(255,255,255,0.06);">
      <h2 style="font-family:'Playfair Display',serif; font-size:20px; font-weight:600; margin:0 0 20px 0; color:var(--text-color);">Nouveau fournisseur</h2>
      <form id="supplier-form" onsubmit="handleSupplierSubmit(event)">
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <div><label for="s-name" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Nom de l'entreprise *</label> <input id="s-name" type="text" required class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="Ex: Fournitures Express">
        </div>
        <div><label for="s-contact" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Personne de contact</label> <input id="s-contact" type="text" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="Ex: Jean Dupont">
        </div>
        <div><label for="s-email" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Email</label> <input id="s-email" type="email" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="contact@exemple.fr">
        </div>
        <div><label for="s-phone" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">T√©l√©phone</label> <input id="s-phone" type="tel" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="01 23 45 67 89">
        </div>
        <div><label for="s-category" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Cat√©gorie</label> <input id="s-category" type="text" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="Ex: Mati√®res premi√®res">
        </div>
        <div><label for="s-notes" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Notes</label> <input id="s-notes" type="text" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="Remarques...">
        </div>
       </div>
       <div class="flex gap-3"><button type="submit" id="supplier-submit-btn" class="btn-primary px-5 py-2.5 rounded-lg font-semibold text-sm flex items-center gap-2" style="background:var(--primary-action); color:var(--bg-color);"> <span id="supplier-submit-label">Enregistrer</span> <span id="supplier-submit-spinner" style="display:none;" class="flex gap-1"> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> </span> </button> <button type="button" onclick="toggleSupplierForm()" class="px-5 py-2.5 rounded-lg font-semibold text-sm" style="background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text-color);"> Annuler </button>
       </div>
       <p id="supplier-form-error" class="mt-3 text-xs" style="color:#ef4444; display:none;"></p>
       <p id="supplier-form-success" class="mt-3 text-xs" style="color:#22c55e; display:none;"></p>
      </form>
     </div><!-- Search & Count -->
     <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-5 fade-up" style="animation-delay:0.15s;">
      <div class="relative flex-1">
       <svg class="absolute left-3 top-1/2 -translate-y-1/2" width="16" height="16" viewbox="0 0 16 16" fill="none"><circle cx="7" cy="7" r="5" stroke="var(--text-color)" stroke-opacity="0.4" stroke-width="1.5" /> <path d="M11 11l3 3" stroke="var(--text-color)" stroke-opacity="0.4" stroke-width="1.5" stroke-linecap="round" />
       </svg><input id="supplier-search" type="text" class="form-input w-full rounded-lg pl-9 pr-3.5 py-2.5 text-sm" style="background:var(--surface-color); border:1px solid rgba(255,255,255,0.08); color:var(--text-color);" placeholder="Rechercher un fournisseur..." oninput="filterSuppliers()">
      </div><span id="supplier-count" class="text-xs font-medium px-3 py-1.5 rounded-full whitespace-nowrap" style="background:var(--secondary-action); color:var(--text-color); opacity:0.9;"> 0 fournisseur(s) </span>
     </div><!-- Supplier List -->
     <main id="supplier-list" class="flex flex-col gap-3">
      <div id="suppliers-empty" class="text-center py-16 fade-up" style="animation-delay:0.2s;">
       <svg class="mx-auto mb-4" width="56" height="56" viewbox="0 0 56 56" fill="none"><rect width="56" height="56" rx="16" fill="var(--surface-color)" /> <path d="M20 24h16M20 30h10" stroke="var(--primary-action)" stroke-width="2" stroke-linecap="round" opacity="0.5" /> <circle cx="38" cy="36" r="6" fill="var(--primary-action)" opacity="0.2" /> <path d="M37 36h2M38 35v2" stroke="var(--primary-action)" stroke-width="1.4" stroke-linecap="round" />
       </svg>
       <p class="font-semibold text-base mb-1" style="color:var(--text-color);">Aucun fournisseur</p>
       <p class="text-sm" style="color:var(--text-color); opacity:0.5;">Ajoutez votre premier fournisseur pour commencer</p>
      </div>
     </main>
    </div><!-- ====== ORDERS TAB ====== -->
    <div id="orders-section" class="fade-up" style="display:none;">
     <div class="mb-6 fade-up" style="animation-delay:0.1s;"><button id="toggle-order-form-btn" class="btn-primary flex items-center gap-2 px-5 py-3 rounded-xl font-semibold text-sm" style="background:var(--primary-action); color:var(--bg-color);" onclick="toggleOrderForm()">
       <svg width="18" height="18" viewbox="0 0 18 18" fill="none">
        <path d="M9 4v10M4 9h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
       </svg><span id="add-order-label">Ajouter une commande</span> </button>
     </div><!-- Order Form -->
     <div id="order-form-panel" class="mb-6 rounded-2xl p-6" style="display:none; background:var(--surface-color); border:1px solid rgba(255,255,255,0.06);">
      <h2 style="font-family:'Playfair Display',serif; font-size:20px; font-weight:600; margin:0 0 20px 0; color:var(--text-color);">Nouvelle commande</h2>
      <form id="order-form" onsubmit="handleOrderSubmit(event)">
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <div><label for="o-supplier" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Fournisseur *</label> <select id="o-supplier" required class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);"> <option value="">-- S√©lectionner un fournisseur --</option> </select>
        </div>
        <div><label for="o-article" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Article *</label> <input id="o-article" type="text" required class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="Ex: Vis M6">
        </div>
        <div><label for="o-quantity" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Quantit√© *</label> <input id="o-quantity" type="number" required min="1" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="100">
        </div>
        <div><label for="o-price" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Prix unitaire (‚Ç¨) *</label> <input id="o-price" type="number" required min="0" step="0.01" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);" placeholder="15.50">
        </div>
        <div><label for="o-date" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Date de commande *</label> <input id="o-date" type="date" required class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);">
        </div>
        <div><label for="o-status" class="block text-xs font-medium mb-1.5" style="color:var(--text-color); opacity:0.7;">Statut</label> <select id="o-status" class="form-input w-full rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--bg-color); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);"> <option value="pending">En attente</option> <option value="confirmed">Confirm√©e</option> <option value="shipped">Exp√©di√©e</option> <option value="delivered">Livr√©e</option> </select>
        </div>
       </div>
       <div class="flex gap-3"><button type="submit" id="order-submit-btn" class="btn-primary px-5 py-2.5 rounded-lg font-semibold text-sm flex items-center gap-2" style="background:var(--primary-action); color:var(--bg-color);"> <span id="order-submit-label">Enregistrer</span> <span id="order-submit-spinner" style="display:none;" class="flex gap-1"> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> <span class="loading-dot inline-block w-1.5 h-1.5 rounded-full" style="background:var(--bg-color);"></span> </span> </button> <button type="button" onclick="toggleOrderForm()" class="px-5 py-2.5 rounded-lg font-semibold text-sm" style="background:transparent; border:1px solid rgba(255,255,255,0.15); color:var(--text-color);"> Annuler </button>
       </div>
       <p id="order-form-error" class="mt-3 text-xs" style="color:#ef4444; display:none;"></p>
       <p id="order-form-success" class="mt-3 text-xs" style="color:#22c55e; display:none;"></p>
      </form>
     </div><!-- Search & Filters -->
     <div class="flex flex-col sm:flex-row gap-3 mb-5 fade-up" style="animation-delay:0.15s;">
      <div class="relative flex-1">
       <svg class="absolute left-3 top-1/2 -translate-y-1/2" width="16" height="16" viewbox="0 0 16 16" fill="none"><circle cx="7" cy="7" r="5" stroke="var(--text-color)" stroke-opacity="0.4" stroke-width="1.5" /> <path d="M11 11l3 3" stroke="var(--text-color)" stroke-opacity="0.4" stroke-width="1.5" stroke-linecap="round" />
       </svg><input id="order-search" type="text" class="form-input w-full rounded-lg pl-9 pr-3.5 py-2.5 text-sm" style="background:var(--surface-color); border:1px solid rgba(255,255,255,0.08); color:var(--text-color);" placeholder="Rechercher une commande..." oninput="filterOrders()">
      </div><select id="status-filter" class="form-input rounded-lg px-3.5 py-2.5 text-sm" style="background:var(--surface-color); border:1px solid rgba(255,255,255,0.08); color:var(--text-color); min-width:150px;" onchange="filterOrders()"> <option value="">Tous les statuts</option> <option value="pending">En attente</option> <option value="confirmed">Confirm√©e</option> <option value="shipped">Exp√©di√©e</option> <option value="delivered">Livr√©e</option> </select> <span id="order-count" class="text-xs font-medium px-3 py-1.5 rounded-full whitespace-nowrap" style="background:var(--secondary-action); color:var(--text-color); opacity:0.9;"> 0 commande(s) </span>
     </div><!-- Order List -->
     <main id="order-list" class="flex flex-col gap-3">
      <div id="orders-empty" class="text-center py-16 fade-up" style="animation-delay:0.2s;">
       <svg class="mx-auto mb-4" width="56" height="56" viewbox="0 0 56 56" fill="none"><rect width="56" height="56" rx="16" fill="var(--surface-color)" /> <path d="M20 20h16v14H20z" stroke="var(--primary-action)" stroke-width="1.5" stroke-opacity="0.5" /> <circle cx="28" cy="27" r="2.5" fill="var(--primary-action)" opacity="0.5" />
       </svg>
       <p class="font-semibold text-base mb-1" style="color:var(--text-color);">Aucune commande</p>
       <p class="text-sm" style="color:var(--text-color); opacity:0.5;">Ajoutez votre premi√®re commande pour commencer</p>
      </div>
     </main>
    </div>
   </div>
  </div>
  <script>
    // ---- State ----
    let allSuppliers = [];
    let allOrders = [];
    let currentTab = 'suppliers';
    let supplierSearchQuery = '';
    let orderSearchQuery = '';
    let orderStatusFilter = '';

    // ---- Default Config ----
    const defaultConfig = {
      background_color: '#0f1729',
      surface_color: '#1a2540',
      text_color: '#e8ecf4',
      primary_action: '#f0943a',
      secondary_action: '#3b5998',
      font_family: 'DM Sans',
      font_size: 15,
      page_title: 'Gestion Fournisseurs & Commandes',
      subtitle_text: 'G√©rez vos contacts et suivez vos commandes en un seul endroit',
      add_supplier_text: 'Ajouter un fournisseur',
      add_order_text: 'Ajouter une commande'
    };

    // ---- Element SDK ----
    function applyConfig(config) {
      const c = { ...defaultConfig, ...config };
      const root = document.documentElement.style;
      root.setProperty('--bg-color', c.background_color);
      root.setProperty('--surface-color', c.surface_color);
      root.setProperty('--text-color', c.text_color);
      root.setProperty('--primary-action', c.primary_action);
      root.setProperty('--secondary-action', c.secondary_action);

      document.getElementById('app-wrapper').style.background = c.background_color;

      const font = c.font_family || defaultConfig.font_family;
      const baseFontStack = "'DM Sans', sans-serif";
      document.body.style.fontFamily = `'${font}', ${baseFontStack}`;

      const baseSize = c.font_size || defaultConfig.font_size;
      document.getElementById('page-title').style.fontSize = `${baseSize * 2.1}px`;
      document.getElementById('subtitle-text').style.fontSize = `${baseSize}px`;

      document.getElementById('page-title').textContent = c.page_title || defaultConfig.page_title;
      document.getElementById('subtitle-text').textContent = c.subtitle_text || defaultConfig.subtitle_text;
      document.getElementById('add-supplier-label').textContent = c.add_supplier_text || defaultConfig.add_supplier_text;
      document.getElementById('add-order-label').textContent = c.add_order_text || defaultConfig.add_order_text;

      renderSupplierList();
      renderOrderList();
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => { applyConfig(config); },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => config.primary_action || defaultConfig.primary_action,
              set: (v) => { config.primary_action = v; window.elementSdk.setConfig({ primary_action: v }); }
            },
            {
              get: () => config.secondary_action || defaultConfig.secondary_action,
              set: (v) => { config.secondary_action = v; window.elementSdk.setConfig({ secondary_action: v }); }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ['page_title', config.page_title || defaultConfig.page_title],
          ['subtitle_text', config.subtitle_text || defaultConfig.subtitle_text],
          ['add_supplier_text', config.add_supplier_text || defaultConfig.add_supplier_text],
          ['add_order_text', config.add_order_text || defaultConfig.add_order_text]
        ])
      });
    }

    // ---- Data SDK ----
    const dataHandler = {
      onDataChanged(data) {
        allSuppliers = data.filter(d => d.type === 'supplier');
        allOrders = data.filter(d => d.type === 'order');
        populateSupplierSelect();
        renderSupplierList();
        renderOrderList();
        updateCounts();
      }
    };

    (async () => {
      if (window.dataSdk) {
        const res = await window.dataSdk.init(dataHandler);
        if (!res.isOk) console.error('Data SDK init failed');
      }
    })();

    // ---- Tab Switching ----
    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('suppliers-section').style.display = tab === 'suppliers' ? 'block' : 'none';
      document.getElementById('orders-section').style.display = tab === 'orders' ? 'block' : 'none';
      document.getElementById('tab-suppliers').style.borderBottomColor = tab === 'suppliers' ? 'var(--primary-action)' : 'transparent';
      document.getElementById('tab-suppliers').style.color = tab === 'suppliers' ? 'var(--primary-action)' : 'var(--text-color)';
      document.getElementById('tab-suppliers').style.opacity = tab === 'suppliers' ? '1' : '0.6';
      document.getElementById('tab-orders').style.borderBottomColor = tab === 'orders' ? 'var(--primary-action)' : 'transparent';
      document.getElementById('tab-orders').style.color = tab === 'orders' ? 'var(--primary-action)' : 'var(--text-color)';
      document.getElementById('tab-orders').style.opacity = tab === 'orders' ? '1' : '0.6';
    }

    // ---- Supplier Form ----
    function toggleSupplierForm() {
      const panel = document.getElementById('supplier-form-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') {
        panel.classList.add('fade-up');
        document.getElementById('s-name').focus();
      }
      hideSupplierMessages();
    }

    async function handleSupplierSubmit(e) {
      e.preventDefault();
      hideSupplierMessages();

      if (allSuppliers.length >= 999) {
        showSupplierError('Limite de 999 fournisseurs atteinte.');
        return;
      }

      const name = document.getElementById('s-name').value.trim();
      if (!name) { showSupplierError('Le nom est obligatoire.'); return; }

      setSupplierSubmitting(true);
      const record = {
        type: 'supplier',
        name,
        contact: document.getElementById('s-contact').value.trim(),
        email: document.getElementById('s-email').value.trim(),
        phone: document.getElementById('s-phone').value.trim(),
        category: document.getElementById('s-category').value.trim(),
        notes: document.getElementById('s-notes').value.trim(),
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(record);
      setSupplierSubmitting(false);

      if (result.isOk) {
        showSupplierSuccess('Fournisseur ajout√© !');
        document.getElementById('supplier-form').reset();
        setTimeout(() => { toggleSupplierForm(); }, 800);
      } else {
        showSupplierError('Erreur. R√©essayez.');
      }
    }

    // ---- Order Form ----
    function toggleOrderForm() {
      const panel = document.getElementById('order-form-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') {
        panel.classList.add('fade-up');
        document.getElementById('o-supplier').focus();
      }
      hideOrderMessages();
    }

    async function handleOrderSubmit(e) {
      e.preventDefault();
      hideOrderMessages();

      if (allOrders.length >= 999) {
        showOrderError('Limite de 999 commandes atteinte.');
        return;
      }

      const supplierId = document.getElementById('o-supplier').value;
      if (!supplierId) { showOrderError('S√©lectionnez un fournisseur.'); return; }

      const article = document.getElementById('o-article').value.trim();
      if (!article) { showOrderError('Entrez un article.'); return; }

      const quantity = parseFloat(document.getElementById('o-quantity').value);
      const price = parseFloat(document.getElementById('o-price').value);
      const date = document.getElementById('o-date').value;
      if (!date) { showOrderError('S√©lectionnez une date.'); return; }

      setOrderSubmitting(true);
      const record = {
        type: 'order',
        supplier_id: supplierId,
        article_name: article,
        quantity,
        unit_price: price,
        order_date: date,
        status: document.getElementById('o-status').value,
        name: article,
        contact: '',
        email: '',
        phone: '',
        category: '',
        notes: '',
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(record);
      setOrderSubmitting(false);

      if (result.isOk) {
        showOrderSuccess('Commande ajout√©e !');
        document.getElementById('order-form').reset();
        setTimeout(() => { toggleOrderForm(); }, 800);
      } else {
        showOrderError('Erreur. R√©essayez.');
      }
    }

    // ---- Populate Supplier Select ----
    function populateSupplierSelect() {
      const select = document.getElementById('o-supplier');
      const current = select.value;
      select.innerHTML = '<option value="">-- S√©lectionner un fournisseur --</option>';
      allSuppliers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.__backendId;
        opt.textContent = s.name;
        select.appendChild(opt);
      });
      select.value = current;
    }

    // ---- Render Suppliers ----
    function renderSupplierList() {
      const container = document.getElementById('supplier-list');
      const emptyState = document.getElementById('suppliers-empty');
      const filtered = getFilteredSuppliers();

      const existingCards = new Map();
      container.querySelectorAll('.supplier-card').forEach(el => {
        existingCards.set(el.dataset.id, el);
      });

      if (filtered.length === 0) {
        existingCards.forEach(el => el.remove());
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      const ids = new Set(filtered.map(s => s.__backendId));
      existingCards.forEach((el, id) => { if (!ids.has(id)) el.remove(); });

      filtered.forEach((supplier, i) => {
        const id = supplier.__backendId;
        if (existingCards.has(id)) {
          updateSupplierCard(existingCards.get(id), supplier);
        } else {
          const card = createSupplierCard(supplier, i);
          container.appendChild(card);
        }
      });
    }

    function createSupplierCard(s, index) {
      const card = document.createElement('div');
      card.className = 'card supplier-card slide-in rounded-xl p-4 sm:p-5';
      card.dataset.id = s.__backendId;
      card.style.cssText = `background:var(--surface-color); border:1px solid rgba(255,255,255,0.06); animation-delay:${index * 0.04}s;`;
      updateSupplierCard(card, s);
      return card;
    }

    function updateSupplierCard(card, s) {
      const initial = (s.name || '?')[0].toUpperCase();
      const categoryTag = s.category
        ? `<span class="inline-block px-2.5 py-0.5 rounded-full text-xs font-medium" style="background:var(--secondary-action); color:var(--text-color);">${esc(s.category)}</span>`
        : '';
      const details = [];
      if (s.contact) details.push(`<span>üë§ ${esc(s.contact)}</span>`);
      if (s.email) details.push(`<span>‚úâÔ∏è ${esc(s.email)}</span>`);
      if (s.phone) details.push(`<span>üìû ${esc(s.phone)}</span>`);
      const notesHTML = s.notes ? `<p class="mt-2 text-xs" style="color:var(--text-color); opacity:0.5;">üí¨ ${esc(s.notes)}</p>` : '';

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3 min-w-0 flex-1">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm"
              style="background:var(--primary-action); color:var(--bg-color);">
              ${initial}
            </div>
            <div class="min-w-0 flex-1">
              <div class="flex flex-wrap items-center gap-2 mb-1">
                <h3 class="font-semibold text-sm truncate" style="color:var(--text-color); margin:0;">${esc(s.name)}</h3>
                ${categoryTag}
              </div>
              <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs" style="color:var(--text-color); opacity:0.6;">
                ${details.join('')}
              </div>
              ${notesHTML}
            </div>
          </div>
          <div class="supplier-card-actions flex items-center gap-2 flex-shrink-0">
            <button onclick="requestDeleteSupplier('${s.__backendId}')" class="p-2 rounded-lg" style="background:rgba(255,255,255,0.06);" title="Supprimer">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 5h8l-.6 7.5a1 1 0 01-1 .9H5.6a1 1 0 01-1-.9L4 5z" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3"/><path d="M3 4h10M6.5 4V3a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v1" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3" stroke-linecap="round"/></svg>
            </button>
          </div>
        </div>
      `;
    }

    function getFilteredSuppliers() {
      if (!supplierSearchQuery) return allSuppliers;
      return allSuppliers.filter(s =>
        (s.name || '').toLowerCase().includes(supplierSearchQuery) ||
        (s.contact || '').toLowerCase().includes(supplierSearchQuery) ||
        (s.category || '').toLowerCase().includes(supplierSearchQuery) ||
        (s.email || '').toLowerCase().includes(supplierSearchQuery)
      );
    }

    function filterSuppliers() {
      supplierSearchQuery = document.getElementById('supplier-search').value.toLowerCase().trim();
      renderSupplierList();
      updateCounts();
    }

    // ---- Render Orders ----
    function renderOrderList() {
      const container = document.getElementById('order-list');
      const emptyState = document.getElementById('orders-empty');
      const filtered = getFilteredOrders();

      const existingCards = new Map();
      container.querySelectorAll('.order-card').forEach(el => {
        existingCards.set(el.dataset.id, el);
      });

      if (filtered.length === 0) {
        existingCards.forEach(el => el.remove());
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      const ids = new Set(filtered.map(o => o.__backendId));
      existingCards.forEach((el, id) => { if (!ids.has(id)) el.remove(); });

      filtered.forEach((order, i) => {
        const id = order.__backendId;
        if (existingCards.has(id)) {
          updateOrderCard(existingCards.get(id), order);
        } else {
          const card = createOrderCard(order, i);
          container.appendChild(card);
        }
      });
    }

    function createOrderCard(o, index) {
      const card = document.createElement('div');
      card.className = 'card order-card slide-in rounded-xl p-4 sm:p-5';
      card.dataset.id = o.__backendId;
      card.style.cssText = `background:var(--surface-color); border:1px solid rgba(255,255,255,0.06); animation-delay:${index * 0.04}s;`;
      updateOrderCard(card, o);
      return card;
    }

    function updateOrderCard(card, o) {
      const supplier = allSuppliers.find(s => s.__backendId === o.supplier_id);
      const supplierName = supplier ? supplier.name : 'Fournisseur supprim√©';
      const total = (o.quantity * o.unit_price).toFixed(2);
      const statusMap = { pending: '‚è≥ En attente', confirmed: '‚úì Confirm√©e', shipped: 'üì¶ Exp√©di√©e', delivered: '‚úì‚úì Livr√©e' };
      const statusText = statusMap[o.status] || o.status;

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="font-semibold text-sm" style="color:var(--text-color); margin:0;">${esc(o.article_name)}</h3>
              <span class="status-badge status-${o.status}">${statusText}</span>
            </div>
            <div class="text-xs" style="color:var(--text-color); opacity:0.6;">
              <p style="margin:4px 0;">üì¶ Fournisseur: ${esc(supplierName)}</p>
              <p style="margin:4px 0;">üìä Quantit√©: ${o.quantity} √ó ${o.unit_price.toFixed(2)}‚Ç¨ = <span style="color:var(--primary-action); font-weight:600;">${total}‚Ç¨</span></p>
              <p style="margin:4px 0;">üìÖ ${new Date(o.order_date).toLocaleDateString('fr-FR')}</p>
            </div>
          </div>
          <div class="order-card-actions flex items-center gap-2 flex-shrink-0">
            <select onchange="updateOrderStatus('${o.__backendId}', this.value); this.value='${o.status}';" class="form-input rounded px-2 py-1 text-xs"
              style="background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);">
              <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Attente</option>
              <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>Confirm√©e</option>
              <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>Exp√©di√©e</option>
              <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Livr√©e</option>
            </select>
            <button onclick="requestDeleteOrder('${o.__backendId}')" class="p-2 rounded-lg" style="background:rgba(255,255,255,0.06);" title="Supprimer">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 5h8l-.6 7.5a1 1 0 01-1 .9H5.6a1 1 0 01-1-.9L4 5z" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3"/><path d="M3 4h10M6.5 4V3a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v1" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3" stroke-linecap="round"/></svg>
            </button>
          </div>
        </div>
      `;
    }

    function getFilteredOrders() {
      let filtered = allOrders;
      if (orderStatusFilter) {
        filtered = filtered.filter(o => o.status === orderStatusFilter);
      }
      if (orderSearchQuery) {
        filtered = filtered.filter(o =>
          (o.article_name || '').toLowerCase().includes(orderSearchQuery) ||
          (getSupplierName(o.supplier_id) || '').toLowerCase().includes(orderSearchQuery)
        );
      }
      return filtered;
    }

    function getSupplierName(id) {
      const s = allSuppliers.find(s => s.__backendId === id);
      return s ? s.name : '';
    }

    function filterOrders() {
      orderSearchQuery = document.getElementById('order-search').value.toLowerCase().trim();
      orderStatusFilter = document.getElementById('status-filter').value;
      renderOrderList();
      updateCounts();
    }

    async function updateOrderStatus(orderId, newStatus) {
      const order = allOrders.find(o => o.__backendId === orderId);
      if (!order) return;
      const updated = { ...order, status: newStatus };
      const result = await window.dataSdk.update(updated);
      if (!result.isOk) console.error('Update failed');
    }

    // ---- Delete Handlers ----
    function requestDeleteSupplier(id) {
      const supplier = allSuppliers.find(s => s.__backendId === id);
      if (!supplier) return;
      const card = document.querySelector(`[data-id="${id}"]`);
      if (!card) return;
      const actions = card.querySelector('.supplier-card-actions');
      actions.innerHTML = `
        <span style="color:var(--text-color); opacity:0.7; font-size:12px;">Supprimer ?</span>
        <button onclick="confirmDeleteSupplier('${id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background:#dc2626; color:#fff;">Oui</button>
        <button onclick="cancelDeleteSupplier('${id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background:rgba(255,255,255,0.1); color:var(--text-color);">Non</button>
      `;
    }

    function cancelDeleteSupplier(id) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        const supplier = allSuppliers.find(s => s.__backendId === id);
        if (supplier) {
          const actions = card.querySelector('.supplier-card-actions');
          actions.innerHTML = `<button onclick="requestDeleteSupplier('${id}')" class="p-2 rounded-lg" style="background:rgba(255,255,255,0.06);"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 5h8l-.6 7.5a1 1 0 01-1 .9H5.6a1 1 0 01-1-.9L4 5z" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3"/><path d="M3 4h10M6.5 4V3a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v1" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3" stroke-linecap="round"/></svg></button>`;
        }
      }
    }

    async function confirmDeleteSupplier(id) {
      const supplier = allSuppliers.find(s => s.__backendId === id);
      if (!supplier) return;
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        const actions = card.querySelector('.supplier-card-actions');
        actions.innerHTML = '<span class="text-xs" style="color:var(--text-color); opacity:0.5;">Suppression...</span>';
      }
      const result = await window.dataSdk.delete(supplier);
      if (!result.isOk && card) {
        cancelDeleteSupplier(id);
      }
    }

    function requestDeleteOrder(id) {
      const order = allOrders.find(o => o.__backendId === id);
      if (!order) return;
      const card = document.querySelector(`[data-id="${id}"]`);
      if (!card) return;
      const actions = card.querySelector('.order-card-actions');
      actions.innerHTML = `
        <span style="color:var(--text-color); opacity:0.7; font-size:12px;">Supprimer ?</span>
        <button onclick="confirmDeleteOrder('${id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background:#dc2626; color:#fff;">Oui</button>
        <button onclick="cancelDeleteOrder('${id}')" class="px-3 py-1 rounded-lg text-xs font-semibold" style="background:rgba(255,255,255,0.1); color:var(--text-color);">Non</button>
      `;
    }

    function cancelDeleteOrder(id) {
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        const order = allOrders.find(o => o.__backendId === id);
        if (order) {
          const actions = card.querySelector('.order-card-actions');
          actions.innerHTML = `
            <select onchange="updateOrderStatus('${id}', this.value); this.value='${order.status}';" class="form-input rounded px-2 py-1 text-xs"
              style="background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); color:var(--text-color);">
              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Attente</option>
              <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirm√©e</option>
              <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Exp√©di√©e</option>
              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livr√©e</option>
            </select>
            <button onclick="requestDeleteOrder('${id}')" class="p-2 rounded-lg" style="background:rgba(255,255,255,0.06);"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 5h8l-.6 7.5a1 1 0 01-1 .9H5.6a1 1 0 01-1-.9L4 5z" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3"/><path d="M3 4h10M6.5 4V3a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v1" stroke="var(--text-color)" stroke-opacity="0.5" stroke-width="1.3" stroke-linecap="round"/></svg></button>
          `;
        }
      }
    }

    async function confirmDeleteOrder(id) {
      const order = allOrders.find(o => o.__backendId === id);
      if (!order) return;
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        const actions = card.querySelector('.order-card-actions');
        actions.innerHTML = '<span class="text-xs" style="color:var(--text-color); opacity:0.5;">Suppression...</span>';
      }
      const result = await window.dataSdk.delete(order);
      if (!result.isOk && card) {
        cancelDeleteOrder(id);
      }
    }

    // ---- Helpers ----
    function updateCounts() {
      const suppCount = getFilteredSuppliers().length;
      const ordCount = getFilteredOrders().length;
      document.getElementById('supplier-count').textContent = `${suppCount} fournisseur${suppCount !== 1 ? 's' : ''}`;
      document.getElementById('order-count').textContent = `${ordCount} commande${ordCount !== 1 ? 's' : ''}`;
    }

    function setSupplierSubmitting(loading) {
      const btn = document.getElementById('supplier-submit-btn');
      btn.disabled = loading;
      btn.style.opacity = loading ? '0.7' : '1';
      document.getElementById('supplier-submit-label').textContent = loading ? 'Enregistrement' : 'Enregistrer';
      document.getElementById('supplier-submit-spinner').style.display = loading ? 'inline-flex' : 'none';
    }

    function setOrderSubmitting(loading) {
      const btn = document.getElementById('order-submit-btn');
      btn.disabled = loading;
      btn.style.opacity = loading ? '0.7' : '1';
      document.getElementById('order-submit-label').textContent = loading ? 'Enregistrement' : 'Enregistrer';
      document.getElementById('order-submit-spinner').style.display = loading ? 'inline-flex' : 'none';
    }

    function showSupplierError(msg) {
      document.getElementById('supplier-form-error').textContent = msg;
      document.getElementById('supplier-form-error').style.display = 'block';
    }
    function showSupplierSuccess(msg) {
      document.getElementById('supplier-form-success').textContent = msg;
      document.getElementById('supplier-form-success').style.display = 'block';
    }
    function hideSupplierMessages() {
      document.getElementById('supplier-form-error').style.display = 'none';
      document.getElementById('supplier-form-success').style.display = 'none';
    }

    function showOrderError(msg) {
      document.getElementById('order-form-error').textContent = msg;
      document.getElementById('order-form-error').style.display = 'block';
    }
    function showOrderSuccess(msg) {
      document.getElementById('order-form-success').textContent = msg;
      document.getElementById('order-form-success').style.display = 'block';
    }
    function hideOrderMessages() {
      document.getElementById('order-form-error').style.display = 'none';
      document.getElementById('order-form-success').style.display = 'none';
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd492a7b1af8a3d',t:'MTc3MDk4ODI5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
