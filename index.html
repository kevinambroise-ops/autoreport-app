<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AUTOREPORT - Gestion de S√©curit√©</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      box-sizing: border-box;
    }

    .app-container {
      height: 100%;
      width: 100%;
      display: flex;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #333;
    }

    /* LOGIN SCREEN */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .login-screen.hidden {
      display: none;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-logo {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #1a2a47;
      margin-bottom: 10px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 30px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .login-form input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .login-form input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .login-btn {
      padding: 12px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      color: #ef4444;
      font-size: 13px;
      margin-top: 10px;
      display: none;
    }

    .login-error.show {
      display: block;
    }

    .login-info {
      background: #dbeafe;
      padding: 12px;
      border-radius: 6px;
      margin-top: 20px;
      font-size: 12px;
      color: #1e40af;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    /* EMERGENCY BANNER */
    .emergency-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #dc2626, #ef4444);
      color: white;
      padding: 16px;
      text-align: center;
      z-index: 1500;
      display: none;
      animation: emergencyPulse 1s infinite;
    }

    .emergency-banner.active {
      display: block;
    }

    @keyframes emergencyPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }

    .emergency-banner-content {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .emergency-blink {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      animation: blink 0.5s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* MAIN APP */
    .sidebar {
      width: 280px;
      background: #1a2a47;
      padding: 25px 0;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }

    .logo-section {
      padding: 0 20px 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .logo-title {
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .logo-subtitle {
      color: #a0aec0;
      font-size: 12px;
    }

    .company-info {
      padding: 0 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 15px;
    }

    .company-label {
      font-size: 11px;
      color: #a0aec0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .company-name {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      margin-top: 5px;
    }

    .company-expiry {
      font-size: 12px;
      color: #fbbf24;
      margin-top: 8px;
    }

    .nav-item {
      padding: 14px 20px;
      color: #a0aec0;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border-left-color: #3b82f6;
    }

    .admin-badge {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      margin-left: 8px;
      font-weight: 700;
    }

    .alert-badge {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 700;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: white;
      padding: 20px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      color: #1a2a47;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 14px;
      color: #666;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      background: #f8f9fa;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .form-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-emergency {
      background: #dc2626;
      color: white;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 700;
      animation: pulse 1s infinite;
    }

    .btn-emergency:hover {
      background: #991b1b;
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .records-list {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .record-item {
      padding: 18px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .record-item:hover {
      background: #f9fafb;
    }

    .record-item.expired {
      opacity: 0.6;
      background: #f3f4f6;
    }

    .record-info {
      flex: 1;
    }

    .record-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .record-meta {
      font-size: 13px;
      color: #6b7280;
      display: flex;
      gap: 15px;
    }

    .severity-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .severity-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .severity-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .severity-low {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .status-open {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-closed {
      background: #dcfce7;
      color: #166534;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-expired {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status-warning {
      background: #fed7aa;
      color: #92400e;
    }

    .status-emergency {
      background: #fee2e2;
      color: #991b1b;
      animation: pulse 1s infinite;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 22px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-left: 4px solid #3b82f6;
    }

    .stat-card.incidents {
      border-left-color: #ef4444;
    }

    .stat-card.patrols {
      border-left-color: #f59e0b;
    }

    .stat-card.reports {
      border-left-color: #10b981;
    }

    .stat-card.codes {
      border-left-color: #8b5cf6;
    }

    .stat-card.alerts {
      border-left-color: #dc2626;
    }

    .stat-label {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
    }

    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 20px;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 15px;
      height: 250px;
      margin-bottom: 15px;
    }

    .bar {
      flex: 1;
      background: linear-gradient(to top, #3b82f6, #60a5fa);
      border-radius: 6px 6px 0 0;
      min-height: 20px;
      transition: all 0.3s;
      position: relative;
    }

    .bar:hover {
      opacity: 0.8;
    }

    .bar-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
    }

    .bar-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .report-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .report-heading {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      background: #f3f4f6;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      border-bottom: 1px solid #e5e7eb;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }

    .table tbody tr:hover {
      background: #f9fafb;
    }

    .table tbody tr.expired {
      opacity: 0.6;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .access-expired {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #dc2626;
    }

    .code-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .code-card.expired {
      border-left-color: #d1d5db;
      opacity: 0.7;
    }

    .code-card.warning {
      border-left-color: #f59e0b;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .code-value {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 16px;
      color: #1f2937;
      letter-spacing: 1px;
    }

    .code-company {
      color: #6b7280;
      font-size: 14px;
      margin-top: 4px;
    }

    .code-details {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .code-detail-item {
      display: flex;
      flex-direction: column;
    }

    .code-detail-label {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .code-detail-value {
      color: #1f2937;
      font-weight: 600;
    }

    .code-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .emergency-card {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #dc2626;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .emergency-card-title {
      font-weight: 700;
      color: #991b1b;
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .emergency-card-content {
      color: #7f1d1d;
      font-size: 14px;
      line-height: 1.6;
    }

    .emergency-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .emergency-detail {
      background: rgba(220, 38, 38, 0.1);
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
    }

    .emergency-detail-label {
      font-weight: 600;
      color: #991b1b;
    }

    .emergency-detail-value {
      color: #7f1d1d;
      margin-top: 4px;
    }

    .response-counter {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
      border: 2px solid #dc2626;
    }

    .response-timer {
      font-size: 32px;
      font-weight: 700;
      color: #dc2626;
      font-family: 'Courier New', monospace;
    }

    .response-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }

    .zone-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .zone-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .zone-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .zone-card.selected {
      background: #dbeafe;
      border-color: #3b82f6;
    }

    .zone-emoji {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .zone-name {
      font-weight: 600;
      font-size: 13px;
      color: #1f2937;
    }

    .zone-count {
      font-size: 11px;
      color: #6b7280;
      margin-top: 5px;
    }

    .intervention-list {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .intervention-item {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      border-left: 4px solid #dc2626;
    }

    .intervention-item.responded {
      border-left-color: #10b981;
    }

    .intervention-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .intervention-title {
      font-weight: 700;
      color: #1f2937;
    }

    .intervention-meta {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .intervention-response {
      background: #dcfce7;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 13px;
      color: #166534;
    }

    .intervention-response-time {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-top: 6px;
      color: #4b5563;
    }

    .response-time-badge {
      background: #d1fae5;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      color: #065f46;
    }

    .recommendation-item {
      background: linear-gradient(135deg, #fff7ed 0%, #fefce8 100%);
      padding: 18px;
      border-radius: 8px;
      border-left: 4px solid #f59e0b;
      margin-bottom: 12px;
      border-right: 1px solid #fbbf24;
    }

    .recommendation-item.high-priority {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-left-color: #ef4444;
    }

    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .recommendation-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .recommendation-priority {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .recommendation-priority.high {
      background: #fee2e2;
      color: #991b1b;
    }

    .recommendation-priority.medium {
      background: #fef3c7;
      color: #92400e;
    }

    .recommendation-priority.low {
      background: #d1fae5;
      color: #065f46;
    }

    .recommendation-text {
      color: #374151;
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .recommendation-meta {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      gap: 15px;
    }

    .recommendation-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .recommendation-company {
      background: white;
      padding: 18px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      margin-bottom: 15px;
    }

    .recommendation-company-title {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .emergency-share-modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .emergency-share-title {
      font-size: 22px;
      font-weight: 700;
      color: #991b1b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #dc2626;
    }

    .qr-code {
      width: 250px;
      height: 250px;
      margin: 0 auto;
      background: white;
      padding: 10px;
      border-radius: 6px;
    }

    .share-link-section {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .share-link-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .share-link-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .share-link-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      background: white;
      cursor: text;
      word-break: break-all;
      overflow-wrap: break-word;
    }

    .share-link-copy {
      padding: 10px 15px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }

    .share-link-copy:hover {
      background: #2563eb;
    }

    .share-link-copy.copied {
      background: #10b981;
    }

    .share-methods {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .share-method-btn {
      padding: 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
    }

    .share-method-btn:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }

    .alert-countdown {
      font-size: 13px;
      color: #6b7280;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
    }

    .alert-status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1s infinite;
      margin-right: 5px;
    }

    .incident-pattern {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 13px;
      color: #374151;
    }

    .incident-count {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- LOGIN SCREEN -->
  <div class="login-screen" id="login-screen">
   <div class="login-card">
    <div class="login-logo">
     üõ°Ô∏è
    </div>
    <div class="login-title">
     AUTOREPORT
    </div>
    <div class="login-subtitle">
     Plateforme de S√©curit√©
    </div>
    <form class="login-form" id="login-form"><input type="text" id="access-code-input" placeholder="Entrez votre code d'acc√®s" autocomplete="off" required> <button type="submit" class="login-btn" id="login-btn">AccÔøΩÔøΩder</button>
     <div class="login-error" id="login-error"></div>
    </form>
    <div class="login-info">
     üí° Entrez le code d'acc√®s fourni par votre administrateur
   <html>
 <head>
  <style>body { box-sizing: border-box; }</style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 15px; cursor: pointer;" onclick="toggleAdminLogin()">Connexion Admin</button>
  <form class="login-form" id="admin-login-form" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;" onsubmit="handleAdminLogin(event)">
   <h3 style="font-size: 14px; margin-bottom: 15px; color: #333; text-align: center;">Acc√®s Administrateur</h3><input type="password" id="admin-password-input" placeholder="Mot de passe administrateur" autocomplete="off" required> <button type="submit" class="login-btn">Se Connecter</button>
   <div class="login-error" id="admin-login-error"></div>
  </form>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ccc3f1f35b08a42',t:'MTc3MDkwMDk5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
  </div><!-- EMERGENCY BANNER -->
  <div class="emergency-banner" id="emergency-banner">
   <div class="emergency-banner-content"><span class="emergency-blink"></span> üö® ALERTE URGENTE - INTERVENTION REQUISE IMM√âDIATEMENT <span class="emergency-blink"></span>
   </div>
  </div><!-- MAIN APP -->
  <div class="app-container" id="app-container" style="display: none;">
   <div class="sidebar">
    <div class="logo-section">
     <div class="logo-title">
      üõ°Ô∏è AUTOREPORT
     </div>
     <div class="logo-subtitle">
      Gestion de S√©curit√©
     </div>
    </div>
    <div class="company-info">
     <div class="company-label">
      Entreprise
     </div>
     <div class="company-name" id="company-name">
      Chargement...
     </div>
     <div class="company-expiry" id="access-expiry">
      Acc√®s jusqu'au: --
     </div>
    </div>
    <div class="nav-item active" data-section="dashboard">
     üìä Tableau de bord
    </div>
    <div class="nav-item" data-section="alerts">
     üö® Alertes Urgentes <span class="alert-badge" id="alert-count" style="display: none;">0</span>
    </div>
    <div class="nav-item" data-section="incidents">
     ÔøΩÔøΩ Incidents
    </div>
    <div class="nav-item" data-section="patrols">
     üëÆ Patrouilles
    </div>
    <div class="nav-item" data-section="reports">
     üìã Rapports
    </div>
    <div class="nav-item" data-section="admin" id="admin-nav">
     ‚öôÔ∏è Admin<span class="admin-badge">ADMIN</span>
    </div>
    <div style="margin-top: auto; padding: 20px;"><button class="logout-btn" onclick="logout()">Se D√©connecter</button>
    </div>
   </div>
   <div class="main-content">
    <div class="header">
     <div class="header-title" id="section-title">
      Tableau de bord
     </div>
     <div class="header-info"><span id="current-date"></span>
     </div>
    </div>
    <div class="content"><!-- Dashboard Section -->
     <div class="section active" id="dashboard" style="overflow-y: auto;">
      <div id="access-warning"></div>
      <div class="dashboard-grid">
       <div class="stat-card incidents">
        <div class="stat-label">
         Incidents Total
        </div>
        <div class="stat-value" id="total-incidents">
         0
        </div>
       </div>
       <div class="stat-card patrols">
        <div class="stat-label">
         Patrouilles
        </div>
        <div class="stat-value" id="total-patrols">
         0
        </div>
       </div>
       <div class="stat-card reports">
        <div class="stat-label">
         Incidents R√©solus
        </div>
        <div class="stat-value" id="total-resolved">
         0
        </div>
       </div>
       <div class="stat-card alerts" id="stat-alerts-card">
        <div class="stat-label">
         Alertes Urgentes
        </div>
        <div class="stat-value" id="total-alerts">
         0
        </div>
       </div>
      </div>
      <div class="chart-container">
       <div class="chart-title">
        Incidents par S√©v√©rit√©
       </div>
       <div class="bar-chart" id="severity-chart"></div>
      </div>
      <div class="chart-container">
       <div class="chart-title">
        Incidents par Localisation (Top 5)
       </div>
       <div class="bar-chart" id="location-chart"></div>
      </div>
      <div class="report-section">
       <div class="report-heading">
        Incidents R√©cents
       </div>
       <div id="recent-incidents"></div>
      </div>
      <div class="report-section">
       <div class="report-heading">
        üí° Recommandations Pr√©ventives
       </div>
       <div id="recommendations-dashboard"></div>
      </div>
     </div><!-- Alerts Section -->
     <div class="section" id="alerts">
      <div class="form-container">
       <h3 style="margin-bottom: 20px; color: #1f2937;">üö® D√©clencher une Alerte Urgente</h3>
       <form id="alert-form">
        <div class="form-row">
         <div class="form-group"><label for="alert-zone">Zone de S√©curit√©</label> <select id="alert-zone" required> <option value="">S√©lectionner une zone...</option> <option value="entrance">üö™ Entr√©e Principale</option> <option value="storage">üì¶ Zone de Stockage</option> <option value="office">üè¢ Bureau</option> <option value="parking">üöó Parking</option> <option value="perimeter">üîí P√©rim√®tre Ext√©rieur</option> <option value="server">üñ•Ô∏è Salle Serveur</option> <option value="other">üìç Autre Zone</option> </select>
         </div>
         <div class="form-group"><label for="alert-type">Type d'Alerte</label> <select id="alert-type" required> <option value="">S√©lectionner...</option> <option value="intrusion">üî¥ Intrusion D√©tect√©e</option> <option value="break_in">üî¥ Tentative d'Effraction</option> <option value="theft">üí∞ Vol/Tentative de Vol</option> <option value="sabotage">‚ö° Sabotage/Vandalisme</option> <option value="accident">üÜò Accident/Blessure</option> <option value="fire">üî• Alarme Incendie</option> <option value="medical">üè• Urgence M√©dicale</option> <option value="suspicious">üëÅÔ∏è ActivitÔøΩÔøΩ Suspecte</option> </select>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label for="alert-person">Personne Signalant</label> <input type="text" id="alert-person" placeholder="Votre nom ou ID" required>
         </div>
         <div class="form-group"><label for="alert-severity">S√©v√©rit√©</label> <select id="alert-severity" required> <option value="critical">üî¥ CRITIQUE - Danger Imm√©diat</option> <option value="high">üü† √âLEV√âE - Intervention Rapide</option> <option value="medium">üü° MOYENNE - Attention</option> </select>
         </div>
        </div>
        <div class="form-group"><label for="alert-description">Description D√©taill√©e</label> <textarea id="alert-description" placeholder="D√©crivez l'incident en d√©tail..." style="resize: vertical; min-height: 100px;" required></textarea>
        </div>
        <div style="display: flex; gap: 10px;"><button type="submit" class="btn btn-emergency" style="flex: 1;">üö® D√âCLENCHER L'ALERTE</button> <button type="button" class="btn btn-emergency" style="flex: 1; background: #0ea5e9;" onclick="shareEmergencyAlert()">üì± PARTAGER ALERTE</button>
        </div>
       </form>
      </div>
      <div class="report-section">
       <div class="report-heading">
        ÔøΩÔøΩ Historique des Alertes
       </div>
       <div id="alerts-list"></div>
      </div>
     </div><!-- Incidents Section -->
     <div class="section" id="incidents">
      <div class="form-container">
       <h3 style="margin-bottom: 20px; color: #1f2937;">Enregistrer un Incident</h3>
       <form id="incident-form">
        <div class="form-row">
         <div class="form-group"><label for="incident-date">Date</label> <input type="date" id="incident-date" required>
         </div>
         <div class="form-group"><label for="incident-time">Heure</label> <input type="time" id="incident-time" required>
         </div>
        </div>
        <div class="form-group"><label for="incident-title">Titre de l'Incident</label> <input type="text" id="incident-title" placeholder="Ex: Tentative de vol" required>
        </div>
        <div class="form-group"><label for="incident-location">Localisation</label> <input type="text" id="incident-location" placeholder="Ex: Zone A - Entr√©e principale" required>
        </div>
        <div class="form-row">
         <div class="form-group"><label for="incident-severity">S√©vÔøΩÔøΩrit√©</label> <select id="incident-severity" required> <option value="">S√©lectionner...</option> <option value="low">Faible</option> <option value="medium">Moyen</option> <option value="high">√âlev√©</option> </select>
         </div>
         <div class="form-group"><label for="incident-agent">Agent Responsable</label> <input type="text" id="incident-agent" placeholder="Nom de l'agent" required>
         </div>
        </div>
        <div class="form-group"><label for="incident-desc">Description D√©taill√©e</label> <textarea id="incident-desc" placeholder="D√©crivez l'incident en d√©tail..." style="resize: vertical; min-height: 100px;" required></textarea>
        </div>
        <div style="display: flex; gap: 10px;"><button type="submit" class="btn btn-primary" style="flex: 1;">Enregistrer l'Incident</button> <button type="button" class="btn btn-emergency" style="flex: 1;" onclick="requestHelpIncident()">üÜò DEMANDER DE L'AIDE</button>
        </div>
       </form>
      </div>
      <div class="records-list" id="incidents-list"></div>
     </div><!-- Patrols Section -->
     <div class="section" id="patrols">
      <div class="form-container">
       <h3 style="margin-bottom: 20px; color: #1f2937;">Enregistrer une Patrouille</h3>
       <form id="patrol-form">
        <div class="form-row">
         <div class="form-group"><label for="patrol-date">Date</label> <input type="date" id="patrol-date" required>
         </div>
         <div class="form-group"><label for="patrol-time">Heure</label> <input type="time" id="patrol-time" required>
         </div>
        </div>
        <div class="form-group"><label for="patrol-location">Zone de Patrouille</label> <input type="text" id="patrol-location" placeholder="Ex: Zone A, Zone B..." required>
        </div>
        <div class="form-group"><label for="patrol-agent">Agent Patrouilleur</label> <input type="text" id="patrol-agent" placeholder="Nom de l'agent" required>
        </div>
        <div class="form-group"><label for="patrol-notes">Observations</label> <textarea id="patrol-notes" placeholder="Notes et observations..." style="resize: vertical; min-height: 100px;"></textarea>
        </div>
        <div style="display: flex; gap: 10px;"><button type="submit" class="btn btn-primary" style="flex: 1;">Enregistrer la Patrouille</button> <button type="button" class="btn btn-emergency" style="flex: 1;" onclick="requestHelpPatrol()">üÜò DEMANDER DE L'AIDE</button>
        </div>
       </form>
      </div>
      <div class="records-list" id="patrols-list"></div>
     </div><!-- Reports Section -->
     <div class="section" id="reports">
      <div class="form-container">
       <h3 style="margin-bottom: 20px; color: #1f2937;">üìä Configuration des Destinataires</h3>
       <form id="recipients-form">
        <div class="form-row">
         <div class="form-group"><label for="recipient-name">Nom du Destinataire</label> <input type="text" id="recipient-name" placeholder="Ex: Directeur de S√©curit√©" required>
         </div>
         <div class="form-group"><label for="recipient-email">Email</label> <input type="email" id="recipient-email" placeholder="exemple@societe.com" required>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label for="recipient-phone">T√©l√©phone</label> <input type="tel" id="recipient-phone" placeholder="+33 6 XX XX XX XX">
         </div>
         <div class="form-group"><label for="recipient-role">Fonction/R√¥le</label> <input type="text" id="recipient-role" placeholder="Ex: Manager, Superviseur">
         </div>
        </div><button type="submit" class="btn btn-primary">‚ûï Ajouter Destinataire</button>
       </form>
      </div>
      <div class="report-section" id="recipients-list-container" style="display: none;">
       <div class="report-heading">
        üë• Destinataires Configur√©s
       </div>
       <div id="recipients-list"></div>
      </div>
      <div class="form-container" style="margin-top: 30px;">
       <h3 style="margin-bottom: 20px; color: #1f2937;">üìã G√©n√©rer et Envoyer un Rapport</h3>
       <div class="form-row">
        <div class="form-group"><label for="report-type">Type de Rapport</label> <select id="report-type"> <option value="daily">Journalier</option> <option value="monthly">Mensuel</option> <option value="annual">Annuel</option> </select>
        </div>
        <div class="form-group"><label for="report-month">P√©riode</label> <input type="month" id="report-month">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label for="report-recipient-select">Envoyer √†</label> <select id="report-recipient-select" required> <option value="">S√©lectionner un destinataire...</option> </select>
        </div>
        <div class="form-group"><label for="report-method">M√©thode d'Envoi</label> <select id="report-method"> <option value="email">ÔøΩÔøΩ Email</option> <option value="sms">üí¨ SMS</option> <option value="both">üìß Email + üí¨ SMS</option> </select>
        </div>
       </div>
       <div class="form-group"><label for="report-message">Message Personnel (optionnel)</label> <textarea id="report-message" placeholder="Ajoutez un message personnel au rapport..." style="resize: vertical; min-height: 80px;"></textarea>
       </div>
       <div style="display: flex; gap: 10px;"><button class="btn btn-primary" style="flex: 1;" onclick="generateReport()">üìä G√©n√©rer l'Aper√ßu</button> <button class="btn btn-primary" style="flex: 1; background: #10b981;" onclick="sendReport()">üì§ G√©n√©rer et Envoyer</button>
       </div>
      </div>
      <div id="report-content"></div>
     </div><!-- Admin Section -->
     <div class="section" id="admin">
      <div class="dashboard-grid">
       <div class="stat-card codes">
        <div class="stat-label">
         Codes Total
        </div>
        <div class="stat-value" id="admin-total-codes">
         0
        </div>
       </div>
       <div class="stat-card codes" style="border-left-color: #10b981;">
        <div class="stat-label">
         Codes Actifs
        </div>
        <div class="stat-value" id="admin-active-codes">
         0
        </div>
       </div>
       <div class="stat-card codes" style="border-left-color: #ef4444;">
        <div class="stat-label">
         Codes Expir√©s
        </div>
        <div class="stat-value" id="admin-expired-codes">
         0
        </div>
       </div>
      </div>
      <div class="form-container">
       <h3 style="margin-bottom: 20px; color: #1f2937;">‚ûï Cr√©er un Nouveau Code</h3>
       <form id="code-form">
        <div class="form-row">
         <div class="form-group"><label for="code-value">Code d'Acc√®s</label> <input type="text" id="code-value" placeholder="Ex: SEC2024-PARIS" required>
         </div>
         <div class="form-group"><label for="code-company">Entreprise</label> <input type="text" id="code-company" placeholder="Nom de l'entreprise" required>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label for="code-duration">Dur√©e (jours)</label> <input type="number" id="code-duration" placeholder="30" value="30" min="1" max="365" required>
         </div>
         <div class="form-group"><label for="code-created-by">Cr√©√© par</label> <input type="text" id="code-created-by" placeholder="Votre nom" required>
         </div>
        </div><button type="submit" class="btn btn-primary">Cr√©er le Code</button>
       </form>
      </div>
      <div class="report-section">
       <div class="report-heading">
        üìã Gestion des Codes
       </div>
       <div id="codes-list"></div>
      </div>
      <div class="report-section">
       <div class="report-heading">
        üìä Historique d'Utilisation
       </div>
       <table class="table" id="usage-table">
        <thead>
         <tr>
          <th>Code</th>
          <th>Entreprise</th>
          <th>Date/Heure Connexion</th>
          <th>Status</th>
         </tr>
        </thead>
        <tbody id="usage-tbody">
         <tr>
          <td colspan="4" style="text-align: center; color: #999;">Aucun historique</td>
         </tr>
        </tbody>
       </table>
      </div>
      <div class="report-section">
       <div class="report-heading">
        üîî Recommandations par Entreprise
       </div>
       <div id="recommendations-admin"></div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal -->
  <div class="modal-overlay" id="modal-overlay">
   <div class="modal-content">
    <div class="modal-title" id="modal-title">
     Modifier le Code
    </div>
    <form id="modal-form">
     <div class="form-group"><label for="modal-code-value">Code d'Acc√®s</label> <input type="text" id="modal-code-value" readonly style="background: #f3f4f6; cursor: not-allowed;">
     </div>
     <div class="form-group"><label for="modal-code-company">Entreprise</label> <input type="text" id="modal-code-company" required>
     </div>
     <div class="form-group"><label for="modal-code-expiry">Date d'Expiration</label> <input type="date" id="modal-code-expiry" required>
     </div>
     <div class="form-group"><label for="modal-code-active">Statut</label> <select id="modal-code-active"> <option value="true">Actif</option> <option value="false">Inactif</option> </select>
     </div>
     <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button> <button type="submit" class="btn btn-primary">Sauvegarder</button>
     </div>
    </form>
   </div>
  </div><!-- Emergency Share Modal -->
  <div class="modal-overlay" id="emergency-share-overlay">
   <div class="emergency-share-modal">
    <div class="emergency-share-title"><span class="alert-status-indicator"></span> üö® ALERTE URGENTE
    </div>
    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc2626;">
     <div style="font-weight: 600; color: #991b1b; margin-bottom: 5px;" id="share-alert-type">
      Type d'alerte
     </div>
     <div style="color: #7f1d1d; font-size: 13px;" id="share-alert-description">
      Description
     </div>
    </div>
    <div class="qr-container">
     <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px; font-weight: 600;">
      üì± CODE QR - Scanner pour acc√®s imm√©diat
     </div>
     <canvas id="qr-code-canvas" class="qr-code"></canvas>
    </div>
    <div class="share-link-section">
     <div class="share-link-label">
      üìû Coordonn√©es du Superviseur
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"><input type="tel" id="supervisor-phone" class="share-link-input" placeholder="Num√©ro de t√©l√©phone" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"> <input type="email" id="supervisor-email" class="share-link-input" placeholder="Adresse email" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
     </div>
    </div>
    <div class="share-link-section">
     <div class="share-link-label">
      üîó Lien d'acc√®s rapide
     </div>
     <div class="share-link-container"><input type="text" id="share-link-input" class="share-link-input" readonly> <button type="button" class="share-link-copy" onclick="copyShareLink()">üìã Copier</button>
     </div>
    </div>
    <div style="margin-bottom: 15px;">
     <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">
      üì≤ Partager par
     </div>
     <div class="share-methods"><button type="button" class="share-method-btn" onclick="shareVia('whatsapp')"> üí¨ WhatsApp </button> <button type="button" class="share-method-btn" onclick="shareVia('email')"> üìß Email </button> <button type="button" class="share-method-btn" onclick="shareVia('sms')"> üí¨ SMS </button>
     </div>
    </div>
    <div class="alert-countdown">
     ‚è±Ô∏è Alerte d√©clench√©e il y a: <span id="share-alert-time" style="font-family: 'Courier New', monospace; font-weight: 600; color: #ef4444;">0s</span>
    </div><button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeEmergencyShare()">Fermer</button>
   </div>
  </div><!-- Help Request Modal -->
  <div class="modal-overlay" id="help-request-overlay">
   <div class="emergency-share-modal">
    <div class="emergency-share-title"><span class="alert-status-indicator"></span> üÜò DEMANDE D'AIDE
    </div>
    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc2626;">
     <div style="font-weight: 600; color: #991b1b; margin-bottom: 10px;">
      ‚ö†Ô∏è VOUS DEMANDEZ DE L'AIDE D'URGENCE
     </div>
     <div style="color: #7f1d1d; font-size: 13px; line-height: 1.6;">
      Les superviseurs et gestionnaires ont √©t√© alert√©s de votre demande d'aide urgente. <br><strong>Statut:</strong> <span id="help-status" style="color: #dc2626; font-weight: 700;">üî¥ EN ATTENTE DE R√âPONSE</span> <br><strong>Temps √©coul√©:</strong> <span id="help-timer" style="font-family: 'Courier New', monospace; font-weight: 600;">0s</span>
     </div>
    </div>
    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
     <div style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">
      üìç Vos Informations
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
      <div>
       <div style="color: #6b7280; margin-bottom: 3px;">
        Zone/Localisation:
       </div>
       <div style="color: #1f2937; font-weight: 600;" id="help-location">
        --
       </div>
      </div>
      <div>
       <div style="color: #6b7280; margin-bottom: 3px;">
        Agent:
       </div>
       <div style="color: #1f2937; font-weight: 600;" id="help-agent">
        --
       </div>
      </div>
      <div>
       <div style="color: #6b7280; margin-bottom: 3px;">
        Date/Heure:
       </div>
       <div style="color: #1f2937; font-weight: 600;" id="help-datetime">
        --
       </div>
      </div>
      <div>
       <div style="color: #6b7280; margin-bottom: 3px;">
        Type:
       </div>
       <div style="color: #1f2937; font-weight: 600;" id="help-type">
        --
       </div>
      </div>
     </div>
    </div>
    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
     <div style="font-weight: 600; color: #1e40af; margin-bottom: 10px;">
      üöÄ Partager votre Position
     </div>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><button type="button" class="share-method-btn" onclick="shareHelpVia('whatsapp')" style="background: #25d366; color: white; border: none;"> üí¨ WhatsApp </button> <button type="button" class="share-method-btn" onclick="shareHelpVia('sms')" style="background: #0066cc; color: white; border: none;"> üí¨ SMS </button>
     </div>
    </div>
    <div style="margin-bottom: 15px;"><button type="button" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="cancelHelpRequest()">‚ùå Annuler la Demande</button> <button type="button" class="btn btn-primary" style="width: 100%;" onclick="closeHelpRequest()">Fermer</button>
    </div>
   </div>
  </div>
  <script>
    // AUTOREPORT v1.0 - Production Ready
    let allData = [];
    let currentSession = null;
    let isAdmin = false;
    let allCodes = [];
    let usageHistory = [];
    let activeAlert = null;
    let alertStartTime = null;
    let allRecipients = [];
    let reportData = null;
    let activeHelpRequest = null;
    let helpRequestStartTime = null;

    function closeHelpRequest() {
      document.getElementById('help-request-overlay').classList.remove('active');
      if (window.helpRequestTimerInterval) {
        clearInterval(window.helpRequestTimerInterval);
      }
    }

    async function cancelHelpRequest() {
      if (!activeHelpRequest) return;

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Annulation en cours...';
      btn.disabled = true;

      const result = await window.dataSdk.delete(activeHelpRequest);
      if (result.isOk) {
        showToast('‚úÖ Demande d\'aide annul√©e', 'success');
        activeHelpRequest = null;
        closeHelpRequest();
      } else {
        showToast('‚ùå Erreur lors de l\'annulation', 'error');
      }

      btn.textContent = originalText;
      btn.disabled = false;
    }

    function shareHelpVia(method) {
      if (!activeHelpRequest) return;

      const agentName = activeHelpRequest.agent_name || 'Agent';
      const location = activeHelpRequest.location || 'Zone inconnue';
      const type = activeHelpRequest.help_type || 'Demande d\'aide';

      const message = `üÜò DEMANDE D'AIDE URGENTE\n\nAgent: ${agentName}\nZone: ${location}\nType: ${type}\n\nURL acc√®s rapide: ${window.location.href}`;

      if (method === 'whatsapp') {
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank', 'noopener,noreferrer');
      } else if (method === 'sms') {
        const encodedMessage = encodeURIComponent(message);
        window.open(`sms:?body=${encodedMessage}`, '_blank');
      }
    }

    function updateHelpRequestTimer() {
      if (!helpRequestStartTime) {
        helpRequestStartTime = new Date();
      }

      const elapsed = Math.floor((new Date() - helpRequestStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      const timeStr = minutes > 0 
        ? `${minutes}m ${seconds}s`
        : `${seconds}s`;
      
      const timerEl = document.getElementById('help-timer');
      if (timerEl) {
        timerEl.textContent = timeStr;
      }
    }

    async function requestHelpIncident() {
      const title = document.getElementById('incident-title').value.trim();
      const location = document.getElementById('incident-location').value.trim();
      const date = document.getElementById('incident-date').value;
      const time = document.getElementById('incident-time').value;
      const agent = document.getElementById('incident-agent').value.trim();
      const desc = document.getElementById('incident-desc').value.trim();

      if (!title || !location || !date || !time || !agent || !desc) {
        showToast('‚ùå Veuillez remplir tous les champs avant de demander de l\'aide', 'error');
        return;
      }

      const helpRequest = {
        type: 'help_request',
        help_type: 'incident',
        incident_title: title,
        location: location,
        date: date,
        time: time,
        agent_name: agent,
        description: desc,
        timestamp: new Date().toISOString(),
        help_status: 'pending',
        severity: 'high'
      };

      const result = await window.dataSdk.create(helpRequest);
      if (result.isOk) {
        showToast('üÜò DEMANDE D\'AIDE ENVOY√âE - Superviseurs alert√©s!', 'success');
        activeHelpRequest = helpRequest;
        helpRequestStartTime = null;
        showHelpRequestModal(helpRequest);
      } else {
        showToast('‚ùå Erreur lors de l\'envoi de la demande', 'error');
      }
    }

    async function requestHelpPatrol() {
      const location = document.getElementById('patrol-location').value.trim();
      const date = document.getElementById('patrol-date').value;
      const time = document.getElementById('patrol-time').value;
      const agent = document.getElementById('patrol-agent').value.trim();
      const notes = document.getElementById('patrol-notes').value.trim();

      if (!location || !date || !time || !agent) {
        showToast('‚ùå Veuillez remplir les champs obligatoires avant de demander de l\'aide', 'error');
        return;
      }

      const helpRequest = {
        type: 'help_request',
        help_type: 'patrol',
        location: location,
        date: date,
        time: time,
        agent_name: agent,
        description: notes || 'Demande d\'aide urgente pendant une patrouille',
        timestamp: new Date().toISOString(),
        help_status: 'pending',
        severity: 'high'
      };

      const result = await window.dataSdk.create(helpRequest);
      if (result.isOk) {
        showToast('üÜò DEMANDE D\'AIDE ENVOY√âE - Superviseurs alert√©s!', 'success');
        activeHelpRequest = helpRequest;
        helpRequestStartTime = null;
        showHelpRequestModal(helpRequest);
      } else {
        showToast('‚ùå Erreur lors de l\'envoi de la demande', 'error');
      }
    }

    function showHelpRequestModal(helpRequest) {
      const now = new Date();
      const dateStr = now.toLocaleDateString('fr-FR');
      const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

      document.getElementById('help-location').textContent = helpRequest.location;
      document.getElementById('help-agent').textContent = helpRequest.agent_name;
      document.getElementById('help-datetime').textContent = `${dateStr} √† ${timeStr}`;
      document.getElementById('help-type').textContent = helpRequest.help_type === 'incident' ? 'üö® Incident' : 'üëÆ Patrouille';

      document.getElementById('help-request-overlay').classList.add('active');
      
      updateHelpRequestTimer();
      window.helpRequestTimerInterval = setInterval(updateHelpRequestTimer, 1000);
    }

    // Filter data by company
    function getCompanyData(data) {
      if (isAdmin) return data;
      if (!currentSession || !currentSession.companyName) return [];
      return data.filter(item => item.company_name === currentSession.companyName);
    }

    const dataHandler = {
      onDataChanged(data) {
        allData = data || [];
        if (currentSession) {
          updateDashboard();
          updateRecommendationsDashboard();
          updateAlertsList();
          checkActiveAlerts();
          if (!['incidents', 'patrols'].includes(getCurrentSection())) {
            updateIncidentsList();
            updatePatrolsList();
          }
          if (isAdmin) {
            updateAdminPanel();
            updateRecommendationsAdmin();
          }
          updateRecipientsList();
        }
      }
    };

    async function initApp() {
      await window.dataSdk.init(dataHandler);
      checkExistingSession();
      setupLoginForm();
      setupAppEventListeners();
      updateCurrentDate();
      setInterval(updateCurrentDate, 60000);
      setInterval(checkActiveAlerts, 1000);
    }

    function checkExistingSession() {
      const session = localStorage.getItem('securityAppSession');
      if (session) {
        try {
          const data = JSON.parse(session);
          const expiryDate = new Date(data.expiry);
          if (expiryDate > new Date()) {
            currentSession = data;
            isAdmin = data.isAdmin || false;
            showApp();
            return;
          }
        } catch (e) {
          localStorage.removeItem('securityAppSession');
        }
      }
      showLogin();
    }

    function toggleAdminLogin() {
      const adminForm = document.getElementById('admin-login-form');
      const loginForm = document.getElementById('login-form');
      const btn = document.getElementById('toggle-admin-btn');
      
      if (adminForm.style.display === 'none' || adminForm.style.display === '') {
        adminForm.style.display = 'block';
        loginForm.style.display = 'none';
        btn.textContent = 'Retour √† la connexion standard';
        setTimeout(() => {
          document.getElementById('admin-password-input').focus();
        }, 100);
      } else {
        adminForm.style.display = 'none';
        loginForm.style.display = 'block';
        btn.textContent = 'Connexion Admin';
        document.getElementById('access-code-input').focus();
      }
    }

    function setupLoginForm() {
      document.getElementById('toggle-admin-btn').addEventListener('click', function(e) {
        e.preventDefault();
        toggleAdminLogin();
      });

      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const code = document.getElementById('access-code-input').value.trim();
        const errorEl = document.getElementById('login-error');
        errorEl.classList.remove('show');

        const validCodes = allCodes.filter(c => c.is_active).map(c => c.code_value);
        if (validCodes.includes(code)) {
          const accessCode = allCodes.find(c => c.code_value === code);
          const expiry = new Date(accessCode.expiry_date);
          
          if (expiry > new Date()) {
            currentSession = {
              code: code,
              expiry: expiry.toISOString(),
              companyName: accessCode.company_name,
              isAdmin: false
            };
            isAdmin = false;

            recordUsage(code, accessCode.company_name);
            
            localStorage.setItem('securityAppSession', JSON.stringify(currentSession));
            showApp();
          } else {
            errorEl.textContent = '‚ùå Ce code d\'acc√®s a expir√©';
            errorEl.classList.add('show');
          }
        } else {
          errorEl.textContent = '‚ùå Code d\'acc√®s invalide';
          errorEl.classList.add('show');
          document.getElementById('access-code-input').value = '';
        }
      });

      document.getElementById('admin-login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('admin-password-input').value.trim();
        const errorEl = document.getElementById('admin-login-error');
        errorEl.classList.remove('show');

        const ADMIN_PASSWORD = 'ADMIN-AUTOREPORT-2024';

        if (password === ADMIN_PASSWORD) {
          const expiry = new Date();
          expiry.setDate(expiry.getDate() + 365);
          currentSession = {
            code: 'ADMIN_SESSION',
            expiry: expiry.toISOString(),
            companyName: 'Administration',
            isAdmin: true
          };
          isAdmin = true;
          localStorage.setItem('securityAppSession', JSON.stringify(currentSession));
          document.getElementById('admin-password-input').value = '';
          showApp();
        } else {
          errorEl.textContent = '‚ùå Mot de passe administrateur incorrect';
          errorEl.classList.add('show');
          document.getElementById('admin-password-input').value = '';
        }
      });
    }

    function recordUsage(code, company) {
      const usage = {
        type: 'usage_log',
        code_value: code,
        company_name: company,
        login_time: new Date().toISOString(),
        login_date: new Date().toISOString().split('T')[0]
      };
      window.dataSdk.create(usage);
    }

    function showLogin() {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('access-code-input').focus();
      document.getElementById('admin-login-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('toggle-admin-btn').textContent = 'Connexion Admin';
    }

    function showApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app-container').style.display = 'flex';
      
      const adminNav = document.getElementById('admin-nav');
      if (isAdmin) {
        adminNav.style.display = 'block';
      } else {
        adminNav.style.display = 'none';
      }

      updateSessionInfo();
      setupAppEventListeners();
    }

    function updateSessionInfo() {
      const expiryDate = new Date(currentSession.expiry);
      const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
      const formattedDate = expiryDate.toLocaleDateString('fr-FR', options);

      document.getElementById('company-name').textContent = currentSession.companyName;
      document.getElementById('access-expiry').textContent = `Acc√®s jusqu'au: ${formattedDate}`;

      const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
      if (daysLeft <= 7 && daysLeft > 0 && !isAdmin) {
        const warning = document.getElementById('access-warning');
        warning.innerHTML = `<div class="access-expired">‚ö†Ô∏è Votre acc√®s expire dans ${daysLeft} jour(s). Veuillez contacter l'administrateur.</div>`;
      } else if (daysLeft <= 0) {
        logout();
      }
    }

    function logout() {
      localStorage.removeItem('securityAppSession');
      currentSession = null;
      isAdmin = false;
      document.getElementById('access-code-input').value = '';
      document.getElementById('login-error').classList.remove('show');
      showLogin();
    }

    function getCurrentSection() {
      const sections = document.querySelectorAll('.section');
      for (let section of sections) {
        if (section.classList.contains('active')) {
          return section.id;
        }
      }
      return 'dashboard';
    }

    function setupAppEventListeners() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.removeEventListener('click', handleNavClick);
        item.addEventListener('click', handleNavClick);
      });

      if (!document.getElementById('alert-form').dataset.eventListener) {
        document.getElementById('alert-form').addEventListener('submit', handleAlertSubmit);
        document.getElementById('alert-form').dataset.eventListener = 'true';
      }

      if (!document.getElementById('incident-form').dataset.eventListener) {
        document.getElementById('incident-form').addEventListener('submit', handleIncidentSubmit);
        document.getElementById('incident-form').dataset.eventListener = 'true';
      }

      if (!document.getElementById('patrol-form').dataset.eventListener) {
        document.getElementById('patrol-form').addEventListener('submit', handlePatrolSubmit);
        document.getElementById('patrol-form').dataset.eventListener = 'true';
      }

      if (!document.getElementById('recipients-form').dataset.eventListener) {
        document.getElementById('recipients-form').addEventListener('submit', handleAddRecipient);
        document.getElementById('recipients-form').dataset.eventListener = 'true';
      }

      if (isAdmin && !document.getElementById('code-form').dataset.eventListener) {
        document.getElementById('code-form').addEventListener('submit', handleCodeSubmit);
        document.getElementById('code-form').dataset.eventListener = 'true';
      }
    }

    function handleNavClick() {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      
      this.classList.add('active');
      const section = this.dataset.section;
      document.getElementById(section).classList.add('active');
      
      const titles = {
        dashboard: 'üìä Tableau de bord',
        alerts: 'üö® Syst√®me d\'Alertes Urgentes',
        incidents: 'üö® Enregistrement des Incidents',
        patrols: 'üëÆ Patrouilles',
        reports: 'üìã Rapports',
        admin: '‚öôÔ∏è Panneau d\'Administration'
      };
      document.getElementById('section-title').textContent = titles[section];
    }

    async function handleAlertSubmit(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const alert = {
        type: 'alert',
        company_name: currentSession.companyName,
        alert_type: document.getElementById('alert-type').value,
        zone: document.getElementById('alert-zone').value,
        severity: document.getElementById('alert-severity').value,
        person_reporting: document.getElementById('alert-person').value,
        description: document.getElementById('alert-description').value,
        timestamp: new Date().toISOString(),
        alert_status: 'active',
        response_status: 'pending'
      };

      const result = await window.dataSdk.create(alert);
      
      btn.disabled = false;
      btn.innerHTML = 'üö® D√âCLENCHER L\'ALERTE';

      if (result.isOk) {
        showToast('üö® ALERTE D√âCLENCH√âE - ÔøΩÔøΩQUIPE NOTIFIÔøΩÔøΩE', 'success');
        e.target.reset();
        checkActiveAlerts();
      } else {
        showToast('‚ùå Erreur lors du d√©clenchement', 'error');
      }
    }

    async function handleIncidentSubmit(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const incident = {
        type: 'incident',
        company_name: currentSession.companyName,
        date: document.getElementById('incident-date').value,
        time: document.getElementById('incident-time').value,
        title: document.getElementById('incident-title').value,
        location: document.getElementById('incident-location').value,
        severity: document.getElementById('incident-severity').value,
        agent_name: document.getElementById('incident-agent').value,
        description: document.getElementById('incident-desc').value,
        status: 'open'
      };

      const result = await window.dataSdk.create(incident);
      
      btn.disabled = false;
      btn.innerHTML = 'Enregistrer l\'Incident';

      if (result.isOk) {
        showToast('‚úÖ Incident enregistr√© avec succ√®s', 'success');
        e.target.reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('incident-date').value = today;
      } else {
        showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function handlePatrolSubmit(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const patrol = {
        type: 'patrol',
        company_name: currentSession.companyName,
        date: document.getElementById('patrol-date').value,
        time: document.getElementById('patrol-time').value,
        location: document.getElementById('patrol-location').value,
        agent_name: document.getElementById('patrol-agent').value,
        notes: document.getElementById('patrol-notes').value,
        status: 'completed'
      };

      const result = await window.dataSdk.create(patrol);
      
      btn.disabled = false;
      btn.innerHTML = 'Enregistrer la Patrouille';

      if (result.isOk) {
        showToast('‚úÖ Patrouille enregistr√©e avec succ√®s', 'success');
        e.target.reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('patrol-date').value = today;
      } else {
        showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function handleCodeSubmit(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const durationDays = parseInt(document.getElementById('code-duration').value) || 30;
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + durationDays);

      const code = {
        type: 'access_code',
        code_value: document.getElementById('code-value').value.toUpperCase(),
        company_name: document.getElementById('code-company').value,
        expiry_date: expiryDate.toISOString().split('T')[0],
        is_active: true,
        created_date: new Date().toISOString().split('T')[0],
        created_by: document.getElementById('code-created-by').value,
        usage_count: 0
      };

      const result = await window.dataSdk.create(code);
      
      btn.disabled = false;
      btn.innerHTML = 'Cr√©er le Code';

      if (result.isOk) {
        showToast('‚úÖ Code cr√©√© avec succ√®s', 'success');
        e.target.reset();
      } else {
        showToast('‚ùå Erreur lors de la cr√©ation', 'error');
      }
    }

    function checkActiveAlerts() {
      const companyData = getCompanyData(allData);
      const alerts = companyData.filter(d => d.type === 'alert' && d.alert_status === 'active');
      const activeCount = alerts.length;

      document.getElementById('total-alerts').textContent = activeCount;

      const alertBadge = document.getElementById('alert-count');
      if (activeCount > 0) {
        alertBadge.textContent = activeCount;
        alertBadge.style.display = 'inline-block';
        document.getElementById('emergency-banner').classList.add('active');
        
        if (alerts.length > 0) {
          activeAlert = alerts[0];
          alertStartTime = new Date(activeAlert.timestamp);
        }
      } else {
        alertBadge.style.display = 'none';
        document.getElementById('emergency-banner').classList.remove('active');
        activeAlert = null;
        alertStartTime = null;
      }
    }

    function updateAlertsList() {
      const companyData = getCompanyData(allData);
      const alerts = companyData.filter(d => d.type === 'alert');
      const container = document.getElementById('alerts-list');

      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div>Aucune alerte</div>';
        return;
      }

      container.innerHTML = alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map((alert, idx) => {
        const startTime = new Date(alert.timestamp);
        const now = new Date();
        const responseTime = Math.floor((now - startTime) / 1000);
        const seconds = responseTime % 60;
        const minutes = Math.floor(responseTime / 60);
        const timeStr = `${minutes}m ${seconds}s`;

        const zoneMap = {
          'entrance': 'üö™ Entr√©e Principale',
          'storage': 'üì¶ Zone de Stockage',
          'office': 'üè¢ Bureau',
          'parking': 'üöó Parking',
          'perimeter': 'üîí P√©rim√®tre Ext√©rieur',
          'server': 'üñ•Ô∏è Salle Serveur',
          'other': 'üìç Autre Zone'
        };

        const typeMap = {
          'intrusion': 'üî¥ Intrusion D√©tect√©e',
          'break_in': 'üî¥ Tentative d\'Effraction',
          'theft': 'üí∞ Vol/Tentative de Vol',
          'sabotage': '‚ö° Sabotage/Vandalisme',
          'accident': 'üÜò Accident/Blessure',
          'fire': 'üî• Alarme Incendie',
          'medical': 'üè• Urgence M√©dicale',
          'suspicious': 'üëÅÔ∏è Activit√© Suspecte'
        };

        return `
          <div class="intervention-item ${alert.response_status === 'responded' ? 'responded' : ''}">
            <div class="intervention-header">
              <div class="intervention-title">${typeMap[alert.alert_type] || alert.alert_type}</div>
              <span class="status-badge status-${alert.alert_status === 'active' ? 'emergency' : 'closed'}">
                ${alert.alert_status === 'active' ? 'üö® ACTIVE' : '‚úÖ R√©solue'}
              </span>
            </div>
            <div class="intervention-meta">
              <span>üìç ${zoneMap[alert.zone] || alert.zone}</span>
              <span>üÜò S√©v√©rit√©: ${alert.severity.toUpperCase()}</span>
              <span>üë§ ${alert.person_reporting}</span>
            </div>
            <div style="margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 6px; font-size: 13px; color: #374151;">
              ${alert.description}
            </div>
            ${alert.alert_status === 'active' ? `
              <div class="intervention-response-time">
                <span style="color: #ef4444; font-weight: 600;">‚è±Ô∏è Temps depuis alerte: <span style="font-family: 'Courier New', monospace;">${timeStr}</span></span>
                <button class="btn btn-primary btn-small" onclick="respondToAlert(${idx})">‚úÖ Marquer comme trait√©</button>
              </div>
            ` : ''}
            ${alert.response_status === 'responded' ? `
              <div class="intervention-response">
                ‚úÖ Alerte trait√©e - √âquipe d'intervention d√©ploy√©e
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function respondToAlert(index) {
      const alerts = allData.filter(d => d.type === 'alert');
      const alert = alerts[index];
      if (!alert) return;

      const fullAlert = allData.find(d => d.__backendId === alert.__backendId);
      fullAlert.alert_status = 'resolved';
      fullAlert.response_status = 'responded';

      const result = await window.dataSdk.update(fullAlert);
      if (result.isOk) {
        showToast('‚úÖ Alerte marqu√©e comme trait√©e', 'success');
        checkActiveAlerts();
      } else {
        showToast('‚ùå Erreur lors de la mise √† jour', 'error');
      }
    }

    function updateDashboard() {
      const companyData = getCompanyData(allData);
      const incidents = companyData.filter(d => d.type === 'incident');
      const patrols = companyData.filter(d => d.type === 'patrol');
      const alerts = companyData.filter(d => d.type === 'alert' && d.alert_status === 'active');
      const resolved = incidents.filter(d => d.status === 'closed');

      document.getElementById('total-incidents').textContent = incidents.length;
      document.getElementById('total-patrols').textContent = patrols.length;
      document.getElementById('total-resolved').textContent = resolved.length;
      document.getElementById('total-alerts').textContent = alerts.length;

      updateSeverityChart();
      updateLocationChart();
      updateRecentIncidents();
    }

    function updateSeverityChart() {
      const companyData = getCompanyData(allData);
      const incidents = companyData.filter(d => d.type === 'incident');
      const severities = { high: 0, medium: 0, low: 0 };
      
      incidents.forEach(i => {
        if (i.severity && severities.hasOwnProperty(i.severity)) {
          severities[i.severity]++;
        }
      });

      const maxValue = Math.max(...Object.values(severities), 1);
      const chart = document.getElementById('severity-chart');
      chart.innerHTML = '';

      const labels = { high: 'üî¥ √âlev√©', medium: 'üü° Moyen', low: 'üü¢ Faible' };
      
      Object.entries(severities).forEach(([key, value]) => {
        const height = (value / maxValue) * 100;
        chart.innerHTML += `
          <div class="bar" style="height: ${Math.max(height, 10)}%;">
            <div class="bar-value">${value}</div>
            <div class="bar-label">${labels[key]}</div>
          </div>
        `;
      });
    }

    function updateLocationChart() {
      const companyData = getCompanyData(allData);
      const incidents = companyData.filter(d => d.type === 'incident');
      const locations = {};

      incidents.forEach(i => {
        if (i.location) {
          locations[i.location] = (locations[i.location] || 0) + 1;
        }
      });

      const sorted = Object.entries(locations)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const maxValue = Math.max(...sorted.map(s => s[1]), 1);
      const chart = document.getElementById('location-chart');
      chart.innerHTML = '';

      sorted.forEach(([location, count]) => {
        const height = (count / maxValue) * 100;
        const shortLabel = location.substring(0, 12);
        chart.innerHTML += `
          <div class="bar" style="height: ${Math.max(height, 10)}%;" title="${location}">
            <div class="bar-value">${count}</div>
            <div class="bar-label">${shortLabel}</div>
          </div>
        `;
      });

      if (sorted.length === 0) {
        chart.innerHTML = '<div style="text-align: center; color: #999; padding: 30px;">Aucune donn√©e</div>';
      }
    }

    function updateRecentIncidents() {
      const incidents = allData
        .filter(d => d.type === 'incident')
        .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
        .slice(0, 5);

      const container = document.getElementById('recent-incidents');

      if (incidents.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div>Aucun incident enregistr√©</div>';
        return;
      }

      container.innerHTML = incidents.map(i => `
        <div class="record-item">
          <div class="record-info">
            <div class="record-title">${i.title}</div>
            <div class="record-meta">
              <span>${i.date} √† ${i.time}</span>
              <span>üìç ${i.location}</span>
              <span>${i.agent_name}</span>
            </div>
          </div>
          <div>
            <span class="severity-badge severity-${i.severity}">${capitalize(i.severity)}</span>
            <span class="status-badge status-${i.status}">${capitalize(i.status)}</span>
          </div>
        </div>
      `).join('');
    }

    function getIncidentPatterns() {
      const incidents = allData.filter(d => d.type === 'incident');
      const recommendations = [];

      const incidentMap = {};
      
      incidents.forEach(incident => {
        const key = `${incident.title}|${incident.location}`;
        if (!incidentMap[key]) {
          incidentMap[key] = [];
        }
        incidentMap[key].push(incident);
      });

      Object.entries(incidentMap).forEach(([key, incidentList]) => {
        if (incidentList.length >= 2) {
          const [title, location] = key.split('|');
          const recentCount = incidentList.filter(i => {
            const daysAgo = Math.floor((new Date() - new Date(i.date)) / (1000 * 60 * 60 * 24));
            return daysAgo <= 30;
          }).length;

          if (recentCount >= 2) {
            let priority = 'low';
            let recommendation = '';

            if (title.toLowerCase().includes('vol') || title.toLowerCase().includes('tentative')) {
              priority = recentCount >= 4 ? 'high' : 'medium';
              recommendation = `Installation de cam√©ras de surveillance suppl√©mentaires √† ${location}. Augmentez la fr√©quence des patrouilles dans cette zone.`;
            } else if (title.toLowerCase().includes('acc√®s') || title.toLowerCase().includes('intrusion')) {
              priority = recentCount >= 3 ? 'high' : 'medium';
              recommendation = `Renforcez les contr√¥les d'acc√®s √† ${location}. V√©rifiez l'√©tat des serrures et des syst√®mes de verrouillage.`;
            } else if (title.toLowerCase().includes('accident')) {
              priority = 'high';
              recommendation = `Zone √† risque d√©tect√©e √† ${location}. Organisez une formation de s√©curit√© pour le personnel et installez une signalisation appropri√©e.`;
            } else if (title.toLowerCase().includes('d√©g√¢t') || title.toLowerCase().includes('vandalisme')) {
              priority = 'medium';
              recommendation = `${location} fait l'objet d'actes de vandalisme rÔøΩÔøΩp√©t√©s. Augmentez les patrouilles nocturnes et consid√©rez l'installation d'√©clairage suppl√©mentaire.`;
            } else {
              priority = recentCount >= 3 ? 'high' : 'medium';
              recommendation = `Pattern d√©tect√©: ${title} se reproduit √† ${location} (${recentCount} incidents en 30 jours). Analysez les causes communes et mettez en place des mesures pr√©ventives.`;
            }

            recommendations.push({
              title: `${title} r√©p√©titif √† ${location}`,
              text: recommendation,
              priority: priority,
              count: recentCount,
              location: location,
              incidentType: title
            });
          }
        }
      });

      const locationMap = {};
      incidents.forEach(incident => {
        if (!locationMap[incident.location]) {
          locationMap[incident.location] = [];
        }
        locationMap[incident.location].push(incident);
      });

      Object.entries(locationMap).forEach(([location, incidentList]) => {
        if (incidentList.length >= 5) {
          const recentCount = incidentList.filter(i => {
            const daysAgo = Math.floor((new Date() - new Date(i.date)) / (1000 * 60 * 60 * 24));
            return daysAgo <= 30;
          }).length;

          if (recentCount >= 3) {
            recommendations.push({
              title: `Hotspot d'incidents √† ${location}`,
              text: `${location} enregistre ${recentCount} incidents en 30 jours. C'est une zone critique. Augmentez les effectifs de s√©curit√©, am√©liorez l'√©clairage et la vid√©osurveillance.`,
              priority: 'high',
              count: recentCount,
              location: location,
              incidentType: 'Multiple'
            });
          }
        }
      });

      const highSeverity = incidents.filter(i => i.severity === 'high');
      if (highSeverity.length >= 1) {
        recommendations.push({
          title: 'üî¥ Incidents de haute s√©v√©rit√© d√©tect√©s',
          text: `${highSeverity.length} incident(s) de haute s√©v√©rit√© enregistr√©(s). Organisez une r√©union urgente de s√©curit√© pour discuter des mesures correctives.`,
          priority: 'high',
          count: highSeverity.length,
          location: 'G√©n√©ral',
          incidentType: 'S√©v√©rit√©'
        });
      }

      return recommendations.sort((a, b) => {
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      });
    }

    function updateRecommendationsDashboard() {
      const recommendations = getIncidentPatterns();
      const container = document.getElementById('recommendations-dashboard');

      if (recommendations.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div>Aucun pattern d√©tect√©. Excellent travail!</div>';
        return;
      }

      container.innerHTML = recommendations
        .slice(0, 3)
        .map((rec, idx) => `
          <div class="recommendation-item ${rec.priority === 'high' ? 'high-priority' : ''}">
            <div class="recommendation-header">
              <div class="recommendation-title">${rec.title}</div>
              <span class="recommendation-priority ${rec.priority}">${rec.priority === 'high' ? 'üî¥ ' : rec.priority === 'medium' ? 'üü° ' : 'üü¢ '}${rec.priority}</span>
            </div>
            <div class="recommendation-text">${rec.text}</div>
            <div class="recommendation-meta">
              <span>üìä <span class="incident-count">${rec.count}</span> incidents</span>
              <span>üìç ${rec.location}</span>
            </div>
            <div class="recommendation-actions">
              <button class="btn btn-primary btn-small" onclick="sendRecommendation(${idx})">ÔøΩÔøΩ Envoyer aux d√©cideurs</button>
            </div>
          </div>
        `).join('');
    }

    function updateRecommendationsAdmin() {
      const codes = allData.filter(d => d.type === 'access_code');
      const incidents = allData.filter(d => d.type === 'incident');
      const container = document.getElementById('recommendations-admin');

      if (codes.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div>Aucune entreprise enregistr√©e</div>';
        return;
      }

      const companyRecommendations = {};
      
      codes.forEach(code => {
        const company = code.company_name;
        if (!companyRecommendations[company]) {
          companyRecommendations[company] = {
            incidents: [],
            recommendations: []
          };
        }

        const companyIncidents = incidents.filter(i => i.company_name === company);
        companyRecommendations[company].incidents = companyIncidents;
      });

      Object.entries(companyRecommendations).forEach(([company, data]) => {
        const companyIncidents = incidents.filter(i => i.company_name === company);
        
        if (companyIncidents.length > 0) {
          const incidentMap = {};
          companyIncidents.forEach(incident => {
            const key = `${incident.title}|${incident.location}`;
            if (!incidentMap[key]) {
              incidentMap[key] = [];
            }
            incidentMap[key].push(incident);
          });

          data.recommendations = Object.entries(incidentMap)
            .filter(([_, list]) => list.length >= 2)
            .map(([key, list]) => {
              const [title, location] = key.split('|');
              const recentCount = list.filter(i => {
                const daysAgo = Math.floor((new Date() - new Date(i.date)) / (1000 * 60 * 60 * 24));
                return daysAgo <= 30;
              }).length;
              
              return {
                title: title,
                location: location,
                count: recentCount,
                total: list.length
              };
            });
        }
      });

      const html = Object.entries(companyRecommendations)
        .map(([company, data]) => {
          if (data.recommendations.length === 0) {
            return `
              <div class="recommendation-company">
                <div class="recommendation-company-title">
                  ${company}
                  <span style="font-size: 12px; font-weight: 400; color: #6b7280;">‚úÖ Aucun pattern</span>
                </div>
              </div>
            `;
          }

          return `
            <div class="recommendation-company">
              <div class="recommendation-company-title">
                ${company}
                <span class="incident-count">${data.recommendations.length}</span>
              </div>
              ${data.recommendations.map(rec => `
                <div class="incident-pattern">
                  <strong>üìå ${rec.title}</strong> √† ${rec.location}
                  <br><span style="color: #6b7280;">
                    ${rec.count} fois en 30 jours (${rec.total} au total)
                  </span>
                </div>
              `).join('')}
            </div>
          `;
        })
        .join('');

      container.innerHTML = html;
    }

    function updateIncidentsList() {
      const companyData = getCompanyData(allData);
      const incidents = companyData.filter(d => d.type === 'incident');
      const container = document.getElementById('incidents-list');

      if (incidents.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div>Aucun incident enregistr√©</div>';
        return;
      }

      container.innerHTML = `
        <div class="records-list" style="background: none; box-shadow: none;">
          ${incidents.map((i, idx) => `
            <div class="record-item" style="display: flex; justify-content: space-between; align-items: center;">
              <div class="record-info" style="flex: 1;">
                <div class="record-title">${i.title}</div>
                <div class="record-meta">
                  <span>${i.date} √† ${i.time}</span>
                  <span>üìç ${i.location}</span>
                  <span>${i.agent_name}</span>
                </div>
                <div style="margin-top: 8px;">${i.description}</div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                <div>
                  <span class="severity-badge severity-${i.severity}">${capitalize(i.severity)}</span>
                  <span class="status-badge status-${i.status}">${capitalize(i.status)}</span>
                </div>
                <button class="btn btn-secondary btn-small" onclick="toggleStatus(${idx})">
                  ${i.status === 'open' ? 'Fermer' : 'R√©ouvrir'}
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function toggleStatus(index) {
      const incidents = allData.filter(d => d.type === 'incident');
      const incident = incidents[index];
      if (!incident) return;

      const fullIncident = allData.find(d => d.__backendId === incident.__backendId);
      fullIncident.status = fullIncident.status === 'open' ? 'closed' : 'open';

      const result = await window.dataSdk.update(fullIncident);
      if (!result.isOk) {
        showToast('‚ùå Erreur lors de la mise √† jour', 'error');
      }
    }

    function updatePatrolsList() {
      const companyData = getCompanyData(allData);
      const patrols = companyData.filter(d => d.type === 'patrol');
      const container = document.getElementById('patrols-list');

      if (patrols.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div>Aucune patrouille enregistr√©e</div>';
        return;
      }

      container.innerHTML = patrols.map(p => `
        <div class="record-item">
          <div class="record-info">
            <div class="record-title">Patrouille - ${p.location}</div>
            <div class="record-meta">
              <span>${p.date} √† ${p.time}</span>
              <span>ÔøΩÔøΩÔøΩ ${p.agent_name}</span>
            </div>
            ${p.notes ? `<div style="margin-top: 8px; color: #666;">${p.notes}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function updateAdminPanel() {
      const codes = allData.filter(d => d.type === 'access_code');
      const activeCodes = codes.filter(c => c.is_active && new Date(c.expiry_date) > new Date());
      const expiredCodes = codes.filter(c => new Date(c.expiry_date) <= new Date());
      const usage = allData.filter(d => d.type === 'usage_log');

      allCodes = codes;
      usageHistory = usage;

      document.getElementById('admin-total-codes').textContent = codes.length;
      document.getElementById('admin-active-codes').textContent = activeCodes.length;
      document.getElementById('admin-expired-codes').textContent = expiredCodes.length;

      const codesList = document.getElementById('codes-list');
      if (codes.length === 0) {
        codesList.innerHTML = '<div class="empty-state"><div class="empty-icon">üîë</div>Aucun code d\'acc√®s cr√©√©</div>';
      } else {
        codesList.innerHTML = codes.map((c, idx) => {
          const expiry = new Date(c.expiry_date);
          const daysLeft = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
          const isExpired = daysLeft <= 0;
          const isWarning = daysLeft <= 7 && daysLeft > 0;

          let cardClass = 'code-card';
          if (isExpired) cardClass += ' expired';
          if (isWarning) cardClass += ' warning';

          return `
            <div class="${cardClass}">
              <div class="code-header">
                <div>
                  <div class="code-value">${c.code_value}</div>
                  <div class="code-company">${c.company_name}</div>
                </div>
                <span class="status-badge ${isExpired ? 'status-expired' : isWarning ? 'status-warning' : 'status-active'}">
                  ${isExpired ? '‚ùå Expir√©' : isWarning ? '‚ö†Ô∏è Expire bient√¥t' : '‚úÖ Actif'}
                </span>
              </div>
              <div class="code-details">
                <div class="code-detail-item">
                  <div class="code-detail-label">Date d'Expiration</div>
                  <div class="code-detail-value">${c.expiry_date}</div>
                </div>
                <div class="code-detail-item">
                  <div class="code-detail-label">Cr√©√© le</div>
                  <div class="code-detail-value">${c.created_date}</div>
                </div>
                <div class="code-detail-item">
                  <div class="code-detail-label">Jours Restants</div>
                  <div class="code-detail-value">${Math.max(0, daysLeft)}</div>
                </div>
              </div>
              <div class="code-actions">
                <button class="btn btn-secondary btn-small" onclick="editCode(${idx})">‚úèÔ∏è Modifier</button>
                <button class="btn btn-danger" onclick="deleteCode(${idx})">üóëÔ∏è Supprimer</button>
              </div>
            </div>
          `;
        }).join('');
      }

      const tbody = document.getElementById('usage-tbody');
      if (usage.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Aucun historique d\'utilisation</td></tr>';
      } else {
        tbody.innerHTML = usage.slice(-10).reverse().map(u => `
          <tr>
            <td><code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${u.code_value}</code></td>
            <td>${u.company_name}</td>
            <td>${u.login_date} √† ${u.login_time.split('T')[1].substring(0, 5)}</td>
            <td><span class="status-badge status-active">‚úÖ Connect√©</span></td>
          </tr>
        `).join('');
      }
    }

    function editCode(index) {
      const codes = allData.filter(d => d.type === 'access_code');
      const code = codes[index];
      if (!code) return;

      document.getElementById('modal-title').textContent = '‚úèÔ∏è Modifier le Code';
      document.getElementById('modal-code-value').value = code.code_value;
      document.getElementById('modal-code-company').value = code.company_name;
      document.getElementById('modal-code-expiry').value = code.expiry_date;
      document.getElementById('modal-code-active').value = code.is_active ? 'true' : 'false';

      document.getElementById('modal-form').onsubmit = async (e) => {
        e.preventDefault();
        code.company_name = document.getElementById('modal-code-company').value;
        code.expiry_date = document.getElementById('modal-code-expiry').value;
        code.is_active = document.getElementById('modal-code-active').value === 'true';

        const result = await window.dataSdk.update(code);
        if (result.isOk) {
          showToast('‚úÖ Code modifi√© avec succ√®s', 'success');
          closeModal();
        } else {
          showToast('‚ùå Erreur lors de la modification', 'error');
        }
      };

      document.getElementById('modal-overlay').classList.add('active');
    }

    async function deleteCode(index) {
      const codes = allData.filter(d => d.type === 'access_code');
      const code = codes[index];
      if (!code) return;

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '√ätes-vous s√ªr?';
      btn.style.background = '#991b1b';

      const confirmDelete = async () => {
        const result = await window.dataSdk.delete(code);
        if (result.isOk) {
          showToast('‚úÖ Code supprim√© avec succ√®s', 'success');
        } else {
          showToast('‚ùå Erreur lors de la suppression', 'error');
        }
        btn.textContent = originalText;
        btn.style.background = '#ef4444';
        btn.removeEventListener('click', confirmDelete);
        btn.addEventListener('click', () => deleteCode(index));
      };

      btn.removeEventListener('click', () => deleteCode(index));
      btn.addEventListener('click', confirmDelete);

      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#ef4444';
        btn.removeEventListener('click', confirmDelete);
        btn.addEventListener('click', () => deleteCode(index));
      }, 3000);
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
    }

    function shareEmergencyAlert() {
      const alertType = document.getElementById('alert-type').value;
      const description = document.getElementById('alert-description').value;
      
      if (!alertType || !description) {
        showToast('‚ùå Veuillez remplir les champs obligatoires', 'error');
        return;
      }

      const typeMap = {
        'intrusion': 'üî¥ Intrusion D√©tect√©e',
        'break_in': 'üî¥ Tentative d\'Effraction',
        'theft': 'üí∞ Vol/Tentative de Vol',
        'sabotage': '‚ö° Sabotage/Vandalisme',
        'accident': 'üÜò Accident/Blessure',
        'fire': 'üî• Alarme Incendie',
        'medical': 'üè• Urgence M√©dicale',
        'suspicious': 'üëÅÔ∏è Activit√© Suspecte'
      };

      document.getElementById('share-alert-type').textContent = typeMap[alertType] || alertType;
      document.getElementById('share-alert-description').textContent = description;

      generateEmergencyShareLink();
      generateEmergencyQRCode();
      
      document.getElementById('emergency-share-overlay').classList.add('active');
      
      updateAlertShareTimer();
      window.alertShareTimerInterval = setInterval(updateAlertShareTimer, 1000);
    }

    function generateEmergencyShareLink() {
      const alertType = document.getElementById('alert-type').value;
      const zone = document.getElementById('alert-zone').value;
      const severity = document.getElementById('alert-severity').value;
      const person = document.getElementById('alert-person').value;
      const desc = document.getElementById('alert-description').value;

      const alertData = btoa(JSON.stringify({
        type: alertType,
        zone: zone,
        severity: severity,
        person: person,
        description: desc,
        timestamp: new Date().toISOString()
      }));

      const currentUrl = window.location.href.split('?')[0];
      const shareLink = `${currentUrl}?emergency-alert=${alertData}`;
      
      document.getElementById('share-link-input').value = shareLink;
      window.emergencyShareLink = shareLink;
    }

    function generateEmergencyQRCode() {
      const canvas = document.getElementById('qr-code-canvas');
      canvas.innerHTML = '';

      new QRCode(canvas, {
        text: window.emergencyShareLink,
        width: 250,
        height: 250,
        colorDark: '#dc2626',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    function updateAlertShareTimer() {
      if (!window.alertShareStartTime) {
        window.alertShareStartTime = new Date();
      }

      const elapsed = Math.floor((new Date() - window.alertShareStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      const timeStr = minutes > 0 
        ? `${minutes}m ${seconds}s`
        : `${seconds}s`;
      
      const timeEl = document.getElementById('share-alert-time');
      if (timeEl) {
        timeEl.textContent = timeStr;
      }
    }

    function closeEmergencyShare() {
      document.getElementById('emergency-share-overlay').classList.remove('active');
      if (window.alertShareTimerInterval) {
        clearInterval(window.alertShareTimerInterval);
      }
      window.alertShareStartTime = null;
    }

    function copyShareLink() {
      const shareLink = window.emergencyShareLink;
      navigator.clipboard.writeText(shareLink).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'ÔøΩÔøΩÔøΩ Copi√©!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      }).catch(() => {
        showToast('‚ùå Erreur lors de la copie', 'error');
      });
    }

    function shareVia(method) {
      const shareLink = window.emergencyShareLink;
      const alertType = document.getElementById('alert-type').value;
      const description = document.getElementById('alert-description').value;
      
      const typeMap = {
        'intrusion': 'üî¥ Intrusion D√©tect√©e',
        'break_in': 'üî¥ Tentative d\'Effraction',
        'theft': 'üí∞ Vol/Tentative de Vol',
        'sabotage': '‚ö° Sabotage/Vandalisme',
        'accident': 'üÜò Accident/Blessure',
        'fire': 'üî• Alarme Incendie',
        'medical': 'üè• Urgence M√©dicale',
        'suspicious': 'üëÅÔ∏è Activit√© Suspecte'
      };

      const alertTitle = typeMap[alertType] || alertType;
      const message = `üö® ALERTE URGENTE - ${alertTitle}\n\n${description}\n\nAcc√®s rapide:\n${shareLink}`;

      if (method === 'whatsapp') {
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank', 'noopener,noreferrer');
      } else if (method === 'email') {
        const subject = encodeURIComponent('üö® ALERTE URGENTE - AUTOREPORT');
        const body = encodeURIComponent(message);
        window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
      } else if (method === 'sms') {
        const encodedMessage = encodeURIComponent(message);
        window.open(`sms:?body=${encodedMessage}`, '_blank');
      }
    }

    function generateReport() {
      const companyData = getCompanyData(allData);
      const reportType = document.getElementById('report-type').value;
      const period = document.getElementById('report-month').value || new Date().toISOString().slice(0, 7);
      const incidents = companyData.filter(d => d.type === 'incident');
      const patrols = companyData.filter(d => d.type === 'patrol');
      const alerts = companyData.filter(d => d.type === 'alert');

      let filteredIncidents = incidents;
      let filteredPatrols = patrols;
      let filteredAlerts = alerts;
      let title = '';
      let analysisData = {};

      if (reportType === 'daily') {
        const today = new Date().toISOString().split('T')[0];
        filteredIncidents = incidents.filter(i => i.date === today);
        filteredPatrols = patrols.filter(p => p.date === today);
        filteredAlerts = alerts.filter(a => a.timestamp.startsWith(today));
        title = `Rapport Journalier - ${today}`;
        analysisData = analyzeDailyReport(filteredIncidents, filteredAlerts, filteredPatrols);
      } else if (reportType === 'monthly') {
        filteredIncidents = incidents.filter(i => i.date.startsWith(period));
        filteredPatrols = patrols.filter(p => p.date.startsWith(period));
        filteredAlerts = alerts.filter(a => a.timestamp.startsWith(period));
        title = `Rapport Mensuel - ${period}`;
        analysisData = analyzeMonthlyReport(incidents, alerts, period);
      } else {
        const year = period.split('-')[0];
        filteredIncidents = incidents.filter(i => i.date.startsWith(year));
        filteredPatrols = patrols.filter(p => p.date.startsWith(year));
        filteredAlerts = alerts.filter(a => a.timestamp.startsWith(year));
        title = `Rapport Annuel - ${year}`;
        analysisData = analyzeAnnualReport(incidents, alerts, year);
      }

      const resolvedCount = filteredIncidents.filter(i => i.status === 'closed').length;
      const openCount = filteredIncidents.filter(i => i.status === 'open').length;
      const resolvedAlerts = filteredAlerts.filter(a => a.alert_status === 'resolved').length;
      const avgResolutionTime = calculateAvgResolutionTime(filteredIncidents);

      let html = `
        <div class="report-section">
          <div class="report-heading">${title}</div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${filteredIncidents.length}</div>
              <div style="font-size: 12px; color: #6b7280;">Incidents</div>
            </div>
            <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #10b981;">${resolvedCount}</div>
              <div style="font-size: 12px; color: #6b7280;">R√©solus (${filteredIncidents.length > 0 ? Math.round((resolvedCount/filteredIncidents.length)*100) : 0}%)</div>
            </div>
            <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${filteredAlerts.length}</div>
              <div style="font-size: 12px; color: #6b7280;">Alertes</div>
            </div>
            <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${filteredPatrols.length}</div>
              <div style="font-size: 12px; color: #6b7280;">Patrouilles</div>
            </div>
          </div>

          ${analysisData.html || ''}

          <div style="margin-bottom: 20px;">
            <h4 style="font-weight: 600; margin-bottom: 10px;">D√©tails des Alertes Urgentes</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Zone</th>
                  <th>S√©v√©rit√©</th>
                  <th>Statut</th>
                  <th>Date/Heure</th>
                </tr>
              </thead>
              <tbody>
                ${filteredAlerts.map(a => {
                  const typeMap = {
                    'intrusion': 'üî¥ Intrusion',
                    'break_in': 'üî¥ Effraction',
                    'theft': 'üí∞ Vol',
                    'sabotage': '‚ö° Sabotage',
                    'accident': 'üÜò Accident',
                    'fire': 'üî• Incendie',
                    'medical': 'üè• M√©dical',
                    'suspicious': 'üëÅÔ∏è Suspect'
                  };
                  return `
                    <tr>
                      <td>${typeMap[a.alert_type] || a.alert_type}</td>
                      <td>${a.zone}</td>
                      <td><span class="severity-badge severity-${a.severity}">${a.severity.toUpperCase()}</span></td>
                      <td><span class="status-badge status-${a.alert_status === 'resolved' ? 'closed' : 'open'}">${a.alert_status === 'resolved' ? '‚úÖ Trait√©e' : 'üö® Active'}</span></td>
                      <td>${a.timestamp.split('T')[0]} ${a.timestamp.split('T')[1].substring(0, 5)}</td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="5" style="text-align: center; color: #999;">Aucune alerte</td></tr>'}
              </tbody>
            </table>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="font-weight: 600; margin-bottom: 10px;">D√©tails des Incidents</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Titre</th>
                  <th>Localisation</th>
                  <th>S√©v√©rit√©</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                ${filteredIncidents.map(i => `
                  <tr>
                    <td>${i.date} ${i.time}</td>
                    <td>${i.title}</td>
                    <td>${i.location}</td>
                    <td><span class="severity-badge severity-${i.severity}">${capitalize(i.severity)}</span></td>
                    <td><span class="status-badge status-${i.status}">${capitalize(i.status)}</span></td>
                  </tr>
                `).join('') || '<tr><td colspan="5" style="text-align: center; color: #999;">Aucun incident</td></tr>'}
              </tbody>
            </table>
          </div>

          <div>
            <h4 style="font-weight: 600; margin-bottom: 10px;">Patrouilles Effectu√©es</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Zone</th>
                  <th>Agent</th>
                  <th>Observations</th>
                </tr>
              </thead>
              <tbody>
                ${filteredPatrols.map(p => `
                  <tr>
                    <td>${p.date} ${p.time}</td>
                    <td>${p.location}</td>
                    <td>${p.agent_name}</td>
                    <td>${p.notes || '-'}</td>
                  </tr>
                `).join('') || '<tr><td colspan="4" style="text-align: center; color: #999;">Aucune patrouille</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;

      reportData = {
        title: title,
        incidents: filteredIncidents,
        patrols: filteredPatrols,
        alerts: filteredAlerts,
        html: html,
        timestamp: new Date().toISOString(),
        analysisData: analysisData
      };

      document.getElementById('report-content').innerHTML = html;
      showToast('‚úÖ Rapport g√©n√©r√© avec succ√®s', 'success');
    }

    function analyzeDailyReport(incidents, alerts, patrols) {
      const html = `
        <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
          <h4 style="font-weight: 600; color: #1e40af; margin-bottom: 10px;">üìä Analyse du Jour</h4>
          <div style="color: #1e40af; font-size: 13px; line-height: 1.6;">
            <p>‚Ä¢ ${incidents.length === 0 ? '‚úÖ Aucun incident enregistr√© aujourd\'hui' : `‚ö†Ô∏è ${incidents.length} incident(s) enregistr√©(s)`}</p>
            <p>ÔøΩÔøΩÔøΩÔøΩÔøΩ ${alerts.length === 0 ? '‚úÖ Aucune alerte urgente' : `ÔøΩÔøΩ ${alerts.length} alerte(s) d√©clench√©e(s)`}</p>
            <p>‚Ä¢ üëÆ ${patrols.length} patrouille(s) effectu√©e(s)</p>
            ${incidents.length > 0 ? `<p>‚Ä¢ üî¥ Incidents de haute s√©v√©rit√©: ${incidents.filter(i => i.severity === 'high').length}</p>` : ''}
          </div>
        </div>
      `;
      return { html };
    }

    function analyzeMonthlyReport(allIncidents, allAlerts, period) {
      const incidents = allIncidents.filter(i => i.date.startsWith(period));
      const alerts = allAlerts.filter(a => a.timestamp.startsWith(period));
      
      const recommendations = [];
      
      // Analyse par type d'incident
      const incidentTypes = {};
      incidents.forEach(i => {
        incidentTypes[i.title] = (incidentTypes[i.title] || 0) + 1;
      });

      const frequentTypes = Object.entries(incidentTypes)
        .filter(([_, count]) => count >= 2)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (frequentTypes.length > 0) {
        recommendations.push({
          title: 'üìå Patterns d\'Incidents R√©currents',
          text: frequentTypes.map(([type, count]) => `‚Ä¢ ${type}: ${count} occurrences`).join('\n'),
          priority: 'high'
        });
      }

      // Analyse par zone
      const zoneMap = {};
      incidents.forEach(i => {
        zoneMap[i.location] = (zoneMap[i.location] || 0) + 1;
      });

      const hotspots = Object.entries(zoneMap)
        .sort((a, b) => b[1] - a[1])
        .filter(([_, count]) => count >= 2)
        .slice(0, 3);

      if (hotspots.length > 0) {
        recommendations.push({
          title: 'üî¥ Zones √† Risque Identifi√©es',
          text: hotspots.map(([zone, count]) => `‚Ä¢ ${zone}: ${count} incidents`).join('\n'),
          priority: 'high'
        });
      }

      // Analyse des s√©v√©rit√©s
      const highSeverity = incidents.filter(i => i.severity === 'high').length;
      const mediumSeverity = incidents.filter(i => i.severity === 'medium').length;
      
      if (highSeverity > 0) {
        recommendations.push({
          title: '‚ö†Ô∏è Incidents de Haute S√©v√©rit√©',
          text: `${highSeverity} incident(s) de haute s√©v√©rit√© ce mois-ci. N√©cessite une analyse approfondie et renforcement des mesures de s√©curit√©.`,
          priority: 'high'
        });
      }

      // Analyse des alertes
      if (alerts.length > 0) {
        const criticalAlerts = alerts.filter(a => a.severity === 'critical').length;
        recommendations.push({
          title: `üö® Alertes Urgentes: ${alerts.length}`,
          text: `${alerts.length} alerte(s) d√©clench√©e(s) (${criticalAlerts} critique(s)). Temps de r√©ponse √† optimiser.`,
          priority: 'high'
        });
      }

      // Taux de r√©solution
      const resolved = incidents.filter(i => i.status === 'closed').length;
      const resolutionRate = incidents.length > 0 ? Math.round((resolved / incidents.length) * 100) : 0;
      
      let resolutionRecommendation = '';
      if (resolutionRate < 50) {
        resolutionRecommendation = '‚è∞ Taux de r√©solution bas - Augmentez les ressources d\'enqu√™te';
        recommendations.push({ title: 'üìä Taux de R√©solution', text: resolutionRecommendation, priority: 'medium' });
      }

      const html = `
        <div style="background: linear-gradient(135deg, #fff7ed 0%, #fefce8 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
          <h4 style="font-weight: 600; color: #92400e; margin-bottom: 10px;">üìä Analyse Mensuelle & Recommandations</h4>
          <div style="color: #92400e; font-size: 13px; line-height: 1.8;">
            ${recommendations.map(rec => `
              <div style="margin-bottom: 12px; background: white; padding: 10px; border-radius: 6px; border-left: 3px solid ${rec.priority === 'high' ? '#ef4444' : '#f59e0b'};">
                <strong>${rec.title}</strong><br>
                <span style="white-space: pre-wrap;">${rec.text}</span>
              </div>
            `).join('')}
            ${recommendations.length === 0 ? '<p>‚úÖ Mois s√©curis√© - Aucune recommandation majeure</p>' : ''}
          </div>
        </div>
      `;

      return { html, recommendations };
    }

    function analyzeAnnualReport(allIncidents, allAlerts, year) {
      const incidents = allIncidents.filter(i => i.date.startsWith(year));
      const alerts = allAlerts.filter(a => a.timestamp.startsWith(year));
      
      const recommendations = [];

      // Analyse par mois
      const monthlyIncidents = {};
      incidents.forEach(i => {
        const month = i.date.substring(0, 7);
        monthlyIncidents[month] = (monthlyIncidents[month] || 0) + 1;
      });

      const sortedMonths = Object.entries(monthlyIncidents)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (sortedMonths.length > 0) {
        const avgMonthly = Math.round(incidents.length / 12);
        const peakMonth = sortedMonths[0][0];
        const peakCount = sortedMonths[0][1];
        
        recommendations.push({
          title: `üìà Variation Saisonni√®re D√©tect√©e`,
          text: `Pic en ${peakMonth} avec ${peakCount} incidents. Moyenne mensuelle: ${avgMonthly} incidents. Les mois ${sortedMonths.map(m => m[0]).join(', ')} n√©cessitent un renforcement particulier.`,
          priority: 'high'
        });
      }

      // Analyse des tendances par type
      const incidentTypes = {};
      incidents.forEach(i => {
        incidentTypes[i.title] = (incidentTypes[i.title] || 0) + 1;
      });

      const topThreats = Object.entries(incidentTypes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (topThreats.length > 0) {
        recommendations.push({
          title: 'üéØ Top 3 Types d\'Incidents',
          text: topThreats.map(([type, count], idx) => `${idx + 1}. ${type}: ${count} occurrences (${Math.round((count/incidents.length)*100)}%)`).join('\n'),
          priority: 'high'
        });
      }

      // Analyse g√©ographique annuelle
      const zoneMap = {};
      incidents.forEach(i => {
        zoneMap[i.location] = (zoneMap[i.location] || 0) + 1;
      });

      const criticalZones = Object.entries(zoneMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (criticalZones.length > 0) {
        const totalByZones = criticalZones.reduce((sum, [_, count]) => sum + count, 0);
        recommendations.push({
          title: 'üó∫Ô∏è Zones Critiques Identifi√©es',
          text: `${criticalZones.length} zone(s) concentrent ${totalByZones} incidents (${Math.round((totalByZones/incidents.length)*100)}% du total):\n${criticalZones.map(([zone, count]) => `‚Ä¢ ${zone}: ${count} incidents`).join('\n')}`,
          priority: 'high'
        });
      }

      // Analyse de la s√©v√©rit√©
      const severityCount = {
        high: incidents.filter(i => i.severity === 'high').length,
        medium: incidents.filter(i => i.severity === 'medium').length,
        low: incidents.filter(i => i.severity === 'low').length
      };

      const highSevAvg = Math.round((severityCount.high / incidents.length) * 100);
      if (highSevAvg > 20) {
        recommendations.push({
          title: 'üî¥ Proportion √âlev√©e d\'Incidents Graves',
          text: `${highSevAvg}% des incidents sont de haute s√©v√©rit√©. Cela indique des failles structurelles dans les protocoles de s√©curit√©.`,
          priority: 'high'
        });
      }

      // Analyse des alertes urgentes
      if (alerts.length > 0) {
        const avgAlertsPerMonth = Math.round(alerts.length / 12);
        const criticalAlerts = alerts.filter(a => a.severity === 'critical').length;
        
        recommendations.push({
          title: `üö® Bilan Annuel des Alertes`,
          text: `${alerts.length} alerte(s) urgente(s) d√©clench√©e(s) (moyenne: ${avgAlertsPerMonth}/mois). ${criticalAlerts} alerte(s) critique(s).`,
          priority: alerts.length > 10 ? 'high' : 'medium'
        });
      }

      // Taux de r√©solution annuel
      const resolved = incidents.filter(i => i.status === 'closed').length;
      const resolutionRate = incidents.length > 0 ? Math.round((resolved / incidents.length) * 100) : 0;
      
      let resolutionStatus = resolutionRate >= 80 ? '‚úÖ Excellent' : resolutionRate >= 60 ? 'üü° √Ä am√©liorer' : 'üî¥ Critique';
      
      recommendations.push({
        title: `üìä Taux de R√©solution Annuel: ${resolutionRate}%`,
        text: `${resolutionStatus}. ${resolved}/${incidents.length} incidents r√©solus. ${resolutionRate < 80 ? 'L\'am√©lioration des processus d\'enqu√™te est recommand√©e.' : 'Performance satisfaisante.'}`,
        priority: resolutionRate < 60 ? 'high' : 'low'
      });

      const html = `
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
          <h4 style="font-weight: 600; color: #78350f; margin-bottom: 10px;">üìä Analyse Annuelle & Recommandations Strat√©giques</h4>
          <div style="color: #78350f; font-size: 13px; line-height: 1.8;">
            ${recommendations.map(rec => `
              <div style="margin-bottom: 12px; background: white; padding: 10px; border-radius: 6px; border-left: 3px solid ${rec.priority === 'high' ? '#ef4444' : rec.priority === 'medium' ? '#f59e0b' : '#10b981'};">
                <strong>${rec.title}</strong><br>
                <span style="white-space: pre-wrap;">${rec.text}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      return { html, recommendations };
    }

    function calculateAvgResolutionTime(incidents) {
      if (incidents.length === 0) return 0;
      const resolved = incidents.filter(i => i.status === 'closed');
      if (resolved.length === 0) return 0;
      
      const totalDays = resolved.reduce((sum, i) => {
        const incidentDate = new Date(i.date);
        const today = new Date();
        return sum + Math.floor((today - incidentDate) / (1000 * 60 * 60 * 24));
      }, 0);
      
      return Math.round(totalDays / resolved.length);
    }

    async function handleAddRecipient(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const recipient = {
        type: 'recipient',
        recipient_name: document.getElementById('recipient-name').value,
        recipient_email: document.getElementById('recipient-email').value,
        recipient_phone: document.getElementById('recipient-phone').value,
        recipient_role: document.getElementById('recipient-role').value,
        created_date: new Date().toISOString().split('T')[0]
      };

      const result = await window.dataSdk.create(recipient);
      
      btn.disabled = false;
      btn.innerHTML = '‚ûï Ajouter Destinataire';

      if (result.isOk) {
        showToast('‚úÖ Destinataire ajout√© avec succ√®s', 'success');
        e.target.reset();
      } else {
        showToast('‚ùå Erreur lors de l\'ajout', 'error');
      }
    }

    function updateRecipientsList() {
      const recipients = allData.filter(d => d.type === 'recipient');
      const container = document.getElementById('recipients-list');
      const listContainer = document.getElementById('recipients-list-container');
      const selectEl = document.getElementById('report-recipient-select');

      allRecipients = recipients;

      if (recipients.length === 0) {
        listContainer.style.display = 'none';
        selectEl.innerHTML = '<option value="">S√©lectionner un destinataire...</option>';
        return;
      }

      listContainer.style.display = 'block';
      
      container.innerHTML = recipients.map((r, idx) => `
        <div class="record-item">
          <div class="record-info" style="flex: 1;">
            <div class="record-title">üë§ ${r.recipient_name}</div>
            <div class="record-meta">
              <span>üìß ${r.recipient_email}</span>
              ${r.recipient_phone ? `<span>üìû ${r.recipient_phone}</span>` : ''}
              <span>üè¢ ${r.recipient_role}</span>
            </div>
          </div>
          <button class="btn btn-danger" onclick="deleteRecipient(${idx})">üóëÔ∏è Supprimer</button>
        </div>
      `).join('');

      selectEl.innerHTML = '<option value="">S√©lectionner un destinataire...</option>' + recipients.map((r, idx) => `
        <option value="${idx}">${r.recipient_name} (${r.recipient_role}) - ${r.recipient_email}</option>
      `).join('');
    }

    async function deleteRecipient(index) {
      const recipients = allData.filter(d => d.type === 'recipient');
      const recipient = recipients[index];
      if (!recipient) return;

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '√ätes-vous s√ªr?';
      btn.style.background = '#991b1b';

      const confirmDelete = async () => {
        const result = await window.dataSdk.delete(recipient);
        if (result.isOk) {
          showToast('‚úÖ Destinataire supprim√©', 'success');
        } else {
          showToast('‚ùå Erreur lors de la suppression', 'error');
        }
        btn.textContent = originalText;
        btn.style.background = '#ef4444';
        btn.removeEventListener('click', confirmDelete);
        btn.addEventListener('click', () => deleteRecipient(index));
      };

      btn.removeEventListener('click', () => deleteRecipient(index));
      btn.addEventListener('click', confirmDelete);

      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#ef4444';
        btn.removeEventListener('click', confirmDelete);
        btn.addEventListener('click', () => deleteRecipient(index));
      }, 3000);
    }

    async function sendRecommendation(index) {
      const recommendations = getIncidentPatterns();
      const recommendation = recommendations[index];

      if (!recommendation) return;

      const recipients = allData.filter(d => d.type === 'recipient');
      const decisionMakers = recipients.filter(r => 
        r.recipient_role.toLowerCase().includes('directeur') ||
        r.recipient_role.toLowerCase().includes('manager') ||
        r.recipient_role.toLowerCase().includes('responsable') ||
        r.recipient_role.toLowerCase().includes('superviseur') ||
        r.recipient_role.toLowerCase().includes('d√©cideur')
      );

      if (decisionMakers.length === 0) {
        showToast('‚ö†Ô∏è Aucun d√©cideur configur√©. Ajoutez des destinataires avec le r√¥le appropri√©.', 'error');
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      let successCount = 0;

      for (const decisionMaker of decisionMakers) {
        const record = {
          type: 'recommendation_sent',
          recommendation_title: recommendation.title,
          recommendation_text: recommendation.text,
          recommendation_priority: recommendation.priority,
          recipient_name: decisionMaker.recipient_name,
          recipient_email: decisionMaker.recipient_email,
          recipient_phone: decisionMaker.recipient_phone,
          recipient_role: decisionMaker.recipient_role,
          send_date: new Date().toISOString().split('T')[0],
          send_time: new Date().toTimeString().substring(0, 5),
          incident_count: recommendation.count,
          location: recommendation.location
        };

        const result = await window.dataSdk.create(record);
        if (result.isOk) {
          successCount++;
          
          const subject = encodeURIComponent(`üö® RECOMMANDATION DE S√âCURIT√â - ${recommendation.priority.toUpperCase()}`);
          const emailBody = encodeURIComponent(`
RECOMMANDATION DE S√âCURIT√â URGENTE

Priorit√©: ${recommendation.priority === 'high' ? 'üî¥ √âLEV√âE' : recommendation.priority === 'medium' ? 'üü° MOYENNE' : 'üü¢ BASSE'}

Titre: ${recommendation.title}
Localisation: ${recommendation.location}
Nombre d'incidents: ${recommendation.count}

D√©tails:
${recommendation.text}

---
√Ä: ${decisionMaker.recipient_name} (${decisionMaker.recipient_role})
Date: ${new Date().toLocaleDateString('fr-FR')}

G√©n√©r√© par AUTOREPORT - Plateforme de S√©curit√©
          `);
          
          window.open(`mailto:${decisionMaker.recipient_email}?subject=${subject}&body=${emailBody}`, '_blank');
        }
      }

      btn.disabled = false;
      btn.textContent = originalText;

      if (successCount > 0) {
        showToast(`‚úÖ Recommandation envoy√©e √† ${successCount} d√©cideur(s)!`, 'success');
      }
    }

    async function sendReport() {
      const recipientIdx = parseInt(document.getElementById('report-recipient-select').value);
      const method = document.getElementById('report-method').value;
      const message = document.getElementById('report-message').value;

      if (isNaN(recipientIdx)) {
        showToast('‚ùå Veuillez s√©lectionner un destinataire', 'error');
        return;
      }

      if (!reportData) {
        showToast('‚ùå Veuillez d\'abord g√©n√©rer un rapport', 'error');
        return;
      }

      const recipients = allData.filter(d => d.type === 'recipient');
      const recipient = recipients[recipientIdx];

      if (!recipient) {
        showToast('‚ùå Destinataire non trouv√©', 'error');
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      const reportRecord = {
        type: 'report_sent',
        report_type: document.getElementById('report-type').value,
        recipient_name: recipient.recipient_name,
        recipient_email: recipient.recipient_email,
        recipient_phone: recipient.recipient_phone,
        recipient_role: recipient.recipient_role,
        send_method: method,
        send_date: new Date().toISOString().split('T')[0],
        send_time: new Date().toTimeString().substring(0, 5),
        personal_message: message,
        incidents_count: reportData.incidents.length,
        alerts_count: reportData.alerts.length,
        patrols_count: reportData.patrols.length
      };

      const result = await window.dataSdk.create(reportRecord);
      
      btn.disabled = false;
      btn.innerHTML = 'üì§ G√©n√©rer et Envoyer';

      if (result.isOk) {
        const reportSummary = `
üö® RAPPORT DE S√âCURIT√â - ${reportData.title}

üë§ Destinataire: ${recipient.recipient_name} (${recipient.recipient_role})
üìÖ Date: ${new Date().toLocaleDateString('fr-FR')}

üìä R√âSUM√â:
- Incidents: ${reportData.incidents.length}
- Alertes: ${reportData.alerts.length}
- Patrouilles: ${reportData.patrols.length}

${message ? `\nüìù Message: ${message}` : ''}

Rapport g√©n√©r√© par AUTOREPORT - Plateforme de S√©curit√©
        `;

        if (method === 'email' || method === 'both') {
          const subject = encodeURIComponent(`AUTOREPORT - ${reportData.title}`);
          const body = encodeURIComponent(reportSummary);
          window.open(`mailto:${recipient.recipient_email}?subject=${subject}&body=${body}`, '_blank');
        }

        if (method === 'sms' || method === 'both') {
          if (recipient.recipient_phone) {
            const smsMessage = encodeURIComponent(`AUTOREPORT - ${reportData.title}\nIncidents: ${reportData.incidents.length}\nAlertes: ${reportData.alerts.length}\nPatrouilles: ${reportData.patrols.length}`);
            window.open(`sms:${recipient.recipient_phone}?body=${smsMessage}`, '_blank');
          }
        }

        showToast(`‚úÖ Rapport envoyÔøΩÔøΩ √† ${recipient.recipient_name}`, 'success');
        document.getElementById('report-message').value = '';
      } else {
        showToast('‚ùå Erreur lors de l\'envoi', 'error');
      }
    }

    function updateCurrentDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const date = new Date().toLocaleDateString('fr-FR', options);
      document.getElementById('current-date').textContent = date;
    }

    function capitalize(str) {
      const map = {
        'high': '√âlev√©',
        'medium': 'Moyen',
        'low': 'Faible',
        'open': 'Ouvert',
        'closed': 'Ferm√©',
        'critical': 'CRITIQUE',
        'pending': 'En attente'
      };
      return map[str] || str;
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    initApp();

    window.addEventListener('load', () => {
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById('incident-date')) document.getElementById('incident-date').value = today;
      if (document.getElementById('patrol-date')) document.getElementById('patrol-date').value = today;
      const currentMonth = new Date().toISOString().slice(0, 7);
      if (document.getElementById('report-month')) document.getElementById('report-month').value = currentMonth;
    });

    window.addEventListener('click', (e) => {
      const modal = document.getElementById('modal-overlay');
      if (e.target === modal) {
        closeModal();
      }
     function toggleAdminLogin() {
  const adminForm = document.getElementById('admin-login-form');
  const loginForm = document.getElementById('login-form');
  
  if (adminForm.style.display === 'none' || adminForm.style.display === '') {
    adminForm.style.display = 'block';
    loginForm.style.display = 'none';
    document.getElementById('admin-password-input').focus();
  } else {
    adminForm.style.display = 'none';
    loginForm.style.display = 'block';
  }
}

function handleAdminLogin(event) {
  event.preventDefault();
  const password = document.getElementById('admin-password-input').value;
  const errorDiv = document.getElementById('admin-login-error');
  
  if (password === 'admin123') {
    sessionStorage.setItem('adminLoggedIn', 'true');
    window.location.href = '/admin';
  } else {
    errorDiv.textContent = '‚ùå Mot de passe incorrect';
  }
}
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cc25e9e87a27400',t:'MTc3MDc5NzQyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
