<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoReport ‚Äî Plateforme de S√©curit√©</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&amp;family=JetBrains+Mono:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Outfit', sans-serif; }

    :root {
      --bg-primary: #0a0e1a;
      --bg-surface: #111827;
      --text-main: #e2e8f0;
      --accent-primary: #3b82f6;
      --accent-danger: #ef4444;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-main);
    }

    .container-app {
      height: 100%;
      width: 100%;
      overflow: auto;
    }

    .glass-card {
      background: rgba(17, 24, 39, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 16px;
    }

    .glow-border {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.1), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .fade-in {
      animation: fadeSlide 0.4s ease-out forwards;
      opacity: 0;
    }
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-secondary {
      background: rgba(59,130,246,0.15);
      color: #93c5fd;
      border: 1px solid rgba(59,130,246,0.3);
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover { background: rgba(59,130,246,0.25); }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn-danger:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(239,68,68,0.4); }

    .form-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      color: #e2e8f0;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 12px rgba(59,130,246,0.2); }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      animation: fadeSlide 0.3s ease-out;
      max-width: 360px;
    }
    .toast-success { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); color: #86efac; }
    .toast-error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #fca5a5; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: #111827;
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 16px;
      padding: 28px;
      max-width: 520px;
      width: 100%;
      max-height: 80%;
      overflow-y: auto;
      margin: auto;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-active { background: rgba(34,197,94,0.2); color: #86efac; }
    .badge-expired { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .badge-pending { background: rgba(234,179,8,0.2); color: #fde047; }

    .login-container {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 50%, #0a0e1a 100%);
    }

    .login-card {
      width: 100%;
      max-width: 420px;
    }

    .logo-brand {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header-bar {
      background: rgba(17,24,39,0.95);
      border-bottom: 1px solid rgba(59,130,246,0.15);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: rgba(59,130,246,0.15);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .pulse-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .mono { font-family: 'JetBrains Mono', monospace; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(59,130,246,0.15);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.6;
    }

    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table th {
      background: rgba(59,130,246,0.1);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid rgba(59,130,246,0.2);
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid rgba(59,130,246,0.1);
    }

    .table tr:hover { background: rgba(59,130,246,0.05); }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-family: 'Outfit', sans-serif;
      transition: all 0.2s;
      margin-right: 4px;
    }

    .btn-sm-primary { background: rgba(59,130,246,0.3); color: #93c5fd; }
    .btn-sm-primary:hover { background: rgba(59,130,246,0.5); }

    .btn-sm-danger { background: rgba(239,68,68,0.3); color: #fca5a5; }
    .btn-sm-danger:hover { background: rgba(239,68,68,0.5); }

    .pending-verification {
      background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(249,115,22,0.1));
      border: 1px solid rgba(234,179,8,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .pending-verification p {
      font-size: 13px;
      line-height: 1.5;
    }

    .admin-tab-content { display: none; }
    .admin-tab-content.active { display: block; }

    .tab-nav { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 16px; border-radius: 8px; background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); cursor: pointer; font-weight: 500; font-family: 'Outfit', sans-serif; transition: all 0.2s; }
    .tab-btn.active { background: rgba(59,130,246,0.3); }
    .tab-btn:hover { background: rgba(59,130,246,0.25); }

    .invitation-box {
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 12px;
      padding: 12px;
      font-size: 12px;
      margin-bottom: 8px;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div class="container-app" id="appContainer">
   <div class="toast-container" id="toastContainer"></div>
   <div class="modal-overlay" id="modalOverlay"></div><!-- LOGIN PAGE -->
   <div id="loginPage" class="login-container fade-in">
    <div class="login-card">
     <div class="glass-card glow-border p-8">
      <div class="logo-brand">
       üîê AutoReport
      </div>
      <p class="text-sm opacity-60 mb-6">Plateforme de Gestion de S√©curit√© Confidentielle</p>
      <div id="loginTabs" class="tab-nav mb-6"><button class="tab-btn active" id="loginTab">üîì Connexion</button> <button class="tab-btn" id="invitationTab">üìß Invitation</button>
      </div><!-- Login Form -->
      <form id="loginForm" class="flex flex-col gap-4">
       <div><label class="form-label">Email de l'entreprise</label> <input type="email" id="emailInput" class="form-input" placeholder="contact@entreprise.com" required>
       </div>
       <div><label class="form-label">Mot de passe</label> <input type="password" id="passwordInput" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
       </div><button type="submit" class="btn-primary flex items-center justify-center gap-2 mt-2"> <span id="loginText">üîì Connexion</span> <span id="loginSpinner" class="loading-spinner" style="display:none;"></span> </button>
      </form><!-- Invitation Form -->
      <form id="invitationForm" class="flex flex-col gap-4" style="display:none;">
       <p class="text-sm opacity-70 mb-2">Vous avez re√ßu une invitation AutoReport ? Entrez vos informations :</p>
       <div><label class="form-label">Token d'invitation</label> <input type="text" id="invitationToken" class="form-input" placeholder="Collez votre token d'invitation" required>
       </div>
       <div><label class="form-label">Email</label> <input type="email" id="invitationEmail" class="form-input" placeholder="contact@entreprise.com" required>
       </div>
       <div><label class="form-label">Cr√©er un mot de passe</label> <input type="password" id="invitationPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
       </div>
       <div><label class="form-label">Confirmer le mot de passe</label> <input type="password" id="invitationPasswordConfirm" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
       </div><button type="submit" class="btn-primary flex items-center justify-center gap-2 mt-2"> <span id="invitationText">‚úÖ Accepter l'invitation</span> <span id="invitationSpinner" class="loading-spinner" style="display:none;"></span> </button>
      </form>
      <div class="mt-6 p-4 rounded-lg" style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);">
       <p class="text-xs opacity-70 mb-3"><strong>üß™ Comptes de test:</strong></p>
       <div class="mono text-xs space-y-1 opacity-60">
        <div>
         <strong>Admin:</strong> admin@autoreport.com / admin123
        </div>
        <div>
         <strong>Entreprise 1:</strong> secure1@test.com / pass123
        </div>
        <div>
         <strong>Entreprise 2:</strong> secure2@test.com / pass123
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- DASHBOARD PAGE -->
   <div id="dashboardPage" class="hidden" style="display:none; height: 100%; overflow: auto;">
    <div class="header-bar">
     <div class="flex items-center gap-3">
      <div class="logo-brand" style="font-size: 20px;">
       AutoReport
      </div>
      <div id="headerEnterprise" class="text-sm font-semibold opacity-80">
       Entreprise
      </div>
     </div>
     <div class="flex items-center gap-4">
      <div id="subscriptionStatus" class="status-pill">
       <div class="pulse-dot"></div><span id="subStatusText">Actif</span>
      </div><button id="logoutBtn" class="btn-secondary text-sm">üö™ D√©connexion</button>
     </div>
    </div>
    <main class="p-6" id="mainContent">
     <div class="flex items-center justify-center py-12">
      <div class="loading-spinner" style="width: 32px; height: 32px;"></div>
     </div>
    </main>
   </div><!-- ADMIN PAGE -->
   <div id="adminPage" class="hidden" style="display:none; height: 100%; overflow: auto;">
    <div class="header-bar">
     <div class="logo-brand" style="font-size: 20px;">
      AutoReport ‚Äî Admin
     </div><button id="adminLogoutBtn" class="btn-secondary text-sm">üö™ D√©connexion</button>
    </div>
    <main class="p-6" id="adminContent"><!-- Will be populated -->
    </main>
   </div>
  </div>
  <script>
(async function() {
  // ==================== STATE ====================
  let allRecords = [];
  let currentUser = null;
  const ADMIN_EMAIL = 'admin@autoreport.com';
  const ADMIN_PASSWORD = 'admin123';

  const testAccounts = [
    { email: ADMIN_EMAIL, password: ADMIN_PASSWORD, role: 'admin' },
    { email: 'secure1@test.com', password: 'pass123', role: 'user', enterprise_name: 'S√©curit√© Pro SA' },
    { email: 'secure2@test.com', password: 'pass123', role: 'user', enterprise_name: 'Vigilance Express' },
  ];

  // ==================== HELPERS ====================
  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function showModal(html) {
    const overlay = document.getElementById('modalOverlay');
    overlay.classList.add('active');
    overlay.innerHTML = `<div class="modal-content fade-in">${html}</div>`;
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
  }

  function formatDate(isoStr) {
    if (!isoStr) return '‚Äî';
    const d = new Date(isoStr);
    return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function generateInvitationToken() {
    return 'INV-' + Math.random().toString(36).substring(2, 15).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
  }

  function generateAccessKey() {
    return 'ARK-' + Math.random().toString(36).substring(2, 15).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
  }

  window.closeModal = closeModal;

  // ==================== AUTHENTICATION ====================
  function login(email, password) {
    const account = testAccounts.find(a => a.email === email && a.password === password);
    if (!account) return null;
    
    // Check if user accepted invitation in database
    const userRecord = allRecords.find(r => 
      r.record_type === 'user' && 
      r.user_email === email && 
      r.invitation_accepted === true
    );
    
    if (!account.role === 'admin' && !userRecord) return null;
    
    return {
      email,
      role: account.role,
      enterprise_name: userRecord?.enterprise_name || account.enterprise_name || 'AutoReport Admin',
      enterprise_id: account.role === 'admin' ? 'admin' : userRecord?.enterprise_id,
      created_at: new Date().toISOString()
    };
  }

  function logout() {
    currentUser = null;
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('adminPage').style.display = 'none';
    document.getElementById('loginForm').reset();
    document.getElementById('invitationForm').reset();
    showToast('üëã D√©connect√© avec succ√®s.', 'success');
  }

  // ==================== DATA FILTERING ====================
  function getCompanyRecords() {
    return allRecords.filter(r => r.record_type === 'enterprise');
  }

  function getSubscriptionRecords() {
    return allRecords.filter(r => r.record_type === 'subscription');
  }

  function getAccessRecords() {
    return allRecords.filter(r => r.record_type === 'access_key');
  }

  function getInvitationRecords() {
    return allRecords.filter(r => r.record_type === 'invitation');
  }

  function getEnterpriseData() {
    if (!currentUser) return [];
    if (currentUser.role === 'admin') return allRecords;
    return allRecords.filter(r => r.enterprise_id === currentUser.enterprise_id);
  }

  // ==================== DASHBOARD ====================
  function renderDashboard() {
    const data = getEnterpriseData();
    const alerts = data.filter(r => r.record_type === 'alert');
    const patrols = data.filter(r => r.record_type === 'patrol');
    const reports = data.filter(r => r.record_type === 'report');

    const subRecord = allRecords.find(r => r.record_type === 'subscription' && r.enterprise_id === currentUser.enterprise_id);
    const isSubscriptionActive = subRecord && new Date(subRecord.subscription_end_date) > new Date();

    document.getElementById('headerEnterprise').textContent = currentUser.enterprise_name;
    document.getElementById('subStatusText').textContent = isSubscriptionActive ? '‚úÖ Actif' : '‚ùå Expir√©';

    if (!isSubscriptionActive) {
      document.getElementById('mainContent').innerHTML = `
        <div class="pending-verification fade-in">
          <div class="text-2xl mb-3">‚è∞ Abonnement Expir√©</div>
          <p>Votre abonnement AutoReport a expir√© le <strong>${formatDate(subRecord?.subscription_end_date)}</strong>.</p>
          <p class="mt-3">Veuillez <strong>contacter l'administrateur</strong> pour renouveler votre acc√®s.</p>
          <p class="text-xs opacity-50 mt-4">Email admin: ${ADMIN_EMAIL}</p>
        </div>
      `;
      return;
    }

    document.getElementById('mainContent').innerHTML = `
      <div class="fade-in">
        <h1 class="text-2xl font-bold mb-2">Bienvenue, ${currentUser.enterprise_name}</h1>
        <p class="text-sm opacity-60 mb-6">Centre de commandement pour la gestion de vos incidents et patrouilles</p>

        <div class="stat-grid">
          <div class="stat-box">
            <div class="stat-value" style="color: #ef4444;">${alerts.length}</div>
            <div class="stat-label">Alertes Totales</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" style="color: #3b82f6;">${patrols.length}</div>
            <div class="stat-label">Patrouilles</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" style="color: #eab308;">${reports.length}</div>
            <div class="stat-label">Rapports OPJ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" style="color: #22c55e;">${alerts.filter(r=>r.status==='resolved').length}</div>
            <div class="stat-label">R√©solus</div>
          </div>
        </div>

        <div class="glass-card glow-border p-5">
          <h2 class="font-bold text-lg mb-4">üìã Donn√©es Confidentiales</h2>
          <p class="text-sm opacity-60 mb-4">Vos donn√©es sont isol√©es et s√©curis√©es dans une base de donn√©es d√©di√©e √† <strong>${currentUser.enterprise_name}</strong>.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-lg" style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);">
              <div class="font-semibold text-sm mb-2">üîê Entreprise ID</div>
              <div class="mono text-xs opacity-70 break-all">${currentUser.enterprise_id}</div>
            </div>
            <div class="p-4 rounded-lg" style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);">
              <div class="font-semibold text-sm mb-2">üìß Email d'acc√®s</div>
              <div class="mono text-xs opacity-70 break-all">${currentUser.email}</div>
            </div>
          </div>
        </div>

        <div class="glass-card glow-border p-5 mt-4">
          <h2 class="font-bold text-lg mb-3">‚ÑπÔ∏è √Ä propos d'AutoReport</h2>
          <p class="text-sm opacity-70 leading-relaxed">AutoReport est une plateforme SaaS s√©curis√©e pour la gestion des incidents de s√©curit√©. Chaque entreprise dispose d'une base de donn√©es confidentielle isol√©e. L'acc√®s est contr√¥l√© par abonnement mensuel pour garantir la s√©curit√© et la confidentialit√© de vos donn√©es.</p>
        </div>
      </div>
    `;
  }

  // ==================== ADMIN PANEL ====================
  function renderAdminPanel() {
    const companies = getCompanyRecords();
    const subscriptions = getSubscriptionRecords();
    const accessKeys = getAccessRecords();
    const invitations = getInvitationRecords();

    let html = `
      <div class="fade-in">
        <h1 class="text-2xl font-bold mb-6">üõ°Ô∏è Panneau d'Administration</h1>

        <div class="tab-nav">
          <button class="tab-btn active" data-tab="companies">üìã Entreprises (${companies.length})</button>
          <button class="tab-btn" data-tab="invitations">üìß Invitations (${invitations.length})</button>
          <button class="tab-btn" data-tab="subscriptions">üí≥ Abonnements (${subscriptions.length})</button>
          <button class="tab-btn" data-tab="access">üîë Acc√®s (${accessKeys.length})</button>
        </div>

        <!-- Companies -->
        <div id="companies" class="admin-tab-content active">
          <div class="glass-card glow-border p-5 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="font-bold text-lg">Entreprises Enregistr√©es</h2>
              <button class="btn-primary text-sm flex items-center gap-2" id="addCompanyBtn">
                <span>‚ûï Ajouter</span>
              </button>
            </div>
            <div class="table-container">
              <table class="table">
                <thead><tr><th>Nom</th><th>Email Admin</th><th>Plan</th><th>Cr√©√©e</th><th>BD</th><th>Actions</th></tr></thead>
                <tbody>
                  ${companies.length === 0 ? '<tr><td colspan="6" class="text-center opacity-50 py-4">Aucune entreprise</td></tr>' :
                    companies.map(c => `<tr>
                      <td><strong>${c.enterprise_name || '‚Äî'}</strong></td>
                      <td class="mono text-xs">${c.user_email || '‚Äî'}</td>
                      <td>${c.plan_type || '‚Äî'}</td>
                      <td>${formatDate(c.created_at)}</td>
                      <td><span class="badge badge-active">‚úÖ BD</span></td>
                      <td><button class="btn-sm btn-sm-danger" onclick="deleteCompany('${c.__backendId}')">üóëÔ∏è</button></td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Invitations -->
        <div id="invitations" class="admin-tab-content">
          <div class="glass-card glow-border p-5 mb-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="font-bold text-lg">üìß Invitations Envoy√©es</h2>
              <button class="btn-primary text-sm flex items-center gap-2" id="sendInvitationBtn">
                <span>‚ûï Envoyer Invitation</span>
              </button>
            </div>
            <div class="table-container">
              <table class="table">
                <thead><tr><th>Entreprise</th><th>Email</th><th>Plan</th><th>Token</th><th>Statut</th><th>Cr√©√©e</th><th>Actions</th></tr></thead>
                <tbody>
                  ${invitations.length === 0 ? '<tr><td colspan="7" class="text-center opacity-50 py-4">Aucune invitation</td></tr>' :
                    invitations.map(inv => `<tr>
                      <td><strong>${inv.enterprise_name || '‚Äî'}</strong></td>
                      <td class="mono text-xs text-wrap">${inv.user_email || '‚Äî'}</td>
                      <td>${inv.plan_type || '‚Äî'}</td>
                      <td class="mono text-xs">${inv.invitation_token.substring(0, 20)}...</td>
                      <td><span class="badge ${inv.invitation_accepted ? 'badge-active' : 'badge-pending'}">${inv.invitation_accepted ? '‚úÖ Accept√©e' : '‚è≥ Attente'}</span></td>
                      <td>${formatDate(inv.created_at)}</td>
                      <td>
                        <button class="btn-sm btn-sm-primary" onclick="copyInvitationLink('${inv.invitation_token}')">üìã</button>
                        <button class="btn-sm btn-sm-danger" onclick="revokeInvitation('${inv.__backendId}')">üö´</button>
                      </td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Subscriptions -->
        <div id="subscriptions" class="admin-tab-content">
          <div class="glass-card glow-border p-5">
            <h2 class="font-bold text-lg mb-4">üí≥ Gestion des Abonnements</h2>
            <div class="table-container">
              <table class="table">
                <thead><tr><th>Entreprise</th><th>Plan</th><th>Statut</th><th>Fin</th><th>Jours Restants</th><th>Actions</th></tr></thead>
                <tbody>
                  ${subscriptions.length === 0 ? '<tr><td colspan="6" class="text-center opacity-50 py-4">Aucun abonnement</td></tr>' :
                    subscriptions.map(s => {
                      const isActive = new Date(s.subscription_end_date) > new Date();
                      const daysLeft = Math.ceil((new Date(s.subscription_end_date) - new Date()) / (1000 * 60 * 60 * 24));
                      return `<tr>
                        <td><strong>${s.enterprise_name || '‚Äî'}</strong></td>
                        <td>${s.plan_type || 'Pro'}</td>
                        <td><span class="badge ${isActive ? 'badge-active' : 'badge-expired'}">${isActive ? '‚úÖ Actif' : '‚ùå Expir√©'}</span></td>
                        <td>${formatDate(s.subscription_end_date)}</td>
                        <td>${isActive ? daysLeft + ' j' : '0 j'}</td>
                        <td><button class="btn-sm btn-sm-primary" onclick="renewSubscription('${s.__backendId}')">üîÑ +1 mois</button></td>
                      </tr>`;
                    }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Access Keys -->
        <div id="access" class="admin-tab-content">
          <div class="glass-card glow-border p-5">
            <h2 class="font-bold text-lg mb-4">üîë Cl√©s d'Acc√®s S√©curis√©es</h2>
            <div class="table-container">
              <table class="table">
                <thead><tr><th>Entreprise</th><th>Cl√©</th><th>Cr√©√©e</th><th>Actions</th></tr></thead>
                <tbody>
                  ${accessKeys.length === 0 ? '<tr><td colspan="4" class="text-center opacity-50 py-4">Aucune cl√©</td></tr>' :
                    accessKeys.map(k => `<tr>
                      <td><strong>${k.enterprise_name || '‚Äî'}</strong></td>
                      <td class="mono text-xs">${k.access_token}</td>
                      <td>${formatDate(k.created_at)}</td>
                      <td>
                        <button class="btn-sm btn-sm-primary" onclick="copyToClipboard('${k.access_token}')">üìã</button>
                        <button class="btn-sm btn-sm-danger" onclick="revokeAccess('${k.__backendId}')">üö´</button>
                      </td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    `;

    document.getElementById('adminContent').innerHTML = html;

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    document.getElementById('addCompanyBtn').addEventListener('click', showAddCompanyModal);
    document.getElementById('sendInvitationBtn').addEventListener('click', showSendInvitationModal);
  }

  function showAddCompanyModal() {
    showModal(`
      <h2 class="font-bold text-lg mb-4">‚ûï Nouvelle Entreprise</h2>
      <form id="addCompanyForm" class="flex flex-col gap-3">
        <div>
          <label class="form-label">Nom de l'entreprise</label>
          <input type="text" id="companyName" class="form-input" placeholder="SecureMax SA" required>
        </div>
        <div>
          <label class="form-label">Email administrateur</label>
          <input type="email" id="companyEmail" class="form-input" placeholder="contact@secure.com" required>
        </div>
        <div>
          <label class="form-label">Plan d'abonnement</label>
          <select id="planType" class="form-input">
            <option value="Starter - 99‚Ç¨/mois">üü¢ Starter - 99‚Ç¨/mois</option>
            <option value="Professional - 299‚Ç¨/mois" selected>üîµ Professional - 299‚Ç¨/mois</option>
            <option value="Enterprise - 699‚Ç¨/mois">üü£ Enterprise - 699‚Ç¨/mois</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1">‚úÖ Cr√©er</button>
          <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
        </div>
      </form>
    `);

    document.getElementById('addCompanyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('companyName').value;
      const email = document.getElementById('companyEmail').value;
      const plan = document.getElementById('planType').value;

      if (allRecords.length >= 999) {
        showToast('Limite atteinte.', 'error');
        return;
      }

      const entId = 'ent-' + email.split('@')[0];
      const endDate = new Date();
      endDate.setMonth(endDate.getMonth() + 1);

      // Create enterprise record
      const r1 = await window.dataSdk.create({
        record_type: 'enterprise',
        enterprise_id: entId,
        enterprise_name: name,
        user_email: email,
        user_role: 'admin',
        created_at: new Date().toISOString(),
        subscription_status: 'active',
        subscription_end_date: endDate.toISOString(),
        plan_type: plan,
        payment_status: 'paid',
        title: name, description: '', severity: '', status: '', agent_name: '', location: '', lat: 0, lng: 0, resolved_at: '', category: '', access_token: '', invitation_token: '', invitation_accepted: false, invitation_accepted_at: '', user_password: ''
      });

      if (r1.isOk) {
        // Create subscription record
        const r2 = await window.dataSdk.create({
          record_type: 'subscription',
          enterprise_id: entId,
          enterprise_name: name,
          user_email: email,
          plan_type: plan,
          subscription_status: 'active',
          subscription_end_date: endDate.toISOString(),
          payment_status: 'paid',
          created_at: new Date().toISOString(),
          user_role: 'admin',
          title: `Sub ${name}`, description: '', severity: '', status: '', agent_name: '', location: '', lat: 0, lng: 0, resolved_at: '', category: '', access_token: '', invitation_token: '', invitation_accepted: false, invitation_accepted_at: '', user_password: ''
        });

        if (r2.isOk) {
          const key = generateAccessKey();
          const r3 = await window.dataSdk.create({
            record_type: 'access_key',
            enterprise_id: entId,
            enterprise_name: name,
            user_email: email,
            access_token: key,
            created_at: new Date().toISOString(),
            user_role: 'admin',
            title: `Key ${name}`, description: '', subscription_status: 'active', subscription_end_date: endDate.toISOString(), severity: '', status: '', agent_name: '', location: '', lat: 0, lng: 0, resolved_at: '', category: '', payment_status: '', invitation_token: '', invitation_accepted: false, invitation_accepted_at: '', user_password: ''
          });

          if (r3.isOk) {
            showToast(`‚úÖ Entreprise cr√©√©e!`, 'success');
            closeModal();
          }
        }
      }
    });
  }

  function showSendInvitationModal() {
    showModal(`
      <h2 class="font-bold text-lg mb-4">üìß Envoyer une Invitation</h2>
      <form id="sendInvitationForm" class="flex flex-col gap-3">
        <div>
          <label class="form-label">Nom de l'entreprise</label>
          <input type="text" id="invEntName" class="form-input" placeholder="SecureMax SA" required>
        </div>
        <div>
          <label class="form-label">Email du destinataire</label>
          <input type="email" id="invDestEmail" class="form-input" placeholder="contact@secure.com" required>
        </div>
        <div>
          <label class="form-label">Plan d'abonnement</label>
          <select id="invPlanType" class="form-input">
            <option value="Starter - 99‚Ç¨/mois">üü¢ Starter - 99‚Ç¨/mois</option>
            <option value="Professional - 299‚Ç¨/mois" selected>üîµ Professional - 299‚Ç¨/mois</option>
            <option value="Enterprise - 699‚Ç¨/mois">üü£ Enterprise - 699‚Ç¨/mois</option>
          </select>
        </div>
        <p class="text-xs opacity-60">‚ö†Ô∏è L'utilisateur recevra un token pour accepter l'invitation et cr√©er un compte.</p>
        <div class="flex gap-3">
          <button type="submit" class="btn-primary flex-1">‚úÖ Envoyer</button>
          <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
        </div>
      </form>
    `);

    document.getElementById('sendInvitationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('invEntName').value;
      const email = document.getElementById('invDestEmail').value;
      const plan = document.getElementById('invPlanType').value;

      if (allRecords.length >= 999) {
        showToast('Limite atteinte.', 'error');
        return;
      }

      const entId = 'ent-' + email.split('@')[0];
      const token = generateInvitationToken();
      const endDate = new Date();
      endDate.setMonth(endDate.getMonth() + 1);

      // Create invitation record
      const result = await window.dataSdk.create({
        record_type: 'invitation',
        enterprise_id: entId,
        enterprise_name: name,
        user_email: email,
        plan_type: plan,
        invitation_token: token,
        invitation_accepted: false,
        created_at: new Date().toISOString(),
        subscription_status: 'pending',
        subscription_end_date: endDate.toISOString(),
        user_role: 'user',
        title: `Invitation ${name}`, description: '', severity: '', status: '', agent_name: '', location: '', lat: 0, lng: 0, resolved_at: '', category: '', access_token: '', payment_status: '', invitation_accepted_at: '', user_password: ''
      });

      if (result.isOk) {
        showToast(`‚úÖ Invitation envoy√©e √† ${email}!`, 'success');
        closeModal();
      }
    });
  }

  window.deleteCompany = async function(id) {
    const rec = allRecords.find(r => r.__backendId === id);
    if (rec) {
      const res = await window.dataSdk.delete(rec);
      if (res.isOk) showToast('üóëÔ∏è Supprim√©e.', 'success');
    }
  };

  window.copyInvitationLink = function(token) {
    navigator.clipboard.writeText(token);
    showToast('üìã Token copi√©! Partagez-le avec l\'utilisateur.', 'success');
  };

  window.revokeInvitation = async function(id) {
    const rec = allRecords.find(r => r.__backendId === id);
    if (rec) {
      const res = await window.dataSdk.delete(rec);
      if (res.isOk) showToast('üö´ Invitation r√©voqu√©e.', 'success');
    }
  };

  window.renewSubscription = async function(id) {
    const rec = allRecords.find(r => r.__backendId === id);
    if (rec) {
      const d = new Date();
      d.setMonth(d.getMonth() + 1);
      const res = await window.dataSdk.update({ ...rec, subscription_status: 'active', subscription_end_date: d.toISOString(), payment_status: 'paid' });
      if (res.isOk) showToast('‚úÖ Abonnement renouvel√© d\'1 mois.', 'success');
    }
  };

  window.copyToClipboard = function(t) {
    navigator.clipboard.writeText(t);
    showToast('üìã Copi√©!', 'success');
  };

  window.revokeAccess = async function(id) {
    const rec = allRecords.find(r => r.__backendId === id);
    if (rec) {
      const res = await window.dataSdk.delete(rec);
      if (res.isOk) showToast('üö´ Cl√© r√©voqu√©e.', 'success');
    }
  };

  // ==================== LOGIN TABS ====================
  document.getElementById('loginTab').addEventListener('click', () => {
    document.getElementById('loginForm').style.display = 'flex';
    document.getElementById('invitationForm').style.display = 'none';
  });

  document.getElementById('invitationTab').addEventListener('click', () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('invitationForm').style.display = 'flex';
  });

  // ==================== LOGIN FORM ====================
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('emailInput').value;
    const pwd = document.getElementById('passwordInput').value;
    const user = login(email, pwd);

    if (!user) {
      showToast('‚ùå Identifiants incorrects.', 'error');
      return;
    }

    currentUser = user;
    document.getElementById('loginPage').style.display = 'none';

    if (user.role === 'admin') {
      document.getElementById('adminPage').style.display = 'block';
      renderAdminPanel();
    } else {
      document.getElementById('dashboardPage').style.display = 'block';
      renderDashboard();
    }

    showToast(`‚úÖ Bienvenue ${user.enterprise_name}!`, 'success');
  });

  // ==================== INVITATION FORM ====================
  document.getElementById('invitationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const token = document.getElementById('invitationToken').value;
    const email = document.getElementById('invitationEmail').value;
    const pwd1 = document.getElementById('invitationPassword').value;
    const pwd2 = document.getElementById('invitationPasswordConfirm').value;

    if (pwd1 !== pwd2) {
      showToast('‚ùå Les mots de passe ne correspondent pas.', 'error');
      return;
    }

    if (pwd1.length < 6) {
      showToast('‚ùå Le mot de passe doit avoir au moins 6 caract√®res.', 'error');
      return;
    }

    // Find invitation record
    const invitation = allRecords.find(r => 
      r.record_type === 'invitation' && 
      r.invitation_token === token && 
      r.user_email === email
    );

    if (!invitation) {
      showToast('‚ùå Token d\'invitation invalide ou expir√©.', 'error');
      return;
    }

    if (invitation.invitation_accepted) {
      showToast('‚ùå Cette invitation a d√©j√† √©t√© accept√©e.', 'error');
      return;
    }

    document.getElementById('invitationText').textContent = 'Activation...';
    document.getElementById('invitationSpinner').style.display = 'inline-block';

    // Mark invitation as accepted
    const updateResult = await window.dataSdk.update({
      ...invitation,
      invitation_accepted: true,
      invitation_accepted_at: new Date().toISOString(),
      user_password: pwd1
    });

    if (updateResult.isOk) {
      // Create user record for future logins
      const userResult = await window.dataSdk.create({
        record_type: 'user',
        enterprise_id: invitation.enterprise_id,
        enterprise_name: invitation.enterprise_name,
        user_email: email,
        user_role: 'user',
        user_password: pwd1,
        invitation_accepted: true,
        invitation_accepted_at: new Date().toISOString(),
        created_at: new Date().toISOString(),
        subscription_status: 'active',
        subscription_end_date: invitation.subscription_end_date,
        plan_type: invitation.plan_type,
        title: '', description: '', severity: '', status: '', agent_name: '', location: '', lat: 0, lng: 0, resolved_at: '', category: '', access_token: '', invitation_token: '', payment_status: ''
      });

      if (userResult.isOk) {
        showToast('‚úÖ Invitation accept√©e! Vous pouvez maintenant vous connecter.', 'success');
        document.getElementById('invitationForm').reset();
        document.getElementById('loginTab').click();
        setTimeout(() => {
          document.getElementById('emailInput').value = email;
          document.getElementById('passwordInput').value = pwd1;
        }, 100);
      }
    }

    document.getElementById('invitationText').textContent = '‚úÖ Accepter l\'invitation';
    document.getElementById('invitationSpinner').style.display = 'none';
  });

  document.getElementById('logoutBtn').addEventListener('click', logout);
  document.getElementById('adminLogoutBtn').addEventListener('click', logout);

  // ==================== DATA SDK ====================
  const dataHandler = {
    onDataChanged(data) {
      allRecords = data;
      if (currentUser?.role === 'user') {
        renderDashboard();
      } else if (currentUser?.role === 'admin') {
        renderAdminPanel();
      }
    }
  };

  const res = await window.dataSdk.init(dataHandler);
  if (!res.isOk) console.error('Data SDK init failed');
})();
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd38b2a717d8a3d',t:'MTc3MDk3NzUwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
